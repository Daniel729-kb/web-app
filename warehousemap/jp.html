<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½å†…å€‰åº«é¢ç©å¯è¦–åŒ–ãƒãƒƒãƒ— - å€‰åº«åºŠé¢ç©ã¨è²©å£²å¯èƒ½é¢ç©ã®è¦‹ãˆã‚‹åŒ–</title>
  
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
    <style>
        /* åŸºæœ¬å¤‰æ•°å®šç¾© */
        :root {
            --primary-color: #2193b0;
            --secondary-color: #6dd5ed;
            --background-light: #f8f9fa;
            --background-dark: #1e293b;
            --text-light: #333;
            --text-dark: #e2e8f0;
            --border-light: #ddd;
            --border-dark: #475569;
            --card-light: #fff;
            --card-dark: #334155;
            --hover-light: #f1f5f9;
            --hover-dark: #475569;
        }
        /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .dark-mode-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .upload-area {
            border: 3px dashed var(--border-light);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-light);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--hover-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        .upload-subtext {
            color: #666;
            font-size: 0.95rem;
        }
        #file-input {
            display: none;
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
            text-align: center;
            animation: slideIn 0.3s ease;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            display: none;
            flex-direction: column;
            gap: 20px;
            background: var(--card-light);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .filter-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 250px;
            position: relative;
        }
        .selector-label {
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 600;
        }
        /* ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .multi-select {
            position: relative;
            width: 100%;
        }
        .multi-select-display {
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            background: var(--card-light);
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            position: relative;
        }
        .multi-select-display:hover {
            border-color: var(--primary-color);
        }
        .multi-select-display.open {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 147, 176, 0.1);
        }
        .multi-select-arrow {
            position: absolute;
            right: 15px;
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #666;
        }
        .multi-select-display.open .multi-select-arrow {
            transform: rotate(180deg);
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            width: 100%;
        }
        .selected-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            max-width: 120px;
        }
        .tag-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            opacity: 0.8;
        }
        .tag-remove:hover {
            opacity: 1;
        }
        .placeholder-text {
            color: #999;
            font-style: italic;
        }
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-light);
            border: 2px solid var(--primary-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 320px;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
        }
        .search-container {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-light);
            background: var(--hover-light);
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--card-light);
            color: var(--text-light);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        .search-input:focus {
            border-color: var(--primary-color);
        }
        .search-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 14px;
        }
        .search-clear {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-clear:hover {
            background: var(--border-light);
        }
        .select-all-container {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-light);
            background: var(--hover-light);
            flex-shrink: 0;
        }
        .options-container {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
        }
        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }
        .multi-select-option:hover {
            background: var(--hover-light);
        }
        .multi-select-option.hidden {
            display: none;
        }
        .multi-select-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        .option-text {
            flex: 1;
        }
        .option-text .highlight {
            background: #ffeb3b;
            color: #333;
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 2px;
        }
        .option-count {
            color: #666;
            font-size: 0.85rem;
        }
        .no-results {
            padding: 20px 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }
        /* æ©Ÿèƒ½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .feature-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: var(--hover-light);
            border-radius: 10px;
            margin-top: 10px;
        }
        .feature-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .feature-filter input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        /* å‡¡ä¾‹ */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding: 15px;
            background: var(--hover-light);
            border-radius: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        /* çµ±è¨ˆ */
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: space-around;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        .stat-item {
            text-align: center;
            font-size: 0.95rem;
        }
        .stat-item strong {
            display: block;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .stat-item span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
        }
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 600px;
        }
        /* ãƒãƒƒãƒ— */
        #map {
            flex: 2;
            min-height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: none;
            position: relative;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 10px;
            font-weight: 600;
            color: var(--primary-color);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        /* å€‰åº«ãƒªã‚¹ãƒˆ */
        .warehouse-list {
            flex: 1;
            background: var(--card-light);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            display: none;
            overflow: hidden;
            flex-direction: column;
            max-height: 800px;
            min-height: 600px;
        }
        .warehouse-list h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
            flex-shrink: 0;
        }
        .list-info {
            background: var(--hover-light);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
            flex-shrink: 0;
            border-left: 4px solid var(--primary-color);
        }
        .list-info .map-range-info {
            color: var(--primary-color);
            font-weight: 600;
        }
        #warehouse-items {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        #warehouse-items::-webkit-scrollbar {
            width: 8px;
        }
        #warehouse-items::-webkit-scrollbar-track {
            background: var(--hover-light);
            border-radius: 4px;
        }
        #warehouse-items::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
            opacity: 0.7;
        }
        #warehouse-items::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        .warehouse-item {
            background: var(--hover-light);
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .warehouse-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        .warehouse-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        .warehouse-details {
            color: #666;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        .warehouse-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        .warehouse-stats span {
            display: flex;
            justify-content: space-between;
        }
        .availability-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .availability-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .warehouse-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 320px;
        }
        .popup-header {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        .popup-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .popup-detail span:first-child {
            color: #666;
            min-width: 80px;
        }
        .popup-detail span:last-child {
            color: var(--primary-color);
            font-weight: 600;
        }
        .chart-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        body.dark-mode .upload-area {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        body.dark-mode .upload-area:hover,
        body.dark-mode .upload-area.dragover {
            background: var(--hover-dark);
        }
        body.dark-mode .upload-subtext {
            color: #94a3b8;
        }
        body.dark-mode .encoding-selector {
            background: var(--hover-dark) !important;
        }
        body.dark-mode .encoding-selector label {
            color: var(--text-dark) !important;
        }
        body.dark-mode .encoding-selector select {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }
        body.dark-mode .encoding-selector button {
            background: var(--primary-color);
        }
        body.dark-mode .encoding-selector button:hover {
            background: var(--secondary-color);
        }
        body.dark-mode .encoding-selector div {
            color: #94a3b8 !important;
        }
        body.dark-mode .controls {
            background: var(--card-dark);
        }
        body.dark-mode .selector-label {
            color: var(--text-dark);
        }
        body.dark-mode .multi-select-display {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }
        body.dark-mode .multi-select-dropdown {
            background: var(--card-dark);
            border-color: var(--primary-color);
        }
        body.dark-mode .search-container {
            background: var(--hover-dark);
            border-bottom-color: var(--border-dark);
        }
        body.dark-mode .search-input {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }
        body.dark-mode .search-clear:hover {
            background: var(--border-dark);
        }
        body.dark-mode .select-all-container {
            background: var(--hover-dark);
            border-bottom-color: var(--border-dark);
        }
        body.dark-mode .multi-select-option:hover {
            background: var(--hover-dark);
        }
        body.dark-mode .option-text .highlight {
            background: #ffc107;
            color: #000;
        }
        body.dark-mode .option-count {
            color: #94a3b8;
        }
        body.dark-mode .feature-filters {
            background: var(--hover-dark);
        }
        body.dark-mode .legend {
            background: var(--hover-dark);
        }
        body.dark-mode .stats {
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }
        body.dark-mode .stat-item span {
            color: var(--text-dark);
        }
        body.dark-mode .warehouse-list {
            background: var(--card-dark);
        }
        body.dark-mode .warehouse-list h3 {
            border-bottom-color: var(--border-dark);
        }
        body.dark-mode .list-info {
            background: var(--hover-dark);
        }
        body.dark-mode #warehouse-items::-webkit-scrollbar-track {
            background: var(--hover-dark);
        }
        body.dark-mode .warehouse-item {
            background: var(--hover-dark);
        }
        body.dark-mode .warehouse-details {
            color: #94a3b8;
        }
        body.dark-mode .popup-detail span:first-child {
            color: #94a3b8;
        }
        body.dark-mode .availability-bar {
            background: #4a5568;
        }
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
          
            .warehouse-list {
                max-height: 400px;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
          
            .header h1 {
                font-size: 2rem;
            }
          
            .filter-section {
                flex-direction: column;
                gap: 15px;
            }
          
            .selector-group {
                min-width: auto;
            }
          
            .legend {
                justify-content: center;
                gap: 15px;
            }
          
            .stats {
                flex-direction: column;
                gap: 15px;
            }
          
            #map {
                min-height: 400px;
            }
          
            .warehouse-list {
                max-height: 300px;
            }
        }
        @media (max-width: 480px) {
            .header {
                padding: 20px;
            }
          
            .header h1 {
                font-size: 1.7rem;
            }
          
            .upload-area {
                padding: 30px 20px;
            }
          
            .controls {
                padding: 20px;
            }
          
            .legend {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="header-controls">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
                    <span class="dark-mode-icon">ğŸŒ™</span>
                </button>
            </div>
          
            <h1>æ—¥æœ¬å›½å†…å€‰åº«é¢ç©å¯è¦–åŒ–ãƒãƒƒãƒ—</h1>
            <p>å€‰åº«åºŠé¢ç©ã¨è²©å£²å¯èƒ½é¢ç©ã®å¯è¦–åŒ–</p>
        </div>
        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">ğŸ“Š</div>
                <div class="upload-text">æ—¥æœ¬å›½å†…å€‰åº«ãƒ‡ãƒ¼ã‚¿CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                <div class="upload-subtext">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>
                <small>å¯¾å¿œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: æ–½è¨­åç§°, éƒ½é“åºœçœŒ, å¸‚åŒºç”ºæ‘, å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰, è²©å£²å¯èƒ½é¢ç©(åª), ç·¯åº¦, çµŒåº¦</small></div>
            </div>
            <input type="file" id="file-input" accept=".csv" />
          
            <!-- æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é¸æŠ -->
            <div class="encoding-selector" style="margin-top: 15px; text-align: center; background: var(--hover-light); padding: 15px; border-radius: 10px; transition: background-color 0.3s ease;">
                <label style="margin-right: 10px; font-weight: 600; color: var(--text-light);">ğŸ“ æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°:</label>
                <select id="encoding-select" style="padding: 8px 12px; border: 2px solid var(--border-light); border-radius: 6px; background: var(--card-light); color: var(--text-light); font-size: 0.9rem; margin-right: 10px;">
                    <option value="UTF-8">UTF-8</option>
                    <option value="Shift_JIS" selected>Shift_JIS (æ—¥æœ¬èªæ¨™æº–)</option>
                    <option value="EUC-JP">EUC-JP</option>
                    <option value="ISO-2022-JP">ISO-2022-JP</option>
                </select>
                <button onclick="reprocessFile()" style="padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease;">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                <div style="margin-top: 8px; font-size: 0.8rem; color: #666; transition: color 0.3s ease;">ğŸ’¡ æ–‡å­—åŒ–ã‘ã™ã‚‹å ´åˆã¯ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤‰æ›´ã—ã¦ã€Œå†èª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
            </div>
        </div>
        <div class="controls" id="controls">
            <div class="filter-section">
                <div class="selector-group">
                    <label class="selector-label"><strong>ğŸ—¾ åœ°åŸŸé¸æŠ:</strong></label>
                    <div class="multi-select" id="region-multiselect">
                        <div class="multi-select-display" onclick="toggleDropdown('region')">
                            <div class="selected-tags" id="region-tags">
                                <span class="placeholder-text">åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <span class="multi-select-arrow">â–¼</span>
                        </div>
                        <div class="multi-select-dropdown" id="region-dropdown" style="display: none;">
                            <div class="search-container">
                                <input type="text" class="search-input" id="region-search" placeholder="åœ°åŸŸåã‚’æ¤œç´¢..." />
                                <span class="search-icon" id="region-search-icon">ğŸ”</span>
                                <button class="search-clear" id="region-search-clear" style="display: none;">&times;</button>
                            </div>
                            <div class="select-all-container">
                                <label>
                                    <input type="checkbox" id="region-select-all" onchange="toggleSelectAll('region')">
                                    <strong>ã™ã¹ã¦é¸æŠ/è§£é™¤</strong>
                                </label>
                            </div>
                            <div class="options-container">
                                <div id="region-options"></div>
                                <div class="no-results" id="region-no-results" style="display: none;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selector-group">
                    <label class="selector-label"><strong>ğŸ¢ éƒ½é“åºœçœŒé¸æŠ:</strong></label>
                    <div class="multi-select" id="prefecture-multiselect">
                        <div class="multi-select-display" onclick="toggleDropdown('prefecture')">
                            <div class="selected-tags" id="prefecture-tags">
                                <span class="placeholder-text">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <span class="multi-select-arrow">â–¼</span>
                        </div>
                        <div class="multi-select-dropdown" id="prefecture-dropdown" style="display: none;">
                            <div class="search-container">
                                <input type="text" class="search-input" id="prefecture-search" placeholder="éƒ½é“åºœçœŒåã‚’æ¤œç´¢..." />
                                <span class="search-icon" id="prefecture-search-icon">ğŸ”</span>
                                <button class="search-clear" id="prefecture-search-clear" style="display: none;">&times;</button>
                            </div>
                            <div class="select-all-container">
                                <label>
                                    <input type="checkbox" id="prefecture-select-all" onchange="toggleSelectAll('prefecture')">
                                    <strong>ã™ã¹ã¦é¸æŠ/è§£é™¤</strong>
                                </label>
                            </div>
                            <div class="options-container">
                                <div id="prefecture-options"></div>
                                <div class="no-results" id="prefecture-no-results" style="display: none;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selector-group">
                    <label class="selector-label"><strong>ğŸ˜ï¸ å¸‚åŒºç”ºæ‘é¸æŠ:</strong></label>
                    <div class="multi-select" id="city-multiselect">
                        <div class="multi-select-display" onclick="toggleDropdown('city')">
                            <div class="selected-tags" id="city-tags">
                                <span class="placeholder-text">å¸‚åŒºç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <span class="multi-select-arrow">â–¼</span>
                        </div>
                        <div class="multi-select-dropdown" id="city-dropdown" style="display: none;">
                            <div class="search-container">
                                <input type="text" class="search-input" id="city-search" placeholder="å¸‚åŒºç”ºæ‘åã‚’æ¤œç´¢..." />
                                <span class="search-icon" id="city-search-icon">ğŸ”</span>
                                <button class="search-clear" id="city-search-clear" style="display: none;">&times;</button>
                            </div>
                            <div class="select-all-container">
                                <label>
                                    <input type="checkbox" id="city-select-all" onchange="toggleSelectAll('city')">
                                    <strong>ã™ã¹ã¦é¸æŠ/è§£é™¤</strong>
                                </label>
                            </div>
                            <div class="options-container">
                                <div id="city-options"></div>
                                <div class="no-results" id="city-no-results" style="display: none;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selector-group">
                    <label class="selector-label"><strong>ğŸ  è‡ªç¤¾æ‰€æœ‰/è³ƒå€Ÿ:</strong></label>
                    <div class="multi-select" id="ownership-multiselect">
                        <div class="multi-select-display" onclick="toggleDropdown('ownership')">
                            <div class="selected-tags" id="ownership-tags">
                                <span class="placeholder-text">è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <span class="multi-select-arrow">â–¼</span>
                        </div>
                        <div class="multi-select-dropdown" id="ownership-dropdown" style="display: none;">
                            <div class="search-container">
                                <input type="text" class="search-input" id="ownership-search" placeholder="è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹ã‚’æ¤œç´¢..." />
                                <span class="search-icon" id="ownership-search-icon">ğŸ”</span>
                                <button class="search-clear" id="ownership-search-clear" style="display: none;">&times;</button>
                            </div>
                            <div class="select-all-container">
                                <label>
                                    <input type="checkbox" id="ownership-select-all" onchange="toggleSelectAll('ownership')">
                                    <strong>ã™ã¹ã¦é¸æŠ/è§£é™¤</strong>
                                </label>
                            </div>
                            <div class="options-container">
                                <div id="ownership-options"></div>
                                <div class="no-results" id="ownership-no-results" style="display: none;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="feature-filters">
                <div class="feature-filter">
                    <input type="checkbox" id="filter-bonded" onchange="filterByFeatures()">
                    <label for="filter-bonded">ğŸ­ ä¿ç¨å€‰åº«ã®ã¿</label>
                </div>
                <div class="feature-filter">
                    <input type="checkbox" id="filter-temp-controlled" onchange="filterByFeatures()">
                    <label for="filter-temp-controlled">ğŸŒ¡ï¸ å®šæ¸©å€‰åº«ã®ã¿</label>
                </div>
                <div class="feature-filter">
                    <input type="checkbox" id="filter-refrigerated" onchange="filterByFeatures()">
                    <label for="filter-refrigerated">â„ï¸ å†·è”µãƒ»å†·å‡å€‰åº«ã®ã¿</label>
                </div>
                <div class="feature-filter">
                    <input type="checkbox" id="filter-licensed" onchange="filterByFeatures()">
                    <label for="filter-licensed">ğŸ“‹ å–¶æ¥­å€‰åº«ç™»éŒ²ã®ã¿</label>
                </div>
                <div class="feature-filter">
                    <input type="checkbox" id="filter-international" onchange="filterByFeatures()">
                    <label for="filter-international">ğŸŒ å›½éš›è¼¸é€å¯¾å¿œã®ã¿</label>
                </div>
                <div class="feature-filter">
                    <input type="checkbox" id="filter-hazardous" onchange="filterByFeatures()">
                    <label for="filter-hazardous">âš ï¸ å±é™ºå“å€‰åº«ã®ã¿</label>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>ç©ºããŒå¤šã„ï¼ˆç¨¼åƒç‡20%æœªæº€ï¼‰</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #f97316;"></div><span>ã‚„ã‚„ç©ºãï¼ˆç¨¼åƒç‡20-40%ï¼‰</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #eab308;"></div><span>æ™®é€šï¼ˆç¨¼åƒç‡40-60%ï¼‰</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #84cc16;"></div><span>é †èª¿ï¼ˆç¨¼åƒç‡60-80%ï¼‰</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div><span>ã»ã¼æº€æ¯ï¼ˆç¨¼åƒç‡80%ä»¥ä¸Šï¼‰</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #fff; border: 2px solid #888; border-radius: 50%;"></div><span>GPSåº§æ¨™</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #fff; border: 3px solid #ffd43b; border-radius: 50%;"></div><span>éƒ½å¸‚åº§æ¨™</span></div>
            </div>
          
            <div class="stats">
                <div class="stat-item"><strong>å€‰åº«æ•°:</strong> <span id="warehouse-count">-</span></div>
                <div class="stat-item"><strong>ç·åºŠé¢ç©:</strong> <span id="total-area">-</span> åª</div>
                <div class="stat-item"><strong>è²©å£²å¯èƒ½:</strong> <span id="available-area">-</span> åª</div>
                <div class="stat-item"><strong>å¹³å‡ç¨¼åƒç‡:</strong> <span id="avg-usage">-</span>%</div>
            </div>
        </div>
        <div class="main-content">
            <div id="map">
                <div class="loading">åœ°å›³ã¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="warehouse-list" id="warehouse-list">
                <h3>ğŸ“¦ ç©ºããŒå¤šã„é †ãƒªã‚¹ãƒˆ</h3>
                <div class="list-info" id="list-info">
                    <div class="map-range-info">ãƒãƒƒãƒ—ã®è¡¨ç¤ºç¯„å›²å†…: <span id="visible-count">-</span>ä»¶</div>
                    <div style="font-size: 0.85rem; margin-top: 5px;">ğŸ” ãƒãƒƒãƒ—ã‚’ç§»å‹•ã™ã‚‹ã¨ãƒªã‚¹ãƒˆãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</div>
                </div>
                <div id="warehouse-items"></div>
            </div>
        </div>
    </div>
   <script>
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        let isDarkMode = false;
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            updateDarkModeIcon();
        }
        function updateDarkModeIcon() {
            const icon = document.querySelector('.dark-mode-icon');
            if (icon) {
                icon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }
        function initializeDarkMode() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰
            document.body.classList.remove('dark-mode');
            isDarkMode = false;
            updateDarkModeIcon();
        }
        // æ—¢å­˜ã®JavaScriptæ©Ÿèƒ½ï¼ˆå®Œå…¨ä¿æŒï¼‰
        let map;
        let warehouseData = [];
        let allWarehouseData = [];
        let warehouseMarkers = [];
        let visibleWarehouseData = []; // ãƒãƒƒãƒ—è¡¨ç¤ºç¯„å›²å†…ã®å€‰åº«ãƒ‡ãƒ¼ã‚¿
        let selectedRegions = [];
        let selectedPrefectures = [];
        let selectedCities = [];
        let selectedOwnerships = [];
        // æ—¥æœ¬ã®ä¸»è¦éƒ½å¸‚åº§æ¨™ãƒ‡ãƒ¼ã‚¿
        const japanCityCoordinates = {
            // åŒ—æµ·é“
            'æœ­å¹Œ': [43.0642, 141.3469], 'æœ­å¹Œå¸‚': [43.0642, 141.3469],
            'å‡½é¤¨': [41.7687, 140.7290], 'å‡½é¤¨å¸‚': [41.7687, 140.7290],
            'æ—­å·': [43.7711, 142.3649], 'æ—­å·å¸‚': [43.7711, 142.3649],
            'é‡§è·¯': [42.9849, 144.3818], 'é‡§è·¯å¸‚': [42.9849, 144.3818],
            'å¸¯åºƒ': [42.9236, 143.1947], 'å¸¯åºƒå¸‚': [42.9236, 143.1947],
          
            // æ±åŒ—
            'é’æ£®': [40.8244, 140.7400], 'é’æ£®å¸‚': [40.8244, 140.7400],
            'ç››å²¡': [39.7036, 141.1527], 'ç››å²¡å¸‚': [39.7036, 141.1527],
            'ä»™å°': [38.2682, 140.8694], 'ä»™å°å¸‚': [38.2682, 140.8694],
            'ç§‹ç”°': [39.7186, 140.1024], 'ç§‹ç”°å¸‚': [39.7186, 140.1024],
            'å±±å½¢': [38.2404, 140.3633], 'å±±å½¢å¸‚': [38.2404, 140.3633],
            'ç¦å³¶': [37.7608, 140.4747], 'ç¦å³¶å¸‚': [37.7608, 140.4747],
            'ã„ã‚ã': [37.0481, 140.8878], 'ã„ã‚ãå¸‚': [37.0481, 140.8878],
          
            // é–¢æ±
            'æ±äº¬': [35.6762, 139.6503], 'æ±äº¬éƒ½': [35.6762, 139.6503],
            'æ¨ªæµœ': [35.4437, 139.6380], 'æ¨ªæµœå¸‚': [35.4437, 139.6380],
            'ã•ã„ãŸã¾': [35.8617, 139.6455], 'ã•ã„ãŸã¾å¸‚': [35.8617, 139.6455],
            'åƒè‘‰': [35.6074, 140.1065], 'åƒè‘‰å¸‚': [35.6074, 140.1065],
            'æ°´æˆ¸': [36.3418, 140.4468], 'æ°´æˆ¸å¸‚': [36.3418, 140.4468],
            'å®‡éƒ½å®®': [36.5658, 139.8836], 'å®‡éƒ½å®®å¸‚': [36.5658, 139.8836],
            'å‰æ©‹': [36.3911, 139.0607], 'å‰æ©‹å¸‚': [36.3911, 139.0607],
            'å·å´': [35.5308, 139.7029], 'å·å´å¸‚': [35.5308, 139.7029],
            'èˆ¹æ©‹': [35.6955, 139.9830], 'èˆ¹æ©‹å¸‚': [35.6955, 139.9830],
            'æŸ': [35.8647, 139.9669], 'æŸå¸‚': [35.8647, 139.9669],
            'å…«ç‹å­': [35.6558, 139.3439], 'å…«ç‹å­å¸‚': [35.6558, 139.3439],
            'ç›¸æ¨¡åŸ': [35.5722, 139.3694], 'ç›¸æ¨¡åŸå¸‚': [35.5722, 139.3694],
            'é«˜æ§»': [34.8485, 135.6168], 'é«˜æ§»å¸‚': [34.8485, 135.6168],
          
            // ä¸­éƒ¨
            'æ–°æ½Ÿ': [37.9022, 139.0239], 'æ–°æ½Ÿå¸‚': [37.9022, 139.0239],
            'å¯Œå±±': [36.6959, 137.2139], 'å¯Œå±±å¸‚': [36.6959, 137.2139],
            'é‡‘æ²¢': [36.5944, 136.6256], 'é‡‘æ²¢å¸‚': [36.5944, 136.6256],
            'ç¦äº•': [36.0653, 136.2207], 'ç¦äº•å¸‚': [36.0653, 136.2207],
            'ç”²åºœ': [35.6642, 138.5681], 'ç”²åºœå¸‚': [35.6642, 138.5681],
            'é•·é‡': [36.6483, 138.1943], 'é•·é‡å¸‚': [36.6483, 138.1943],
            'å²é˜œ': [35.3912, 136.7223], 'å²é˜œå¸‚': [35.3912, 136.7223],
            'é™å²¡': [34.9756, 138.3831], 'é™å²¡å¸‚': [34.9756, 138.3831],
            'æµœæ¾': [34.7108, 137.7261], 'æµœæ¾å¸‚': [34.7108, 137.7261],
            'åå¤å±‹': [35.1815, 136.9066], 'åå¤å±‹å¸‚': [35.1815, 136.9066],
            'è±Šç”°': [35.0833, 137.1500], 'è±Šç”°å¸‚': [35.0833, 137.1500],
            'å²¡å´': [34.9550, 137.1744], 'å²¡å´å¸‚': [34.9550, 137.1744],
          
            // é–¢è¥¿
            'æ´¥': [34.7303, 136.5086], 'æ´¥å¸‚': [34.7303, 136.5086],
            'å¤§æ´¥': [35.0045, 135.8684], 'å¤§æ´¥å¸‚': [35.0045, 135.8684],
            'äº¬éƒ½': [35.0116, 135.7681], 'äº¬éƒ½å¸‚': [35.0116, 135.7681],
            'å¤§é˜ª': [34.6937, 135.5023], 'å¤§é˜ªå¸‚': [34.6937, 135.5023],
            'ç¥æˆ¸': [34.6901, 135.1956], 'ç¥æˆ¸å¸‚': [34.6901, 135.1956],
            'å¥ˆè‰¯': [34.6851, 135.8048], 'å¥ˆè‰¯å¸‚': [34.6851, 135.8048],
            'å’Œæ­Œå±±': [34.2261, 135.1675], 'å’Œæ­Œå±±å¸‚': [34.2261, 135.1675],
            'å º': [34.5731, 135.4826], 'å ºå¸‚': [34.5731, 135.4826],
            'æ±å¤§é˜ª': [34.6780, 135.6006], 'æ±å¤§é˜ªå¸‚': [34.6780, 135.6006],
            'å§«è·¯': [34.8161, 134.6851], 'å§«è·¯å¸‚': [34.8161, 134.6851],
          
            // ä¸­å›½
            'é³¥å–': [35.5037, 134.2380], 'é³¥å–å¸‚': [35.5037, 134.2380],
            'æ¾æ±Ÿ': [35.4722, 133.0506], 'æ¾æ±Ÿå¸‚': [35.4722, 133.0506],
            'å²¡å±±': [34.6617, 133.9341], 'å²¡å±±å¸‚': [34.6617, 133.9341],
            'åºƒå³¶': [34.3853, 132.4553], 'åºƒå³¶å¸‚': [34.3853, 132.4553],
            'å±±å£': [34.1858, 131.4706], 'å±±å£å¸‚': [34.1858, 131.4706],
            'ç¦å±±': [34.4895, 133.3625], 'ç¦å±±å¸‚': [34.4895, 133.3625],
            'å€‰æ•·': [34.5839, 133.7726], 'å€‰æ•·å¸‚': [34.5839, 133.7726],
          
            // å››å›½
            'å¾³å³¶': [34.0658, 134.5594], 'å¾³å³¶å¸‚': [34.0658, 134.5594],
            'é«˜æ¾': [34.3401, 134.0431], 'é«˜æ¾å¸‚': [34.3401, 134.0431],
            'æ¾å±±': [33.8416, 132.7658], 'æ¾å±±å¸‚': [33.8416, 132.7658],
            'é«˜çŸ¥': [33.5597, 133.5311], 'é«˜çŸ¥å¸‚': [33.5597, 133.5311],
          
            // ä¹å·
            'ç¦å²¡': [33.5904, 130.4017], 'ç¦å²¡å¸‚': [33.5904, 130.4017],
            'åŒ—ä¹å·': [33.8839, 130.8751], 'åŒ—ä¹å·å¸‚': [33.8839, 130.8751],
            'ä½è³€': [33.2494, 130.2989], 'ä½è³€å¸‚': [33.2494, 130.2989],
            'é•·å´': [32.7503, 129.8779], 'é•·å´å¸‚': [32.7503, 129.8779],
            'ç†Šæœ¬': [32.7898, 130.7417], 'ç†Šæœ¬å¸‚': [32.7898, 130.7417],
            'å¤§åˆ†': [33.2382, 131.6126], 'å¤§åˆ†å¸‚': [33.2382, 131.6126],
            'å®®å´': [31.9077, 131.4202], 'å®®å´å¸‚': [31.9077, 131.4202],
            'é¹¿å…å³¶': [31.5966, 130.5571], 'é¹¿å…å³¶å¸‚': [31.5966, 130.5571],
            'ä¹…ç•™ç±³': [33.3197, 130.5089], 'ä¹…ç•™ç±³å¸‚': [33.3197, 130.5089],
          
            // æ²–ç¸„
            'é‚£è¦‡': [26.2124, 127.6792], 'é‚£è¦‡å¸‚': [26.2124, 127.6792]
        };
        // æ—¥æœ¬ã®åœ°åŸŸåŒºåˆ†
        const japanRegions = {
            'åŒ—æµ·é“': ['åŒ—æµ·é“'],
            'æ±åŒ—': ['é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ'],
            'é–¢æ±': ['èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ', 'åŸ¼ç‰çœŒ', 'åƒè‘‰çœŒ', 'æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ'],
            'ä¸­éƒ¨': ['æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ', 'å²é˜œçœŒ', 'é™å²¡çœŒ', 'æ„›çŸ¥çœŒ'],
            'é–¢è¥¿': ['ä¸‰é‡çœŒ', 'æ»‹è³€çœŒ', 'äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'å…µåº«çœŒ', 'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ'],
            'ä¸­å›½': ['é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ'],
            'å››å›½': ['å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ'],
            'ä¹å·': ['ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ', 'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ'],
            'æ²–ç¸„': ['æ²–ç¸„çœŒ']
        };
        // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const display = document.querySelector(`#${type}-multiselect .multi-select-display`);
          
            // ä»–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
            ['region', 'prefecture', 'city', 'ownership'].forEach(t => {
                if (t !== type) {
                    document.getElementById(`${t}-dropdown`).style.display = 'none';
                    document.querySelector(`#${t}-multiselect .multi-select-display`).classList.remove('open');
                }
            });
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            display.classList.toggle('open', !isOpen);
          
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹ã„ãŸæ™‚ã«æ¤œç´¢å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            if (!isOpen) {
                setTimeout(() => {
                    const searchInput = document.getElementById(`${type}-search`);
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
            }
        }
        // æ¤œç´¢æ©Ÿèƒ½
        function setupSearchFunctionality() {
            ['region', 'prefecture', 'city', 'ownership'].forEach(type => {
                const searchInput = document.getElementById(`${type}-search`);
                const searchIcon = document.getElementById(`${type}-search-icon`);
                const searchClear = document.getElementById(`${type}-search-clear`);
              
                if (!searchInput) return;
              
                // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase().trim();
                    filterOptions(type, query);
                  
                    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
                    if (query) {
                        searchIcon.style.display = 'none';
                        searchClear.style.display = 'flex';
                    } else {
                        searchIcon.style.display = 'block';
                        searchClear.style.display = 'none';
                    }
                });
              
                // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
                if (searchClear) {
                    searchClear.addEventListener('click', function() {
                        searchInput.value = '';
                        filterOptions(type, '');
                        searchIcon.style.display = 'block';
                        searchClear.style.display = 'none';
                        searchInput.focus();
                    });
                }
              
                // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢é˜²æ­¢
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });
        }
        function filterOptions(type, query) {
            const optionsContainer = document.getElementById(`${type}-options`);
            const noResults = document.getElementById(`${type}-no-results`);
            const options = optionsContainer.querySelectorAll('.multi-select-option');
          
            let visibleCount = 0;
          
            options.forEach(option => {
                const optionText = option.querySelector('.option-text');
                const originalText = optionText.dataset.originalText || optionText.textContent;
              
                // åˆå›æ™‚ã¯å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
                if (!optionText.dataset.originalText) {
                    optionText.dataset.originalText = originalText;
                }
              
                if (!query) {
                    // æ¤œç´¢ã‚¯ã‚¨ãƒªãŒãªã„å ´åˆã¯å…¨ã¦è¡¨ç¤º
                    option.classList.remove('hidden');
                    optionText.innerHTML = originalText;
                    visibleCount++;
                } else {
                    // æ¤œç´¢ã‚¯ã‚¨ãƒªãŒã‚ã‚‹å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    if (originalText.toLowerCase().includes(query)) {
                        option.classList.remove('hidden');
                        optionText.innerHTML = highlightMatch(originalText, query);
                        visibleCount++;
                    } else {
                        option.classList.add('hidden');
                    }
                }
            });
          
            // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            if (visibleCount === 0 && query) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
          
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateSelectAllState(type);
        }
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }
        function updateSelectAllState(type) {
            const selectAllCheckbox = document.getElementById(`${type}-select-all`);
            const visibleOptions = document.querySelectorAll(`#${type}-options .multi-select-option:not(.hidden) input[type="checkbox"]`);
            const checkedVisibleOptions = document.querySelectorAll(`#${type}-options .multi-select-option:not(.hidden) input[type="checkbox"]:checked`);
          
            if (visibleOptions.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedVisibleOptions.length === visibleOptions.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else if (checkedVisibleOptions.length > 0) {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            } else {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            }
        }
        function toggleSelectAll(type) {
            const selectAllCheckbox = document.getElementById(`${type}-select-all`);
            const visibleOptions = document.querySelectorAll(`#${type}-options .multi-select-option:not(.hidden) input[type="checkbox"]`);
          
            visibleOptions.forEach(option => {
                option.checked = selectAllCheckbox.checked;
            });
          
            updateSelectedItems(type);
        }
        function updateSelectedItems(type) {
            const checkedOptions = document.querySelectorAll(`#${type}-options input[type="checkbox"]:checked`);
            const selectedValues = Array.from(checkedOptions).map(option => option.value);
          
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            if (type === 'region') {
                selectedRegions = selectedValues;
                selectedPrefectures = [];
                selectedCities = [];
                selectedOwnerships = [];
                populatePrefectureSelector();
                populateCitySelector();
                populateOwnershipSelector();
                updateTagsDisplay('prefecture', []);
                updateTagsDisplay('city', []);
                updateTagsDisplay('ownership', []);
            } else if (type === 'prefecture') {
                selectedCities = [];
                selectedOwnerships = [];
                populateCitySelector();
                populateOwnershipSelector();
                updateTagsDisplay('city', []);
                updateTagsDisplay('ownership', []);
            } else if (type === 'city') {
                selectedOwnerships = [];
                populateOwnershipSelector();
                updateTagsDisplay('ownership', []);
            } else if (type === 'ownership') {
                selectedOwnerships = selectedValues;
            }
          
            updateTagsDisplay(type, selectedValues);
          
            filterAndDisplayData();
        }
        function updateTagsDisplay(type, selectedValues) {
            const tagsContainer = document.getElementById(`${type}-tags`);
          
            if (selectedValues.length === 0) {
                const placeholderTexts = {
                    'region': 'åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„',
                    'prefecture': 'éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„',
                    'city': 'å¸‚åŒºç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„',
                    'ownership': 'è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹ã‚’é¸æŠã—ã¦ãã ã•ã„'
                };
                tagsContainer.innerHTML = `<span class="placeholder-text">${placeholderTexts[type]}</span>`;
                return;
            }
          
            tagsContainer.innerHTML = '';
            selectedValues.forEach(value => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
              
                // ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
                const optionElement = document.querySelector(`#${type}-options input[value="${value}"]`).parentNode;
                const optionText = optionElement.textContent.trim();
              
                tag.innerHTML = `
                    <span class="tag-text" title="${optionText}">${value}</span>
                    <span class="tag-remove" onclick="removeTag('${type}', '${value}')">&times;</span>
                `;
                tagsContainer.appendChild(tag);
            });
        }
        function removeTag(type, value) {
            const checkbox = document.querySelector(`#${type}-options input[value="${value}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            updateSelectedItems(type);
        }
        // æ©Ÿèƒ½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByFeatures() {
            filterAndDisplayData();
        }
        // å®Ÿéš›ã®CSVãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åŸºã¥ãåº§æ¨™å–å¾—
        function getWarehouseCoordinates(warehouse, index = 0) {
            // ç·¯åº¦ãƒ»çµŒåº¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä½¿ç”¨
            const latitude = parseFloat(warehouse['ç·¯åº¦']) || 0;
            const longitude = parseFloat(warehouse['çµŒåº¦']) || 0;
          
            if (latitude && longitude && latitude !== 0 && longitude !== 0) {
                return [latitude, longitude];
            }
          
            // å¸‚åŒºç”ºæ‘ã‹ã‚‰åº§æ¨™ã‚’æ¤œç´¢
            const cityName = warehouse['å¸‚åŒºç”ºæ‘'] ? warehouse['å¸‚åŒºç”ºæ‘'].toLowerCase().trim() : '';
          
            const coords = japanCityCoordinates[cityName];
            if (coords) {
                // åŒã˜éƒ½å¸‚å†…ã§ã®ä½ç½®ã®ã°ã‚‰ã¤ãã‚’è¿½åŠ 
                const offsetLat = (Math.random() - 0.5) * 0.02;
                const offsetLng = (Math.random() - 0.5) * 0.02;
                return [coords[0] + offsetLat, coords[1] + offsetLng];
            }
          
            console.warn(`éƒ½å¸‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${cityName} (å€‰åº«: ${warehouse['æ–½è¨­åç§°'] || 'Unknown'})`);
            // æ—¥æœ¬ã®ä¸­å¿ƒä»˜è¿‘ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ã¨ã—ã¦è¿”ã™
            return [36.2048, 138.2529];
        }
        function initMap() {
            if (map) map.remove();
            // æ—¥æœ¬å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
            map = L.map('map').setView([36.2048, 138.2529], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            // ãƒãƒƒãƒ—ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            map.on('moveend zoomend', function() {
                updateVisibleWarehouses();
            });
        }
        function createWarehouseChart(warehouse) {
            // å®Ÿéš›ã®CSVãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿å–å¾—
            const totalArea = parseFloat(warehouse['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0;
            const availableArea = parseFloat(warehouse['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
          
            const canvas = document.createElement('canvas');
            canvas.width = 180; canvas.height = 100;
            const ctx = canvas.getContext('2d');
            const barWidth = 40, barSpacing = 20, chartHeight = 60, chartTop = 20;
            const maxValue = Math.max(totalArea, 1);
            const totalHeight = (totalArea / maxValue) * chartHeight;
            const availableHeight = (availableArea / maxValue) * chartHeight;
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®èƒŒæ™¯è‰²
            const bgColor = isDarkMode ? '#1e293b' : '#f8f9fa';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          
            ctx.fillStyle = '#2193b0'; ctx.fillRect(30, chartTop + chartHeight - totalHeight, barWidth, totalHeight);
            ctx.fillStyle = '#6dd5ed'; ctx.fillRect(30 + barWidth + barSpacing, chartTop + chartHeight - availableHeight, barWidth, availableHeight);
          
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®ãƒ†ã‚­ã‚¹ãƒˆè‰²
            const textColor = isDarkMode ? '#e2e8f0' : '#333';
            ctx.fillStyle = textColor;
            ctx.font = '10px Arial'; ctx.textAlign = 'center';
            ctx.fillText('åºŠé¢ç©', 50, chartTop + chartHeight + 15);
            ctx.fillText('è²©å£²å¯èƒ½', 110, chartTop + chartHeight + 15);
            ctx.font = '8px Arial';
            ctx.fillText(`${totalArea.toLocaleString()}`, 50, chartTop + chartHeight + 25);
            ctx.fillText(`${availableArea.toLocaleString()}`, 110, chartTop + chartHeight + 25);
            return canvas;
        }
        function displayWarehouses() {
            warehouseMarkers.forEach(marker => map.removeLayer(marker));
            warehouseMarkers = [];
            warehouseData.forEach((warehouse, index) => {
                const [lat, lng] = getWarehouseCoordinates(warehouse, index);
                const totalArea = parseFloat(warehouse['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0;
                const availableArea = parseFloat(warehouse['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
              
                const latitude = parseFloat(warehouse['ç·¯åº¦']) || 0;
                const longitude = parseFloat(warehouse['çµŒåº¦']) || 0;
                const isEstimated = !latitude || !longitude || latitude === 0 || longitude === 0;
              
                const iconSize = Math.max(8, Math.min(25, Math.sqrt(totalArea) / 12));
                const usageRate = totalArea > 0 ? (totalArea - availableArea) / totalArea : 0;
                let fillColor;
                if (usageRate >= 0.8) fillColor = '#22c55e';
                else if (usageRate >= 0.6) fillColor = '#84cc16';
                else if (usageRate >= 0.4) fillColor = '#eab308';
                else if (usageRate >= 0.2) fillColor = '#f97316';
                else fillColor = '#ef4444';
                const marker = L.circleMarker([lat, lng], {
                    radius: iconSize,
                    fillColor: fillColor,
                    color: isEstimated ? '#ffd43b' : '#fff',
                    weight: isEstimated ? 3 : 2,
                    opacity: 1,
                    fillOpacity: isEstimated ? 0.7 : 0.8
                }).addTo(map);
                marker.warehouseData = warehouse;
                marker.coordinates = [lat, lng]; // åº§æ¨™æƒ…å ±ã‚’ä¿å­˜
                warehouseMarkers.push(marker);
                const popupContent = document.createElement('div');
                popupContent.className = 'warehouse-popup';
                const coordinateInfo = isEstimated ?
                    `<div style="color: #f76707; font-size: 12px; margin-bottom: 5px;">ğŸ“ åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãªã—ã€éƒ½å¸‚åº§æ¨™ä½¿ç”¨</div>` :
                    `<div style="color: #51cf66; font-size: 12px; margin-bottom: 5px;">ğŸ“ GPSåº§æ¨™ãƒ‡ãƒ¼ã‚¿</div>`;
                const usagePercentage = totalArea > 0 ? Math.round(((totalArea - availableArea) / totalArea) * 100) : 0;
              
                const facilityName = warehouse['æ–½è¨­åç§°'] || 'Unknown';
                const city = warehouse['å¸‚åŒºç”ºæ‘'] || '';
                const prefecture = warehouse['éƒ½é“åºœçœŒ'] || '';
                const address = warehouse['ä½æ‰€'] || '';
              
                // ç‰¹å¾´æƒ…å ±ã®å–å¾—
                const features = [];
                if (warehouse['ä¿ç¨å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸ­ä¿ç¨');
                if (warehouse['å®šæ¸©å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸŒ¡ï¸å®šæ¸©');
                if (warehouse['å†·è”µãƒ»å†·å‡å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('â„ï¸å†·è”µå†·å‡');
                if (warehouse['å–¶æ¥­å€‰åº«ç™»éŒ²ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸ“‹å–¶æ¥­ç™»éŒ²');
                if (warehouse['å›½éš›èˆªç©ºè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes' ||
                    warehouse['å›½éš›æµ·ä¸Šè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes') features.push('ğŸŒå›½éš›å¯¾å¿œ');
                if (warehouse['è²©ä¿ƒãƒ•ãƒ©ã‚°'] === 'Yes') features.push('ğŸ“¢è²©ä¿ƒ');
                if ((warehouse['ã‚»ãƒ¼ãƒ«ã‚¹ãƒã‚¤ãƒ³ãƒˆãªã©ç‰¹è¨˜äº‹é …'] || '').includes('å±é™º')) features.push('âš ï¸å±é™ºå“');
              
                const featuresText = features.length > 0 ? `<div style="margin-top: 8px; font-size: 0.8rem; color: #666;">${features.join(' ')}</div>` : '';
              
                popupContent.innerHTML = coordinateInfo + `
                    <div class="popup-header">${facilityName}</div>
                    <div class="popup-detail"><span>ğŸ“ æ‰€åœ¨åœ°:</span> <span>${city}${prefecture ? ', ' + prefecture : ''}</span></div>
                    ${address ? `<div class="popup-detail"><span>ğŸ¢ ä½æ‰€:</span> <span style="font-size: 0.8rem;">${address}</span></div>` : ''}
                    <div class="popup-detail"><span>ğŸ¢ åºŠé¢ç©:</span> <strong>${totalArea.toLocaleString()} åª</strong></div>
                    <div class="popup-detail"><span>ğŸ“¦ è²©å£²å¯èƒ½:</span> <strong>${availableArea.toLocaleString()} åª</strong></div>
                    <div class="popup-detail"><span>ğŸ“Š ç¨¼åƒç‡:</span> <strong>${usagePercentage}%</strong></div>
                    <div class="popup-detail"><span>â˜ï¸ å•åˆã›å…ˆ:</span> <span>${(warehouse['å•åˆã›å…ˆé›»è©±ç•ªå·'] || 'N/A').replace(/^'/, '')}</span></div>
                    <div class="popup-detail"><span>ğŸ“… æœ€çµ‚æ›´æ–°:</span> <span>${warehouse['æ›´æ–°æ—¥'] || 'N/A'}</span></div>
                    ${featuresText}
                `;
                marker.bindPopup(popupContent, { maxWidth: 320 });
            });
          
            // åˆå›è¡¨ç¤ºæ™‚ã¯å…¨ã¦ã®å€‰åº«ã‚’è¡¨ç¤º
            if (map && map.getBounds) {
                updateVisibleWarehouses();
            } else {
                displayWarehouseList();
            }
        }
        // ãƒãƒƒãƒ—è¡¨ç¤ºç¯„å›²å†…ã®å€‰åº«ã‚’æ›´æ–°
        function updateVisibleWarehouses() {
            if (!map || !map.getBounds) return;
            const bounds = map.getBounds();
            visibleWarehouseData = warehouseMarkers
                .filter(marker => bounds.contains(marker.coordinates))
                .map(marker => marker.warehouseData);
            displayWarehouseList(true); // è¡¨ç¤ºç¯„å›²ãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚¹ãƒˆæ›´æ–°
        }
        function populateRegionSelector() {
            const regionsContainer = document.getElementById('region-options');
            const regions = Object.keys(japanRegions);
          
            // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
            clearSearch('region');
          
            regionsContainer.innerHTML = '';
            regions.forEach(region => {
                const prefecturesInRegion = japanRegions[region];
                const count = allWarehouseData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return prefecturesInRegion.includes(prefecture);
                }).length;
              
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `<input type="checkbox" value="${region}" onchange="updateSelectedItems('region')"><span class="option-text">${region}</span><span class="option-count">(${count}æ£Ÿ)</span>`;
                regionsContainer.appendChild(option);
            });
            // å…¨ã¦é¸æŠçŠ¶æ…‹ã‚’åˆæœŸåŒ–
            document.getElementById('region-select-all').checked = false;
            document.getElementById('region-select-all').indeterminate = false;
        }
        function populatePrefectureSelector() {
            const prefecturesContainer = document.getElementById('prefecture-options');
          
            // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
            clearSearch('prefecture');
          
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹åœ°åŸŸã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let currentData = allWarehouseData;
          
            if (selectedRegions.length > 0) {
                const allowedPrefectures = selectedRegions.flatMap(region => japanRegions[region] || []);
                currentData = currentData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return allowedPrefectures.includes(prefecture);
                });
            }
          
            if (currentData.length === 0) {
                prefecturesContainer.innerHTML = '<div class="multi-select-option" style="color: #999; font-style: italic;">é¸æŠå¯èƒ½ãªéƒ½é“åºœçœŒãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('prefecture-select-all').checked = false;
                document.getElementById('prefecture-select-all').indeterminate = false;
                return;
            }
          
            const prefectures = [...new Set(currentData.map(row => row['éƒ½é“åºœçœŒ'] || ''))].filter(Boolean).sort();
          
            prefecturesContainer.innerHTML = '';
            prefectures.forEach(prefecture => {
                const count = currentData.filter(row => row['éƒ½é“åºœçœŒ'] === prefecture).length;
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `<input type="checkbox" value="${prefecture}" onchange="updateSelectedItems('prefecture')"><span class="option-text">${prefecture}</span><span class="option-count">(${count}æ£Ÿ)</span>`;
                prefecturesContainer.appendChild(option);
            });
            document.getElementById('prefecture-select-all').checked = false;
            document.getElementById('prefecture-select-all').indeterminate = false;
        }
        function populateCitySelector() {
            const citiesContainer = document.getElementById('city-options');
          
            // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
            clearSearch('city');
          
            // ç¾åœ¨ã®é¸æŠã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã¿
            let currentData = allWarehouseData;
          
            if (selectedRegions.length > 0) {
                const allowedPrefectures = selectedRegions.flatMap(region => japanRegions[region] || []);
                currentData = currentData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return allowedPrefectures.includes(prefecture);
                });
            }
          
            if (selectedPrefectures.length > 0) {
                currentData = currentData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return selectedPrefectures.includes(prefecture);
                });
            }
          
            if (currentData.length === 0) {
                citiesContainer.innerHTML = '<div class="multi-select-option" style="color: #999; font-style: italic;">é¸æŠå¯èƒ½ãªå¸‚åŒºç”ºæ‘ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('city-select-all').checked = false;
                document.getElementById('city-select-all').indeterminate = false;
                return;
            }
          
            const cities = [...new Set(currentData.map(row => row['å¸‚åŒºç”ºæ‘'] || ''))].filter(Boolean).sort();
          
            citiesContainer.innerHTML = '';
            cities.forEach(city => {
                const count = currentData.filter(row => row['å¸‚åŒºç”ºæ‘'] === city).length;
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `<input type="checkbox" value="${city}" onchange="updateSelectedItems('city')"><span class="option-text">${city}</span><span class="option-count">(${count}æ£Ÿ)</span>`;
                citiesContainer.appendChild(option);
            });
            document.getElementById('city-select-all').checked = false;
            document.getElementById('city-select-all').indeterminate = false;
        }
        function populateOwnershipSelector() {
            const ownershipsContainer = document.getElementById('ownership-options');
          
            // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
            clearSearch('ownership');
          
            // ç¾åœ¨ã®é¸æŠã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã¿
            let currentData = allWarehouseData;
          
            if (selectedRegions.length > 0) {
                const allowedPrefectures = selectedRegions.flatMap(region => japanRegions[region] || []);
                currentData = currentData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return allowedPrefectures.includes(prefecture);
                });
            }
          
            if (selectedPrefectures.length > 0) {
                currentData = currentData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return selectedPrefectures.includes(prefecture);
                });
            }
          
            if (selectedCities.length > 0) {
                currentData = currentData.filter(row => {
                    const city = row['å¸‚åŒºç”ºæ‘'] || '';
                    return selectedCities.includes(city);
                });
            }
          
            if (currentData.length === 0) {
                ownershipsContainer.innerHTML = '<div class="multi-select-option" style="color: #999; font-style: italic;">é¸æŠå¯èƒ½ãªè‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('ownership-select-all').checked = false;
                document.getElementById('ownership-select-all').indeterminate = false;
                return;
            }
          
            const ownerships = [...new Set(currentData.map(row => row['è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹'] || ''))].filter(Boolean).sort();
          
            ownershipsContainer.innerHTML = '';
            ownerships.forEach(ownership => {
                const count = currentData.filter(row => row['è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹'] === ownership).length;
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `<input type="checkbox" value="${ownership}" onchange="updateSelectedItems('ownership')"><span class="option-text">${ownership}</span><span class="option-count">(${count}æ£Ÿ)</span>`;
                ownershipsContainer.appendChild(option);
            });
            document.getElementById('ownership-select-all').checked = false;
            document.getElementById('ownership-select-all').indeterminate = false;
        }
        function clearSearch(type) {
            const searchInput = document.getElementById(`${type}-search`);
            const searchIcon = document.getElementById(`${type}-search-icon`);
            const searchClear = document.getElementById(`${type}-search-clear`);
          
            if (searchInput) {
                searchInput.value = '';
                searchIcon.style.display = 'block';
                searchClear.style.display = 'none';
            }
        }
        function filterAndDisplayData() {
            // åœ°åŸŸãƒ»éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredData = allWarehouseData;
          
            if (selectedRegions.length > 0) {
                const allowedPrefectures = selectedRegions.flatMap(region => japanRegions[region] || []);
                filteredData = filteredData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return allowedPrefectures.includes(prefecture);
                });
            }
          
            if (selectedPrefectures.length > 0) {
                filteredData = filteredData.filter(row => {
                    const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                    return selectedPrefectures.includes(prefecture);
                });
            }
          
            if (selectedCities.length > 0) {
                filteredData = filteredData.filter(row => {
                    const city = row['å¸‚åŒºç”ºæ‘'] || '';
                    return selectedCities.includes(city);
                });
            }
          
            if (selectedOwnerships.length > 0) {
                filteredData = filteredData.filter(row => {
                    const ownership = row['è‡ªç¤¾æ‰€æœ‰ã‹è³ƒå€Ÿã‹'] || '';
                    return selectedOwnerships.includes(ownership);
                });
            }
            // æ©Ÿèƒ½ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (document.getElementById('filter-bonded').checked) {
                filteredData = filteredData.filter(row => row['ä¿ç¨å€‰åº«ã®æœ‰ç„¡'] === 'Yes');
            }
            if (document.getElementById('filter-temp-controlled').checked) {
                filteredData = filteredData.filter(row => row['å®šæ¸©å€‰åº«ã®æœ‰ç„¡'] === 'Yes');
            }
            if (document.getElementById('filter-refrigerated').checked) {
                filteredData = filteredData.filter(row => row['å†·è”µãƒ»å†·å‡å€‰åº«ã®æœ‰ç„¡'] === 'Yes');
            }
            if (document.getElementById('filter-licensed').checked) {
                filteredData = filteredData.filter(row => row['å–¶æ¥­å€‰åº«ç™»éŒ²ã®æœ‰ç„¡'] === 'Yes');
            }
            if (document.getElementById('filter-international').checked) {
                filteredData = filteredData.filter(row =>
                    row['å›½éš›èˆªç©ºè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes' || row['å›½éš›æµ·ä¸Šè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes'
                );
            }
            if (document.getElementById('filter-hazardous').checked) {
                filteredData = filteredData.filter(row => (row['ã‚»ãƒ¼ãƒ«ã‚¹ãƒã‚¤ãƒ³ãƒˆãªã©ç‰¹è¨˜äº‹é …'] || '').includes('å±é™º'));
            }
          
            warehouseData = filteredData;
            visibleWarehouseData = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
          
            // ãƒªã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const listTitle = document.querySelector('.warehouse-list h3');
            let titleParts = [];
          
            if (selectedRegions.length > 0) {
                if (selectedRegions.length === 1) {
                    titleParts.push(selectedRegions[0]);
                } else {
                    titleParts.push(`${selectedRegions.length}åœ°åŸŸ`);
                }
            }
          
            if (selectedPrefectures.length > 0) {
                if (selectedPrefectures.length === 1) {
                    titleParts.push(selectedPrefectures[0]);
                } else {
                    titleParts.push(`${selectedPrefectures.length}éƒ½é“åºœçœŒ`);
                }
            }
          
            if (selectedCities.length > 0) {
                if (selectedCities.length === 1) {
                    titleParts.push(selectedCities[0]);
                } else {
                    titleParts.push(`${selectedCities.length}å¸‚åŒºç”ºæ‘`);
                }
            }
          
            if (selectedOwnerships.length > 0) {
                if (selectedOwnerships.length === 1) {
                    titleParts.push(selectedOwnerships[0]);
                } else {
                    titleParts.push(`${selectedOwnerships.length}æ‰€æœ‰å½¢æ…‹`);
                }
            }
          
            const titleSuffix = titleParts.length > 0 ? `ï¼ˆ${titleParts.join(' - ')}ï¼‰` : 'ï¼ˆæ—¥æœ¬å…¨å›½ï¼‰';
            listTitle.textContent = `ğŸ“¦ ç©ºããŒå¤šã„é †ãƒªã‚¹ãƒˆ ${titleSuffix}`;
            displayWarehouses();
            updateStats();
            if (warehouseData.length > 0) {
                fitMapToData();
            }
        }
        function fitMapToData() {
            const validCoords = warehouseData.map((w, i) => getWarehouseCoordinates(w, i));
            if (validCoords.length > 0) {
                const group = new L.featureGroup(validCoords.map(coord => L.marker(coord)));
                if (validCoords.length === 1) {
                    map.setView(validCoords[0], 10);
                } else {
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }
        function displayWarehouseList(mapRangeMode = false) {
            const container = document.getElementById('warehouse-items');
            const visibleCountElement = document.getElementById('visible-count');
          
            // è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ±ºå®š
            const dataToDisplay = mapRangeMode ? visibleWarehouseData : warehouseData;
          
            // è¡¨ç¤ºç¯„å›²å†…ä»¶æ•°ã‚’æ›´æ–°
            visibleCountElement.textContent = mapRangeMode ? visibleWarehouseData.length : warehouseData.length;
          
            container.innerHTML = '';
            const sorted = [...dataToDisplay].sort((a, b) => {
                const totalA = parseFloat(a['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 1;
                const totalB = parseFloat(b['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 1;
                const availA = parseFloat(a['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
                const availB = parseFloat(b['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
                const rateA = availA / totalA;
                const rateB = availB / totalB;
                return rateB - rateA;
            });
            if (sorted.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'text-align: center; padding: 40px 20px; color: #999; font-style: italic; white-space: pre-line;';
                emptyMessage.textContent = mapRangeMode ?
                    'ğŸ” ã“ã®ç¯„å›²ã«ã¯å€‰åº«ãŒã‚ã‚Šã¾ã›ã‚“\nãƒãƒƒãƒ—ã‚’ç§»å‹•ã—ã¦ãã ã•ã„' :
                    'ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«è©²å½“ã™ã‚‹å€‰åº«ãŒã‚ã‚Šã¾ã›ã‚“';
                container.appendChild(emptyMessage);
                return;
            }
            sorted.forEach(w => {
                const total = parseFloat(w['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0;
                const avail = parseFloat(w['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
                const availRate = total > 0 ? Math.round((avail / total) * 100) : 0;
                const usageRate = 100 - availRate;
                let color;
                if (usageRate >= 80) color = '#22c55e';
                else if (usageRate >= 60) color = '#84cc16';
                else if (usageRate >= 40) color = '#eab308';
                else if (usageRate >= 20) color = '#f97316';
                else color = '#ef4444';
                const facilityName = w['æ–½è¨­åç§°'] || 'Unknown';
                const city = w['å¸‚åŒºç”ºæ‘'] || '';
                const prefecture = w['éƒ½é“åºœçœŒ'] || '';
                // ç‰¹å¾´ã‚¿ã‚°
                const features = [];
                if (w['ä¿ç¨å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸ­ä¿ç¨');
                if (w['å®šæ¸©å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸŒ¡ï¸å®šæ¸©');
                if (w['å†·è”µãƒ»å†·å‡å€‰åº«ã®æœ‰ç„¡'] === 'Yes') features.push('â„ï¸å†·è”µå†·å‡');
                if (w['å–¶æ¥­å€‰åº«ç™»éŒ²ã®æœ‰ç„¡'] === 'Yes') features.push('ğŸ“‹å–¶æ¥­ç™»éŒ²');
                if (w['å›½éš›èˆªç©ºè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes' || w['å›½éš›æµ·ä¸Šè¼¸é€ã¸ã®å¯¾å¿œå®Ÿç¸¾'] === 'Yes') features.push('ğŸŒå›½éš›å¯¾å¿œ');
                if (w['è²©ä¿ƒãƒ•ãƒ©ã‚°'] === 'Yes') features.push('ğŸ“¢è²©ä¿ƒ');
                if ((w['ã‚»ãƒ¼ãƒ«ã‚¹ãƒã‚¤ãƒ³ãƒˆãªã©ç‰¹è¨˜äº‹é …'] || '').includes('å±é™º')) features.push('âš ï¸å±é™ºå“');
              
                const featuresText = features.length > 0 ? `<div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${features.join(' ')}</div>` : '';
                const item = document.createElement('div');
                item.className = 'warehouse-item';
                item.innerHTML = `
                    <div class="warehouse-name">${facilityName}</div>
                    <div class="warehouse-details">${city}${prefecture ? ', ' + prefecture : ''}</div>
                    <div class="warehouse-stats">
                        <span>åºŠé¢ç©: ${total.toLocaleString()}åª</span>
                        <span>è²©å£²å¯èƒ½: ${avail.toLocaleString()}åª</span>
                        <span style="color: ${color}; font-weight: bold;">${availRate}%ç©ºã</span>
                    </div>
                    <div class="availability-bar">
                        <div class="availability-fill" style="width: ${availRate}%; background-color: ${color};"></div>
                    </div>
                    ${featuresText}
                `;
                item.addEventListener('click', () => focusOnWarehouse(w));
                container.appendChild(item);
            });
        }
        function focusOnWarehouse(targetWarehouse) {
            const facilityName = targetWarehouse['æ–½è¨­åç§°'] || '';
            const marker = warehouseMarkers.find(m => {
                const mName = m.warehouseData['æ–½è¨­åç§°'] || '';
                return mName === facilityName;
            });
            if (marker) {
                map.setView(marker.getLatLng(), Math.max(map.getZoom(), 10));
                marker.openPopup();
                marker.setStyle({ weight: 5, color: '#ff4757', fillOpacity: 1 });
                setTimeout(() => {
                    const latitude = parseFloat(targetWarehouse['ç·¯åº¦']) || 0;
                    const longitude = parseFloat(targetWarehouse['çµŒåº¦']) || 0;
                    const isEst = !latitude || !longitude || latitude === 0 || longitude === 0;
                    marker.setStyle({ weight: isEst ? 3 : 2, color: isEst ? '#ffd43b' : '#fff', fillOpacity: isEst ? 0.7 : 0.8 });
                }, 2000);
            }
        }
        function updateStats() {
            const totalWarehouses = warehouseData.length;
            const totalArea = warehouseData.reduce((sum, w) => {
                return sum + (parseFloat(w['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0);
            }, 0);
            const availableArea = warehouseData.reduce((sum, w) => {
                return sum + (parseFloat(w['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0);
            }, 0);
            const usageRates = warehouseData.map(w => {
                const total = parseFloat(w['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0;
                const available = parseFloat(w['è²©å£²å¯èƒ½é¢ç©(åª)']) || 0;
                return total > 0 ? ((total - available) / total) * 100 : 0;
            });
            const avgUsage = usageRates.length > 0 ? Math.round(usageRates.reduce((a, b) => a + b, 0) / usageRates.length) : 0;
            const withGPS = warehouseData.filter(w => {
                const latitude = parseFloat(w['ç·¯åº¦']) || 0;
                const longitude = parseFloat(w['çµŒåº¦']) || 0;
                return latitude && longitude && latitude !== 0 && longitude !== 0;
            }).length;
            const withCityCoords = totalWarehouses - withGPS;
            document.getElementById('warehouse-count').textContent = `${totalWarehouses} (GPS: ${withGPS}, éƒ½å¸‚: ${withCityCoords})`;
            document.getElementById('total-area').textContent = totalArea.toLocaleString();
            document.getElementById('available-area').textContent = availableArea.toLocaleString();
            document.getElementById('avg-usage').textContent = avgUsage;
        }
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        let uploadedFile = null;
        function showMessage(message, type = 'success') {
            const section = document.querySelector('.upload-section');
            const existing = section.querySelector('.message');
            if (existing) existing.remove();
          
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            section.appendChild(div);
        }
        function reprocessFile() {
            if (uploadedFile) {
                processCSVFile(uploadedFile);
            } else {
                showMessage('å…ˆã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        }
        function processCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            uploadedFile = file;
          
            // é¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å–å¾—
            const encoding = document.getElementById('encoding-select').value;
            console.log(`Reading file with encoding: ${encoding}`);
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                console.log('CSV content preview:', csv.substring(0, 500));
                Papa.parse(csv, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', '|', ';'],
                    complete: function(results) {
                        try {
                            // CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                            console.log('CSV Headers:', results.meta.fields);
                          
                            // å®Ÿéš›ã®CSVãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ã«æ¤œå‡º
                            const sampleRow = results.data[0] || {};
                            console.log('Sample row:', sampleRow);
                          
                            allWarehouseData = results.data.filter(row => {
                                // æ–½è¨­åç§°ã®å–å¾—
                                const facilityName = row['æ–½è¨­åç§°'] || '';
                              
                                // éƒ½é“åºœçœŒã®å–å¾—
                                const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                              
                                // å€‰åº«åºŠé¢ç©ã®å–å¾—
                                const totalArea = parseFloat(row['å€‰åº«åºŠé¢ç©ï¼ˆåªï¼‰']) || 0;
                              
                                console.log(`Row data: æ–½è¨­=${facilityName}, éƒ½é“åºœçœŒ=${prefecture}, é¢ç©=${totalArea}`);
                              
                                // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã‹ãƒã‚§ãƒƒã‚¯
                                const isValidArea = totalArea > 0;
                                const isValidFacility = facilityName && facilityName.length > 0;
                                const isValidPrefecture = prefecture && (
                                    prefecture.includes('çœŒ') || prefecture.includes('éƒ½') || prefecture.includes('åºœ') || prefecture.includes('é“') ||
                                    Object.values(japanRegions).flat().includes(prefecture)
                                );
                              
                                const isValid = isValidArea && isValidFacility && isValidPrefecture;
                                if (isValid) {
                                    console.log(`Valid warehouse found: ${facilityName} in ${prefecture} (${totalArea}mÂ²)`);
                                }
                              
                                return isValid;
                            });
                            if (allWarehouseData.length === 0) {
                                showMessage(`æœ‰åŠ¹ãªæ—¥æœ¬å›½å†…å€‰åº«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\næ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€Œ${encoding}ã€ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nåˆ¥ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚`, 'error');
                                return;
                            }
                            warehouseData = allWarehouseData;
                            selectedRegions = [];
                            selectedPrefectures = [];
                            selectedCities = [];
                            selectedOwnerships = [];
                            // çµ±è¨ˆæƒ…å ±ã®è¨ˆç®—
                            const prefectureCount = [...new Set(allWarehouseData.map(row => row['éƒ½é“åºœçœŒ']))].filter(Boolean).length;
                            const regionCounts = {};
                          
                            allWarehouseData.forEach(row => {
                                const prefecture = row['éƒ½é“åºœçœŒ'] || '';
                                for (const [region, prefectures] of Object.entries(japanRegions)) {
                                    if (prefectures.includes(prefecture)) {
                                        regionCounts[region] = (regionCounts[region] || 0) + 1;
                                    }
                                }
                            });
                          
                            const topRegions = Object.entries(regionCounts)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 3)
                                .map(([region, count]) => `${region}: ${count}æ£Ÿ`)
                                .join(', ');
                            // ç‰¹æ®Šæ©Ÿèƒ½ã®çµ±è¨ˆ
                            const bondedCount = allWarehouseData.filter(row => row['ä¿ç¨å€‰åº«ã®æœ‰ç„¡'] === 'Yes').length;
                            const tempControlledCount = allWarehouseData.filter(row => row['å®šæ¸©å€‰åº«ã®æœ‰ç„¡'] === 'Yes').length;
                            const refrigeratedCount = allWarehouseData.filter(row => row['å†·è”µãƒ»å†·å‡å€‰åº«ã®æœ‰ç„¡'] === 'Yes').length;
                          
                            let message = `âœ… ${encoding}ã§æ­£å¸¸ã«èª­ã¿è¾¼ã¿å®Œäº†ï¼\n${allWarehouseData.length}ä»¶ã®æ—¥æœ¬å›½å†…å€‰åº«ãƒ‡ãƒ¼ã‚¿ã‚’${prefectureCount}éƒ½é“åºœçœŒã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;
                            if (topRegions) {
                                message += `\nä¸»è¦åœ°åŸŸ: ${topRegions}`;
                            }
                            if (bondedCount > 0 || tempControlledCount > 0 || refrigeratedCount > 0) {
                                message += `\nç‰¹æ®Šæ©Ÿèƒ½: ä¿ç¨${bondedCount}æ£Ÿ, å®šæ¸©${tempControlledCount}æ£Ÿ, å†·è”µå†·å‡${refrigeratedCount}æ£Ÿ`;
                            }
                          
                            showMessage(message, 'success');
                            document.getElementById('controls').style.display = 'flex';
                            document.getElementById('map').style.display = 'block';
                            document.getElementById('warehouse-list').style.display = 'flex';
                            document.querySelector('.loading').style.display = 'none';
                            initMap();
                            populateRegionSelector();
                            populatePrefectureSelector();
                            populateCitySelector();
                            populateOwnershipSelector();
                            setupSearchFunctionality();
                            displayWarehouses();
                            updateStats();
                            fitMapToData();
                        } catch (error) {
                            showMessage(`ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${encoding}): ` + error.message, 'error');
                        }
                    },
                    error: function(error) {
                        showMessage(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${encoding}): ` + error.message, 'error');
                    }
                });
            };
            reader.onerror = () => showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${encoding})ã€‚`, 'error');
          
            // é¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            reader.readAsText(file, encoding);
        }
        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.querySelector('.upload-area');
            fileInput.addEventListener('change', e => e.target.files.length && processCSVFile(e.target.files[0]));
            ['dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
                if (eventName === 'dragover') uploadArea.classList.add('dragover');
                if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('dragover');
                if (eventName === 'drop' && e.dataTransfer.files.length) processCSVFile(e.dataTransfer.files[0]);
            }));
        }
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const multiSelects = document.querySelectorAll('.multi-select');
            multiSelects.forEach(multiSelect => {
                if (!multiSelect.contains(event.target)) {
                    const dropdown = multiSelect.querySelector('.multi-select-dropdown');
                    const display = multiSelect.querySelector('.multi-select-display');
                    dropdown.style.display = 'none';
                    display.classList.remove('open');
                }
            });
        });
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode();
            setupFileUpload();
            setupSearchFunctionality();
        });
    </script>
</body>
</html>