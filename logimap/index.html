<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµãƒãƒƒãƒ—è‡ªå‹•ä½œæˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #e5e7eb;
            min-height: 100vh;
            color: #1a202c;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 100vh;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .dark-mode .container {
            background: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 24px 32px;
            position: relative;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .header {
            background: #334155;
            border-bottom-color: #475569;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.8;
            font-weight: 400;
        }

        .header-controls {
            position: absolute;
            top: 24px;
            right: 32px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .language-switcher {
            display: flex;
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 2px;
        }

        .language-btn {
            padding: 6px 12px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .language-btn.active {
            background: white;
            color: #2d3748;
        }

        .dark-mode .language-btn.active {
            background: #e2e8f0;
            color: #334155;
        }

        .dark-mode-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            padding: 8px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 32px;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        .input-panel {
            width: 340px;
            min-width: 340px;
            background: #e5e7eb;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            max-height: calc(100vh - 100px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .input-panel {
            background: #0f172a;
            border-right-color: #475569;
        }

        .input-content {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
            font-size: 15px;
            transition: color 0.3s ease;
        }

        .dark-mode .form-group label {
            color: #cbd5e1;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
            color: #1a202c;
        }

        .dark-mode .form-group input, 
        .dark-mode .form-group select, 
        .dark-mode .form-group textarea {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
        }

        .dark-mode .form-group input:focus, 
        .dark-mode .form-group select:focus, 
        .dark-mode .form-group textarea:focus {
            border-color: #60a5fa;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin: 32px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .section-title {
            color: #f1f5f9;
            border-bottom-color: #475569;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .add-btn, .remove-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn {
            background: #3182ce;
            color: white;
        }

        .add-btn:hover {
            background: #2c5aa0;
        }

        .dark-mode .add-btn {
            background: #3b82f6;
        }

        .dark-mode .add-btn:hover {
            background: #2563eb;
        }

        .remove-btn {
            background: #e53e3e;
            color: white;
            margin-left: 8px;
        }

        .remove-btn:hover {
            background: #c53030;
        }

        .dark-mode .remove-btn {
            background: #ef4444;
        }

        .dark-mode .remove-btn:hover {
            background: #dc2626;
        }

        .location-item, .transport-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .location-item, 
        .dark-mode .transport-item {
            background: #334155;
            border-color: #475569;
        }

        .location-item h4, .transport-item h4 {
            font-size: 15px;
            color: #718096;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .dark-mode .location-item h4, 
        .dark-mode .transport-item h4 {
            color: #cbd5e1;
        }

        .map-panel {
            flex: 1;
            background: #f3f4f6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        .dark-mode .map-panel {
            background: #1e293b;
        }

        .map-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #e5e7eb;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .map-controls {
            background: #0f172a;
            border-bottom-color: #475569;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label, .export-btn {
            padding: 8px 16px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .file-input-label:hover, .export-btn:hover {
            background: #2d3748;
        }

        .dark-mode .file-input-label, 
        .dark-mode .export-btn {
            background: #475569;
        }

        .dark-mode .file-input-label:hover, 
        .dark-mode .export-btn:hover {
            background: #334155;
        }

        .export-btn.primary {
            background: #3182ce;
        }

        .export-btn.primary:hover {
            background: #2c5aa0;
        }

        .dark-mode .export-btn.primary {
            background: #3b82f6;
        }

        .dark-mode .export-btn.primary:hover {
            background: #2563eb;
        }

        .custom-textbox {
            position: absolute;
            background: #fff;
            border: 1px solid #3182ce;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 16px;
            min-width: 100px;
            min-height: 32px;
            resize: both;
            overflow: auto;
            cursor: move;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: #1a202c;
        }

        .dark-mode .custom-textbox {
            background: #334155;
            border-color: #60a5fa;
            color: #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .custom-textbox:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .dark-mode .custom-textbox:focus {
            border-color: #2563eb;
        }

        .custom-textbox.editing {
            cursor: text;
        }

        .delete-textbox, .delete-location-box {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            font-weight: 500;
        }

        .dark-mode .delete-textbox, 
        .dark-mode .delete-location-box {
            background: #ef4444;
        }

        .custom-textbox:hover .delete-textbox,
        .edit-mode .location-box:hover .delete-location-box {
            display: block;
        }

        .delete-textbox:hover, .delete-location-box:hover {
            background: #c53030;
        }

        .dark-mode .delete-textbox:hover, 
        .dark-mode .delete-location-box:hover {
            background: #dc2626;
        }

        .edit-mode .location-box,
        .edit-mode .flow-arrow,
        .edit-mode .custom-textbox {
            cursor: move;
            border-style: dashed !important;
        }

        .logistics-map {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            min-width: 100%;
            width: 100%;
            min-height: 800px;
            position: relative;
            margin: 0 auto;
            background: #f3f4f6;
            overflow: visible;
            gap: 16px;
            overflow-x: auto;
            overflow-y: auto;
            padding: 32px 16px;
            transition: background-color 0.3s ease;
        }

        .edit-mode .logistics-map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px dashed rgba(49, 130, 206, 0.3);
            border-radius: 8px;
            pointer-events: none;
            z-index: 1;
        }

        .edit-mode .logistics-map {
            min-height: 1200px;
            min-width: 1600px;
            border: 1px solid rgba(49, 130, 206, 0.2);
            position: relative;
        }

        .dark-mode .logistics-map {
            background: #1e293b;
        }

        .location-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            min-width: 200px;
            min-height: 400px;
        }

        .transport-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            min-width: 140px;
            min-height: 400px;
        }

        .location-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            width: 180px;
            height: 240px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #1a202c;
        }

        .edit-mode .location-box {
            cursor: move;
            transition: none; /* Disable transitions during edit mode for smoother dragging */
        }

        .location-box.dragging {
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transform: rotate(2deg);
            transition: none;
        }

        .dark-mode .location-box {
            background: #334155;
            border-color: #475569;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            color: #e2e8f0;
        }

        .location-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .dark-mode .location-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .location-box.domestic {
            border-left: 4px solid #38a169;
        }

        .location-box.overseas {
            border-left: 4px solid #d69e2e;
        }

        .location-box.bonded {
            border: 1px solid #e53e3e;
            background: #fef5e7;
        }

        .dark-mode .location-box.bonded {
            background: #422006;
            border-color: #ef4444;
        }

        .location-box.bonded::after {
            content: 'ä¿ç¨å€‰åº«';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #e53e3e;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }

        .dark-mode .location-box.bonded::after {
            background: #ef4444;
        }

        .location-box.existing-own {
            background: #ebf8ff;
            border-color: #3182ce;
        }

        .dark-mode .location-box.existing-own {
            background: #1e3a8a;
            border-color: #3b82f6;
        }

        .location-box.existing-own::before {
            content: 'è‡ªç¤¾';
            position: absolute;
            top: 4px;
            right: 4px;
            background: #3182ce;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
        }

        .dark-mode .location-box.existing-own::before {
            background: #3b82f6;
        }

        .location-box.existing-other {
            background: #f0fff4;
            border-color: #38a169;
        }

        .dark-mode .location-box.existing-other {
            background: #14532d;
            border-color: #22c55e;
        }

        .location-box.existing-other::before {
            content: 'ä»–ç¤¾';
            position: absolute;
            top: 4px;
            right: 4px;
            background: #38a169;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
        }

        .dark-mode .location-box.existing-other::before {
            background: #22c55e;
        }

        .location-box.new {
            background: #fef5e7;
            border-color: #d69e2e;
        }

        .dark-mode .location-box.new {
            background: #451a03;
            border-color: #f59e0b;
        }

        .location-box.new::before {
            content: 'æ–°è¦';
            position: absolute;
            top: 4px;
            right: 4px;
            background: #d69e2e;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
        }

        .dark-mode .location-box.new::before {
            background: #f59e0b;
        }

        .temp-control-info {
            margin-top: 8px;
            padding: 8px;
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .dark-mode .temp-control-info {
            background: #14532d;
            border-color: #166534;
            color: #f0fdf4;
        }

        .temp-control-info .work-content-text {
            font-size: 9px;
            color: #2d3748;
            line-height: 1.3;
            text-align: center;
            font-weight: 500;
        }

        .dark-mode .temp-control-info .work-content-text {
            color: #f0fdf4 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .work-content-border {
            border-color: #38a169 !important;
        }

        .dark-mode .work-content-border {
            border-color: #22c55e !important;
        }

        .temp-control-title {
            font-weight: 500;
            color: #2f855a;
            margin-bottom: 4px;
            text-align: center;
            font-size: 12px;
            transition: color 0.3s ease;
        }

        .dark-mode .temp-control-title {
            color: #22c55e;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .temp-humidity-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .temp-item, .humidity-item {
            flex: 1;
            text-align: center;
        }

        .temp-label, .humidity-label {
            font-size: 10px;
            color: #718096;
            margin-bottom: 2px;
            transition: color 0.3s ease;
            font-weight: 500;
        }

        .dark-mode .temp-label, 
        .dark-mode .humidity-label {
            color: #cbd5e1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .temp-value, .humidity-value {
            font-weight: 500;
            color: #2d3748;
            font-size: 11px;
            transition: color 0.3s ease;
        }

        .dark-mode .temp-value, 
        .dark-mode .humidity-value {
            color: #f0fdf4;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .location-emoji {
            font-size: 32px;
            margin-bottom: 8px;
            text-align: center;
            display: block;
        }

        .location-title {
            font-size: 13px;
            font-weight: 500;
            color: #718096;
            margin-bottom: 6px;
            text-align: center;
            transition: color 0.3s ease;
        }

        .dark-mode .location-title {
            color: #94a3b8;
        }

        .location-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            line-height: 1.3;
            transition: color 0.3s ease;
        }

        .dark-mode .location-name {
            color: #f1f5f9;
        }

        .location-type {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .domestic-tag {
            background: #c6f6d5;
            color: #2f855a;
            transition: all 0.3s ease;
        }

        .dark-mode .domestic-tag {
            background: #166534;
            color: #22c55e;
        }

        .overseas-tag {
            background: #faf089;
            color: #b7791f;
            transition: all 0.3s ease;
        }

        .dark-mode .overseas-tag {
            background: #92400e;
            color: #fbbf24;
        }

        .flow-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0;
            flex-shrink: 0;
        }

        .transport-info {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            margin: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            width: 150px;
            height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
            color: #1a202c;
        }

        .dark-mode .transport-info {
            background: #334155;
            border-color: #475569;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            color: #e2e8f0;
        }

        .transport-info.existing-own {
            background: #ebf8ff;
            border-color: #3182ce;
        }

        .dark-mode .transport-info.existing-own {
            background: #1e3a8a;
            border-color: #3b82f6;
        }

        .transport-info.existing-other {
            background: #f0fff4;
            border-color: #38a169;
        }

        .dark-mode .transport-info.existing-other {
            background: #14532d;
            border-color: #22c55e;
        }

        .transport-info.new {
            background: #fef5e7;
            border-color: #d69e2e;
        }

        .dark-mode .transport-info.new {
            background: #451a03;
            border-color: #f59e0b;
        }

        .transport-arrow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
        }

        .transport-arrow {
            font-size: 18px;
            color: #4a5568;
            transition: color 0.3s ease;
        }

        .dark-mode .transport-arrow {
            color: #94a3b8;
        }

        .transport-details {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #e2e8f0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            transition: border-color 0.3s ease;
        }

        .dark-mode .transport-details {
            border-top-color: #475569;
        }

        .transport-detail-item {
            display: flex;
            justify-content: space-between;
            margin: 1px 0;
            font-size: 10px;
            line-height: 1.1;
        }

        .transport-detail-label {
            color: #718096;
            font-weight: 500;
            flex-shrink: 0;
            font-size: 9px;
            transition: color 0.3s ease;
        }

        .dark-mode .transport-detail-label {
            color: #94a3b8;
        }

        .transport-detail-value {
            color: #2d3748;
            font-weight: 500;
            text-align: right;
            word-break: break-word;
            margin-left: 2px;
            font-size: 10px;
            transition: color 0.3s ease;
        }

        .dark-mode .transport-detail-value {
            color: #e2e8f0;
        }

        .transport-status-info {
            background: #f7fafc;
            border-radius: 3px;
            padding: 2px 6px;
            margin: 4px 0;
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .dark-mode .transport-status-info {
            background: #475569;
        }

        .transport-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .flow-label {
            font-size: 11px;
            color: #718096;
            font-weight: 500;
            margin-bottom: 2px;
            transition: color 0.3s ease;
        }

        .dark-mode .flow-label {
            color: #94a3b8;
        }

        .flow-value {
            font-size: 13px;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .dark-mode .flow-value {
            color: #f1f5f9;
        }

        .generate-btn {
            width: 100%;
            padding: 12px;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .generate-btn:hover {
            background: #2c5aa0;
        }

        .dark-mode .generate-btn {
            background: #3b82f6;
        }

        .dark-mode .generate-btn:hover {
            background: #2563eb;
        }

        .warehouse-options, .temp-control-options {
            margin-top: 12px;
            padding: 12px;
            background: #d1d5db;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .dark-mode .warehouse-options, 
        .dark-mode .temp-control-options {
            background: #1e293b;
            border-color: #475569;
        }

        .temp-control-row {
            display: flex;
            gap: 12px;
        }

        .temp-control-row .form-group {
            flex: 1;
        }

        .error-message {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .dark-mode .error-message {
            color: #ef4444;
        }

        @media (max-width: 1200px) {
            .container {
                margin: 0;
                width: 100%;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .input-panel {
                width: 100%;
                max-height: none;
                min-width: auto;
            }
            
            .logistics-map {
                flex-direction: column;
                min-height: auto;
                gap: 24px;
                min-width: auto;
                padding: 24px 16px;
            }
            
            .location-group, .transport-group {
                width: 100%;
                min-height: auto;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 16px;
            }
            
            .location-box {
                width: 160px;
                height: 160px;
            }
            
            .transport-info {
                width: 120px;
                height: 160px;
            }

            .header-controls {
                position: static;
                margin-top: 16px;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <div class="language-switcher">
                    <button class="language-btn active" onclick="switchLanguage('ja', this)">æ—¥æœ¬èª</button>
                    <button class="language-btn" onclick="switchLanguage('en', this)">English</button>
                    <button class="language-btn" onclick="switchLanguage('zh', this)">ä¸­æ–‡</button>
                </div>
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <span class="dark-mode-icon">ğŸŒ™</span>
                </button>
            </div>
            <h1 data-i18n="title">ç‰©æµãƒãƒƒãƒ—è‡ªå‹•ä½œæˆ</h1>
            <p data-i18n="subtitle">èª¿é”å…ˆã‹ã‚‰ç´å…¥å…ˆã¾ã§ã®ç‰©æµãƒ•ãƒ­ãƒ¼ã‚’å¯è¦–åŒ–</p>
        </div>
        
        <div class="main-content">
            <div class="input-panel">
                <div class="input-content">
                    <div class="section-title">
                        <span data-i18n="suppliers">èª¿é”å…ˆæƒ…å ±</span>
                        <button class="add-btn" onclick="addSupplier()" data-i18n="add">+ è¿½åŠ </button>
                    </div>
                    <div id="suppliers-container">
                        <div class="location-item" data-index="0">
                            <h4><span data-i18n="supplier">èª¿é”å…ˆ</span> 1
                                <button class="remove-btn" onclick="removeSupplier(0)" style="display: none;" data-i18n="remove">å‰Šé™¤</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="supplierName">èª¿é”å…ˆå</label>
                                <input type="text" id="supplier-name-0" placeholder="ä¾‹ï¼šABCå•†äº‹" value="ä¸Šæµ·é›»å­éƒ¨å“">
                                <div class="error-message" id="supplier-name-0-error">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="domesticOverseas">å›½å†…/æµ·å¤–</label>
                                <select id="supplier-location-0">
                                    <option value="domestic" data-i18n="domestic">å›½å†…</option>
                                    <option value="overseas" selected data-i18n="overseas">æµ·å¤–</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">å›½</label>
                                    <input type="text" id="supplier-country-0" placeholder="ä¾‹ï¼šæ—¥æœ¬" value="ä¸­å›½">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">å¸‚</label>
                                    <input type="text" id="supplier-city-0" placeholder="ä¾‹ï¼šæ±äº¬" value="ä¸Šæµ·">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">
                        <span data-i18n="warehouses">å€‰åº«æƒ…å ±</span>
                        <button class="add-btn" onclick="addWarehouse()" data-i18n="add">+ è¿½åŠ </button>
                    </div>
                    <div id="warehouses-container">
                        <div class="location-item" data-index="0">
                            <h4><span data-i18n="warehouse">å€‰åº«</span> 1
                                <button class="remove-btn" onclick="removeWarehouse(0)" style="display: none;" data-i18n="remove">å‰Šé™¤</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="warehouseName">å€‰åº«å</label>
                                <input type="text" id="warehouse-name-0" placeholder="ä¾‹ï¼šæ±äº¬ç¬¬ä¸€å€‰åº«" value="æˆç”°ä¿ç¨å€‰åº«">
                                <div class="error-message" id="warehouse-name-0-error">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="domesticOverseas">å›½å†…/æµ·å¤–</label>
                                    <select id="warehouse-location-0">
                                        <option value="domestic" selected data-i18n="domestic">å›½å†…</option>
                                        <option value="overseas" data-i18n="overseas">æµ·å¤–</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="existingNew">é‹å–¶ä¸»ä½“</label>
                                    <select id="warehouse-status-0">
                                        <option value="existing-own" selected data-i18n="existingOwn">æ—¢å­˜ï¼ˆè‡ªç¤¾ï¼‰</option>
                                        <option value="existing-other" data-i18n="existingOther">æ—¢å­˜ï¼ˆä»–ç¤¾ï¼‰</option>
                                        <option value="new" data-i18n="new">æ–°è¦</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">å›½</label>
                                    <input type="text" id="warehouse-country-0" placeholder="ä¾‹ï¼šæ—¥æœ¬" value="æ—¥æœ¬">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">å¸‚</label>
                                    <input type="text" id="warehouse-city-0" placeholder="ä¾‹ï¼šæ±äº¬" value="æˆç”°">
                                </div>
                            </div>
                            <div id="warehouse-options-0" class="warehouse-options" style="display: block;">
                                <div class="form-group">
                                    <label data-i18n="warehouseType">å€‰åº«ã‚¿ã‚¤ãƒ—</label>
                                    <select id="warehouse-type-0">
                                        <option value="general" data-i18n="general">ä¸€èˆ¬å€‰åº«</option>
                                        <option value="bonded" selected data-i18n="bonded">ä¿ç¨å€‰åº«</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="workContent">ä½œæ¥­å†…å®¹</label>
                                <textarea id="warehouse-work-0" placeholder="ä¾‹ï¼šãƒ”ãƒƒã‚­ãƒ³ã‚°ã€ãƒ‘ãƒƒã‚­ãƒ³ã‚°ã€å“è³ªæ¤œæŸ»" rows="2">é€šé–¢æ‰‹ç¶šãã€æ¤œæŸ»ã€ä¿ç®¡</textarea>
                            </div>
                            <div class="form-group">
                                <label data-i18n="tempControl">æ¸©æ¹¿åº¦ç®¡ç†</label>
                                <select id="temp-control-0" onchange="toggleTempControl(0)">
                                    <option value="no" data-i18n="none">ãªã—</option>
                                    <option value="yes" data-i18n="yes">ã‚ã‚Š</option>
                                </select>
                            </div>
                            <div id="temp-control-options-0" class="temp-control-options" style="display: none;">
                                <div class="temp-control-row">
                                    <div class="form-group">
                                        <label data-i18n="temperature">è¨­å®šæ¸©åº¦ï¼ˆâ„ƒï¼‰</label>
                                        <input type="text" id="temperature-0" placeholder="ä¾‹ï¼š10-15" value="15-25">
                                    </div>
                                    <div class="form-group">
                                        <label data-i18n="humidity">è¨­å®šæ¹¿åº¦ï¼ˆ%ï¼‰</label>
                                        <input type="text" id="humidity-0" placeholder="ä¾‹ï¼š60-70" value="40-60">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">
                        <span data-i18n="destinations">ç´å…¥å…ˆæƒ…å ±</span>
                        <button class="add-btn" onclick="addDestination()" data-i18n="add">+ è¿½åŠ </button>
                    </div>
                    <div id="destinations-container">
                        <div class="location-item" data-index="0">
                            <h4><span data-i18n="destination">ç´å…¥å…ˆ</span> 1
                                <button class="remove-btn" onclick="removeDestination(0)" style="display: none;" data-i18n="remove">å‰Šé™¤</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="destinationName">ç´å…¥å…ˆå</label>
                                <input type="text" id="destination-name-0" placeholder="ä¾‹ï¼šXYZè£½ä½œæ‰€" value="æ±äº¬è£½é€ æ ªå¼ä¼šç¤¾">
                                <div class="error-message" id="destination-name-0-error">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="domesticOverseas">å›½å†…/æµ·å¤–</label>
                                <select id="destination-location-0">
                                    <option value="domestic" selected data-i18n="domestic">å›½å†…</option>
                                    <option value="overseas" data-i18n="overseas">æµ·å¤–</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">å›½</label>
                                    <input type="text" id="destination-country-0" placeholder="ä¾‹ï¼šæ—¥æœ¬" value="æ—¥æœ¬">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">å¸‚</label>
                                    <input type="text" id="destination-city-0" placeholder="ä¾‹ï¼šå¤§é˜ª" value="æ±äº¬">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title" data-i18n="transports">è¼¸é€æƒ…å ±</div>
                    <div id="transports-container"></div>

                    <button class="generate-btn" onclick="generateMap()" data-i18n="generateMap">ãƒãƒƒãƒ—ç”Ÿæˆ</button>
                </div>
            </div>

            <div class="map-panel">
                <div class="map-controls">
                    <div class="control-group">
                        <button class="export-btn primary" onclick="exportAsImage()" data-i18n="exportImage">
                            ğŸ“· ç”»åƒã¨ã—ã¦ä¿å­˜
                        </button>
                        <button class="export-btn" onclick="addTextBox()" data-i18n="addText">
                            ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
                        </button>
                        <button class="export-btn" onclick="toggleEditMode()" id="edit-mode-btn" data-i18n="editMode">
                            ğŸ”§ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <button class="export-btn" onclick="exportDataAsCSV()" data-i18n="exportData">
                            ğŸ“Š ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›
                        </button>
                        <button class="export-btn" onclick="downloadSampleTemplate()" data-i18n="downloadTemplate">
                            ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </button>
                        <div class="file-input-wrapper">
                            <input type="file" id="csv-import" accept=".csv" onchange="importDataFromCSV(event)">
                            <label for="csv-import" class="file-input-label" data-i18n="importData">
                                ğŸ“ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </label>
                        </div>
                    </div>
                </div>
                <div class="logistics-map" id="logistics-map"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state management - FIXED: Better index management
        let globalState = {
            suppliers: new Map(),
            warehouses: new Map(), 
            destinations: new Map(),
            nextSupplierId: 1,
            nextWarehouseId: 1,
            nextDestinationId: 1
        };

        let editMode = false;
        let textBoxCounter = 0;
        let dragElements = new Map();

        // Dark mode functionality - FIXED: Remove localStorage dependency
        let isDarkMode = false;

        function initializeDarkMode() {
            // FIXED: Default to normal mode (no dark mode)
            isDarkMode = false;
            updateDarkModeIcon(false);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            updateDarkModeIcon(isDarkMode);
        }

        function updateDarkModeIcon(darkMode) {
            const icon = document.querySelector('.dark-mode-icon');
            icon.textContent = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // å¤šè¨€èªå¯¾å¿œãƒ‡ãƒ¼ã‚¿
        const translations = {
            ja: {
                title: "ç‰©æµãƒãƒƒãƒ—è‡ªå‹•ä½œæˆ",
                subtitle: "èª¿é”å…ˆã‹ã‚‰ç´å…¥å…ˆã¾ã§ã®ç‰©æµãƒ•ãƒ­ãƒ¼ã‚’å¯è¦–åŒ–",
                suppliers: "èª¿é”å…ˆæƒ…å ±",
                warehouses: "å€‰åº«æƒ…å ±", 
                destinations: "ç´å…¥å…ˆæƒ…å ±",
                transports: "è¼¸é€æƒ…å ±",
                add: "+ è¿½åŠ ",
                remove: "å‰Šé™¤",
                supplier: "èª¿é”å…ˆ",
                warehouse: "å€‰åº«",
                destination: "ç´å…¥å…ˆ",
                supplierName: "èª¿é”å…ˆå",
                warehouseName: "å€‰åº«å",
                destinationName: "ç´å…¥å…ˆå",
                domesticOverseas: "å›½å†…/æµ·å¤–",
                domestic: "å›½å†…",
                overseas: "æµ·å¤–",
                country: "å›½",
                city: "å¸‚",
                existingNew: "é‹å–¶ä¸»ä½“",
                existing: "æ—¢å­˜",
                new: "æ–°è¦",
                existingOwn: "æ—¢å­˜ï¼ˆè‡ªç¤¾ï¼‰",
                existingOther: "æ—¢å­˜ï¼ˆä»–ç¤¾ï¼‰",
                warehouseType: "å€‰åº«ã‚¿ã‚¤ãƒ—",
                general: "ä¸€èˆ¬å€‰åº«",
                bonded: "ä¿ç¨å€‰åº«",
                workContent: "ä½œæ¥­å†…å®¹",
                tempControl: "æ¸©æ¹¿åº¦ç®¡ç†",
                none: "ãªã—",
                yes: "ã‚ã‚Š",
                temperature: "è¨­å®šæ¸©åº¦ï¼ˆâ„ƒï¼‰",
                humidity: "è¨­å®šæ¹¿åº¦ï¼ˆ%ï¼‰",
                transportMode: "è¼¸é€ãƒ¢ãƒ¼ãƒ‰",
                transportStatus: "é‹å–¶ä¸»ä½“",
                truck: "ãƒˆãƒ©ãƒƒã‚¯",
                ship: "æµ·é‹",
                air: "èˆªç©º",
                rail: "é‰„é“",
                departure: "å‡ºç™ºæ¸¯",
                arrival: "åˆ°ç€æ¸¯",
                frequency: "è¼¸é€é »åº¦",
                package: "è·å§¿",
                volume: "ç‰©é‡",
                generateMap: "ãƒãƒƒãƒ—ç”Ÿæˆ",
                exportImage: "ğŸ“· ç”»åƒã¨ã—ã¦ä¿å­˜",
                addText: "ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ",
                editMode: "ğŸ”§ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰",
                editComplete: "âœ… ç·¨é›†å®Œäº†",
                generating: "ğŸ“· ç”Ÿæˆä¸­...",
                supplierTitle: "èª¿é”å…ˆ",
                warehouseTitle: "å€‰åº«",
                destinationTitle: "ç´å…¥å…ˆ",
                transportModeLabel: "è¼¸é€ãƒ¢ãƒ¼ãƒ‰",
                bondedWarehouse: "ä¿ç¨å€‰åº«",
                tempHumidityControl: "ğŸŒ¡ï¸ æ¸©æ¹¿åº¦ç®¡ç†",
                workContentLabel: "ğŸ”§ ä½œæ¥­å†…å®¹",
                setTemp: "è¨­å®šæ¸©åº¦",
                setHumidity: "è¨­å®šæ¹¿åº¦",
                textPlaceholder: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...",
                exportData: "ğŸ“Š ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›",
                importData: "ğŸ“ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
                downloadTemplate: "ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
                importSuccess: "ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ",
                importError: "CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ",
                invalidFormat: "CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“",
                cannotDeleteLast: "æœ€å¾Œã®é …ç›®ã¯å‰Šé™¤ã§ãã¾ã›ã‚“",
                nameRequired: "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                validationError: "å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            },
            en: {
                title: "Logistics Map Generator",
                subtitle: "Visualize logistics flow from suppliers to destinations",
                suppliers: "Supplier Information",
                warehouses: "Warehouse Information",
                destinations: "Destination Information", 
                transports: "Transport Information",
                add: "+ Add",
                remove: "Remove",
                supplier: "Supplier",
                warehouse: "Warehouse",
                destination: "Destination",
                supplierName: "Supplier Name",
                warehouseName: "Warehouse Name",
                destinationName: "Destination Name",
                domesticOverseas: "Domestic/Overseas",
                domestic: "Domestic",
                overseas: "Overseas",
                country: "Country",
                city: "City",
                existingNew: "Operation",
                existing: "Existing",
                new: "New",
                existingOwn: "Existing (Own)",
                existingOther: "Existing (Other)",
                warehouseType: "Warehouse Type",
                general: "General Warehouse",
                bonded: "Bonded Warehouse",
                workContent: "Work Content",
                tempControl: "Temperature & Humidity Control",
                none: "None",
                yes: "Yes",
                temperature: "Set Temperature (â„ƒ)",
                humidity: "Set Humidity (%)",
                transportMode: "Transport Mode",
                transportStatus: "Operation",
                truck: "Truck",
                ship: "Ship",
                air: "Air",
                rail: "Rail",
                departure: "Departure Port",
                arrival: "Arrival Port",
                frequency: "Transport Frequency",
                package: "Package Type",
                volume: "Volume",
                generateMap: "Generate Map",
                exportImage: "ğŸ“· Export as Image",
                addText: "ğŸ“ Add Text",
                editMode: "ğŸ”§ Edit Mode",
                editComplete: "âœ… Edit Complete",
                generating: "ğŸ“· Generating...",
                supplierTitle: "Supplier",
                warehouseTitle: "Warehouse",
                destinationTitle: "Destination",
                transportModeLabel: "Transport Mode",
                bondedWarehouse: "Bonded Warehouse",
                tempHumidityControl: "ğŸŒ¡ï¸ Temp & Humidity Control",
                workContentLabel: "ğŸ”§ Work Content",
                setTemp: "Set Temp",
                setHumidity: "Set Humidity",
                textPlaceholder: "Enter text...",
                exportData: "ğŸ“Š Export CSV Data",
                importData: "ğŸ“ Import CSV",
                downloadTemplate: "ğŸ“‹ Sample Template",
                importSuccess: "Data import completed successfully",
                importError: "Failed to read CSV file",
                invalidFormat: "CSV file format is invalid",
                cannotDeleteLast: "Cannot delete the last item",
                nameRequired: "Please enter a name",
                validationError: "There are input errors"
            },
            zh: {
                title: "ç‰©æµåœ°å›¾è‡ªåŠ¨ç”Ÿæˆ",
                subtitle: "å¯è§†åŒ–ä»é‡‡è´­åœ°åˆ°äº¤ä»˜åœ°çš„ç‰©æµæµç¨‹",
                suppliers: "é‡‡è´­å•†ä¿¡æ¯",
                warehouses: "ä»“åº“ä¿¡æ¯",
                destinations: "äº¤ä»˜åœ°ä¿¡æ¯",
                transports: "è¿è¾“ä¿¡æ¯",
                add: "+ æ·»åŠ ",
                remove: "åˆ é™¤",
                supplier: "é‡‡è´­å•†",
                warehouse: "ä»“åº“",
                destination: "äº¤ä»˜åœ°",
                supplierName: "é‡‡è´­å•†åç§°",
                warehouseName: "ä»“åº“åç§°",
                destinationName: "äº¤ä»˜åœ°åç§°",
                domesticOverseas: "å›½å†…/æµ·å¤–",
                domestic: "å›½å†…",
                overseas: "æµ·å¤–",
                country: "å›½å®¶",
                city: "åŸå¸‚",
                existingNew: "è¿è¥ä¸»ä½“",
                existing: "ç°æœ‰",
                new: "æ–°å»º",
                existingOwn: "ç°æœ‰ï¼ˆè‡ªè¥ï¼‰",
                existingOther: "ç°æœ‰ï¼ˆä»–æ–¹ï¼‰",
                warehouseType: "ä»“åº“ç±»å‹",
                general: "æ™®é€šä»“åº“",
                bonded: "ä¿ç¨ä»“åº“",
                workContent: "ä½œä¸šå†…å®¹",
                tempControl: "æ¸©æ¹¿åº¦ç®¡ç†",
                none: "æ— ",
                yes: "æœ‰",
                temperature: "è®¾å®šæ¸©åº¦ï¼ˆâ„ƒï¼‰",
                humidity: "è®¾å®šæ¹¿åº¦ï¼ˆ%ï¼‰",
                transportMode: "è¿è¾“æ–¹å¼",
                transportStatus: "è¿è¥ä¸»ä½“",
                truck: "å¡è½¦",
                ship: "æµ·è¿",
                air: "èˆªç©º",
                rail: "é“è·¯",
                departure: "å‡ºå‘æ¸¯",
                arrival: "åˆ°è¾¾æ¸¯",
                frequency: "è¿è¾“é¢‘ç‡",
                package: "åŒ…è£…å½¢å¼",
                volume: "ç‰©é‡",
                generateMap: "ç”Ÿæˆåœ°å›¾",
                exportImage: "ğŸ“· ä¿å­˜ä¸ºå›¾ç‰‡",
                addText: "ğŸ“ æ·»åŠ æ–‡æœ¬",
                editMode: "ğŸ”§ ç¼–è¾‘æ¨¡å¼",
                editComplete: "âœ…ç¼–è¾‘å®Œæˆ",
                generating: "ğŸ“· ç”Ÿæˆä¸­...",
                supplierTitle: "é‡‡è´­å•†",
                warehouseTitle: "ä»“åº“",
                destinationTitle: "äº¤ä»˜åœ°",
                transportModeLabel: "è¿è¾“æ–¹å¼",
                bondedWarehouse: "ä¿ç¨ä»“åº“",
                tempHumidityControl: "ğŸŒ¡ï¸ æ¸©æ¹¿åº¦ç®¡ç†",
                workContentLabel: "ğŸ”§ ä½œä¸šå†…å®¹",
                setTemp: "è®¾å®šæ¸©åº¦",
                setHumidity: "è®¾å®šæ¹¿åº¦",
                textPlaceholder: "è¾“å…¥æ–‡æœ¬...",
                exportData: "ğŸ“Š å¯¼å‡ºCSVæ•°æ®",
                importData: "ğŸ“ å¯¼å…¥CSV",
                downloadTemplate: "ğŸ“‹ ç¤ºä¾‹æ¨¡æ¿",
                importSuccess: "æ•°æ®å¯¼å…¥æˆåŠŸå®Œæˆ",
                importError: "CSVæ–‡ä»¶è¯»å–å¤±è´¥",
                invalidFormat: "CSVæ–‡ä»¶æ ¼å¼æ— æ•ˆ",
                cannotDeleteLast: "æ— æ³•åˆ é™¤æœ€åä¸€é¡¹",
                nameRequired: "è¯·è¾“å…¥åç§°",
                validationError: "å­˜åœ¨è¾“å…¥é”™è¯¯"
            }
        };

        let currentLanguage = 'ja';

        function switchLanguage(lang, buttonElement) {
            currentLanguage = lang;
            
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                document.querySelector(`.language-btn[onclick*="${lang}"]`).classList.add('active');
            }
            
            updateTranslations();
            generateTransportForms();
            generateMap();
        }

        function updateTranslations() {
            const translation = translations[currentLanguage];
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translation[key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translation[key];
                    } else {
                        element.textContent = translation[key];
                    }
                }
            });
            updateDynamicLabels();
        }

        function getTranslation(key) {
            return translations[currentLanguage][key] || key;
        }

        // FIXED: Input validation
        function validateInput(type, index) {
            const nameInput = document.getElementById(`${type}-name-${index}`);
            const errorElement = document.getElementById(`${type}-name-${index}-error`);
            
            if (!nameInput || !errorElement) return true;
            
            const isValid = nameInput.value.trim() !== '';
            
            if (isValid) {
                errorElement.style.display = 'none';
                nameInput.style.borderColor = '';
            } else {
                errorElement.style.display = 'block';
                errorElement.textContent = getTranslation('nameRequired');
                nameInput.style.borderColor = '#e53e3e';
            }
            
            return isValid;
        }

        function validateAllInputs() {
            let isValid = true;
            
            // Validate suppliers
            globalState.suppliers.forEach((_, id) => {
                if (!validateInput('supplier', id)) isValid = false;
            });
            
            // Validate warehouses
            globalState.warehouses.forEach((_, id) => {
                if (!validateInput('warehouse', id)) isValid = false;
            });
            
            // Validate destinations
            globalState.destinations.forEach((_, id) => {
                if (!validateInput('destination', id)) isValid = false;
            });
            
            return isValid;
        }

        // FIXED: Improved item management with proper ID tracking
        function addSupplier() {
            const container = document.getElementById('suppliers-container');
            const newId = globalState.nextSupplierId++;
            const newSupplier = document.createElement('div');
            newSupplier.className = 'location-item';
            newSupplier.setAttribute('data-index', newId);
            
            globalState.suppliers.set(newId, {});
            
            const translation = translations[currentLanguage];
            
            newSupplier.innerHTML = `
                <h4><span data-i18n="supplier">${translation.supplier}</span> ${globalState.suppliers.size}
                    <button class="remove-btn" onclick="removeSupplier(${newId})" data-i18n="remove">${translation.remove}</button>
                </h4>
                <div class="form-group">
                    <label data-i18n="supplierName">${translation.supplierName}</label>
                    <input type="text" id="supplier-name-${newId}" placeholder="${translation.supplierName}" oninput="validateInput('supplier', ${newId})">
                    <div class="error-message" id="supplier-name-${newId}-error">${translation.nameRequired}</div>
                </div>
                <div class="form-group">
                    <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                    <select id="supplier-location-${newId}">
                        <option value="domestic" data-i18n="domestic">${translation.domestic}</option>
                        <option value="overseas" data-i18n="overseas">${translation.overseas}</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="country">${translation.country}</label>
                        <input type="text" id="supplier-country-${newId}" placeholder="${translation.country}">
                    </div>
                    <div class="form-group">
                        <label data-i18n="city">${translation.city}</label>
                        <input type="text" id="supplier-city-${newId}" placeholder="${translation.city}">
                    </div>
                </div>
            `;
            
            container.appendChild(newSupplier);
            updateRemoveButtons();
            generateTransportForms();
        }

        function removeSupplier(id) {
            if (globalState.suppliers.size <= 1) {
                alert(getTranslation('cannotDeleteLast'));
                return;
            }
            
            const item = document.querySelector(`#suppliers-container .location-item[data-index="${id}"]`);
            if (item) {
                item.remove();
                globalState.suppliers.delete(id);
                updateRemoveButtons();
                generateTransportForms();
                generateMap();
            }
        }

        function addWarehouse() {
            const container = document.getElementById('warehouses-container');
            const newId = globalState.nextWarehouseId++;
            const newWarehouse = document.createElement('div');
            newWarehouse.className = 'location-item';
            newWarehouse.setAttribute('data-index', newId);
            
            globalState.warehouses.set(newId, {});
            
            const translation = translations[currentLanguage];
            
            newWarehouse.innerHTML = `
                <h4><span data-i18n="warehouse">${translation.warehouse}</span> ${globalState.warehouses.size}
                    <button class="remove-btn" onclick="removeWarehouse(${newId})" data-i18n="remove">${translation.remove}</button>
                </h4>
                <div class="form-group">
                    <label data-i18n="warehouseName">${translation.warehouseName}</label>
                    <input type="text" id="warehouse-name-${newId}" placeholder="${translation.warehouseName}" oninput="validateInput('warehouse', ${newId})">
                    <div class="error-message" id="warehouse-name-${newId}-error">${translation.nameRequired}</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                        <select id="warehouse-location-${newId}">
                            <option value="domestic" data-i18n="domestic">${translation.domestic}</option>
                            <option value="overseas" data-i18n="overseas">${translation.overseas}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="existingNew">${translation.existingNew}</label>
                        <select id="warehouse-status-${newId}">
                            <option value="existing-own" data-i18n="existingOwn">${translation.existingOwn}</option>
                            <option value="existing-other" data-i18n="existingOther">${translation.existingOther}</option>
                            <option value="new" data-i18n="new">${translation.new}</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="country">${translation.country}</label>
                        <input type="text" id="warehouse-country-${newId}" placeholder="${translation.country}">
                    </div>
                    <div class="form-group">
                        <label data-i18n="city">${translation.city}</label>
                        <input type="text" id="warehouse-city-${newId}" placeholder="${translation.city}">
                    </div>
                </div>
                <div id="warehouse-options-${newId}" class="warehouse-options" style="display: block;">
                    <div class="form-group">
                        <label data-i18n="warehouseType">${translation.warehouseType}</label>
                        <select id="warehouse-type-${newId}">
                            <option value="general" data-i18n="general">${translation.general}</option>
                            <option value="bonded" data-i18n="bonded">${translation.bonded}</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="workContent">${translation.workContent}</label>
                    <textarea id="warehouse-work-${newId}" placeholder="${translation.workContent}" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label data-i18n="tempControl">${translation.tempControl}</label>
                    <select id="temp-control-${newId}" onchange="toggleTempControl(${newId})">
                        <option value="no" data-i18n="none">${translation.none}</option>
                        <option value="yes" data-i18n="yes">${translation.yes}</option>
                    </select>
                </div>
                <div id="temp-control-options-${newId}" class="temp-control-options" style="display: none;">
                    <div class="temp-control-row">
                        <div class="form-group">
                            <label data-i18n="temperature">${translation.temperature}</label>
                            <input type="text" id="temperature-${newId}" placeholder="${translation.temperature}" value="10-15">
                        </div>
                        <div class="form-group">
                            <label data-i18n="humidity">${translation.humidity}</label>
                            <input type="text" id="humidity-${newId}" placeholder="${translation.humidity}" value="60-70">
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(newWarehouse);
            updateRemoveButtons();
            generateTransportForms();
        }

        function removeWarehouse(id) {
            if (globalState.warehouses.size <= 1) {
                alert(getTranslation('cannotDeleteLast'));
                return;
            }
            
            const item = document.querySelector(`#warehouses-container .location-item[data-index="${id}"]`);
            if (item) {
                item.remove();
                globalState.warehouses.delete(id);
                updateRemoveButtons();
                generateTransportForms();
                generateMap();
            }
        }

        function addDestination() {
            const container = document.getElementById('destinations-container');
            const newId = globalState.nextDestinationId++;
            const newDestination = document.createElement('div');
            newDestination.className = 'location-item';
            newDestination.setAttribute('data-index', newId);
            
            globalState.destinations.set(newId, {});
            
            const translation = translations[currentLanguage];
            
            newDestination.innerHTML = `
                <h4><span data-i18n="destination">${translation.destination}</span> ${globalState.destinations.size}
                    <button class="remove-btn" onclick="removeDestination(${newId})" data-i18n="remove">${translation.remove}</button>
                </h4>
                <div class="form-group">
                    <label data-i18n="destinationName">${translation.destinationName}</label>
                    <input type="text" id="destination-name-${newId}" placeholder="${translation.destinationName}" oninput="validateInput('destination', ${newId})">
                    <div class="error-message" id="destination-name-${newId}-error">${translation.nameRequired}</div>
                </div>
                <div class="form-group">
                    <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                    <select id="destination-location-${newId}">
                        <option value="domestic" data-i18n="domestic">${translation.domestic}</option>
                        <option value="overseas" data-i18n="overseas">${translation.overseas}</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="country">${translation.country}</label>
                        <input type="text" id="destination-country-${newId}" placeholder="${translation.country}">
                    </div>
                    <div class="form-group">
                        <label data-i18n="city">${translation.city}</label>
                        <input type="text" id="destination-city-${newId}" placeholder="${translation.city}">
                    </div>
                </div>
            `;
            
            container.appendChild(newDestination);
            updateRemoveButtons();
            generateTransportForms();
        }

        function removeDestination(id) {
            if (globalState.destinations.size <= 1) {
                alert(getTranslation('cannotDeleteLast'));
                return;
            }
            
            const item = document.querySelector(`#destinations-container .location-item[data-index="${id}"]`);
            if (item) {
                item.remove();
                globalState.destinations.delete(id);
                updateRemoveButtons();
                generateTransportForms();
                generateMap();
            }
        }

        function updateRemoveButtons() {
            const selectors = ['#suppliers-container', '#warehouses-container', '#destinations-container'];
            const stateKeys = ['suppliers', 'warehouses', 'destinations'];
            
            selectors.forEach((selector, index) => {
                const stateKey = stateKeys[index];
                const items = document.querySelectorAll(`${selector} .location-item`);
                items.forEach((item) => {
                    const removeBtn = item.querySelector('.remove-btn');
                    if(removeBtn) {
                       removeBtn.style.display = globalState[stateKey].size > 1 ? 'inline-block' : 'none';
                    }
                });
            });
        }

        function generateTransportForms() {
            const container = document.getElementById('transports-container');
            container.innerHTML = '';

            const suppliers = Array.from(document.querySelectorAll('#suppliers-container .location-item'));
            const warehouses = Array.from(document.querySelectorAll('#warehouses-container .location-item'));
            const destinations = Array.from(document.querySelectorAll('#destinations-container .location-item'));

            const translation = translations[currentLanguage];
            let transportIndex = 0;

            // FIXED: Better transport form generation with proper error handling
            suppliers.forEach((supplier) => {
                warehouses.forEach((warehouse) => {
                    const supplierIndex = supplier.getAttribute('data-index');
                    const warehouseIndex = warehouse.getAttribute('data-index');
                    
                    // Safety check for element existence
                    const supplierNameEl = document.getElementById(`supplier-name-${supplierIndex}`);
                    const warehouseNameEl = document.getElementById(`warehouse-name-${warehouseIndex}`);
                    
                    if (!supplierNameEl || !warehouseNameEl) return;
                    
                    const supplierName = supplierNameEl.value || `${translation.supplier} ${parseInt(supplierIndex)+1}`;
                    const warehouseName = warehouseNameEl.value || `${translation.warehouse} ${parseInt(warehouseIndex)+1}`;

                    const transportItem = document.createElement('div');
                    transportItem.className = 'transport-item';
                    transportItem.innerHTML = `
                        <h4>${supplierName} â†’ ${warehouseName}</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="transportMode">${translation.transportMode}</label>
                                <select id="transport-${transportIndex}-mode">
                                    <option value="truck" data-i18n="truck">${translation.truck}</option>
                                    <option value="ship" data-i18n="ship">${translation.ship}</option>
                                    <option value="air" selected data-i18n="air">${translation.air}</option>
                                    <option value="rail" data-i18n="rail">${translation.rail}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="existingNew">${translation.existingNew}</label>
                                <select id="transport-${transportIndex}-status">
                                    <option value="existing-own" selected data-i18n="existingOwn">${translation.existingOwn}</option>
                                    <option value="existing-other" data-i18n="existingOther">${translation.existingOther}</option>
                                    <option value="new" data-i18n="new">${translation.new}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="departure">${translation.departure}</label>
                                <input type="text" id="transport-${transportIndex}-departure" placeholder="${translation.departure}" value="ä¸Šæµ·æµ¦æ±ç©ºæ¸¯">
                            </div>
                            <div class="form-group">
                                <label data-i18n="arrival">${translation.arrival}</label>
                                <input type="text" id="transport-${transportIndex}-arrival" placeholder="${translation.arrival}" value="æˆç”°ç©ºæ¸¯">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="frequency">${translation.frequency}</label>
                                <input type="text" id="transport-${transportIndex}-frequency" placeholder="${translation.frequency}" value="é€±3å›">
                            </div>
                            <div class="form-group">
                                <label data-i18n="package">${translation.package}</label>
                                <input type="text" id="transport-${transportIndex}-package" placeholder="${translation.package}" value="ULD">
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-i18n="volume">${translation.volume}</label>
                            <input type="text" id="transport-${transportIndex}-volume" placeholder="${translation.volume}" value="50ã‚³ãƒ³ãƒ†ãƒŠ">
                        </div>
                        <input type="hidden" id="transport-${transportIndex}-from" value="s${supplierIndex}">
                        <input type="hidden" id="transport-${transportIndex}-to" value="w${warehouseIndex}">
                        <input type="hidden" id="transport-${transportIndex}-type" value="supplier-warehouse">
                    `;
                    container.appendChild(transportItem);
                    transportIndex++;
                });
            });

            warehouses.forEach((warehouse) => {
                destinations.forEach((destination) => {
                    const warehouseIndex = warehouse.getAttribute('data-index');
                    const destinationIndex = destination.getAttribute('data-index');
                    
                    // Safety check for element existence
                    const warehouseNameEl = document.getElementById(`warehouse-name-${warehouseIndex}`);
                    const destinationNameEl = document.getElementById(`destination-name-${destinationIndex}`);
                    
                    if (!warehouseNameEl || !destinationNameEl) return;
                    
                    const warehouseName = warehouseNameEl.value || `${translation.warehouse} ${parseInt(warehouseIndex)+1}`;
                    const destinationName = destinationNameEl.value || `${translation.destination} ${parseInt(destinationIndex)+1}`;

                    const transportItem = document.createElement('div');
                    transportItem.className = 'transport-item';
                    transportItem.innerHTML = `
                        <h4>${warehouseName} â†’ ${destinationName}</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="transportMode">${translation.transportMode}</label>
                                <select id="transport-${transportIndex}-mode">
                                    <option value="truck" selected data-i18n="truck">${translation.truck}</option>
                                    <option value="ship" data-i18n="ship">${translation.ship}</option>
                                    <option value="air" data-i18n="air">${translation.air}</option>
                                    <option value="rail" data-i18n="rail">${translation.rail}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="existingNew">${translation.existingNew}</label>
                                <select id="transport-${transportIndex}-status">
                                    <option value="existing-own" selected data-i18n="existingOwn">${translation.existingOwn}</option>
                                    <option value="existing-other" data-i18n="existingOther">${translation.existingOther}</option>
                                    <option value="new" data-i18n="new">${translation.new}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="departure">${translation.departure}</label>
                                <input type="text" id="transport-${transportIndex}-departure" placeholder="${translation.departure}" value="æˆç”°å€‰åº«">
                            </div>
                            <div class="form-group">
                                <label data-i18n="arrival">${translation.arrival}</label>
                                <input type="text" id="transport-${transportIndex}-arrival" placeholder="${translation.arrival}" value="æ±äº¬å·¥å ´">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="frequency">${translation.frequency}</label>
                                <input type="text" id="transport-${transportIndex}-frequency" placeholder="${translation.frequency}" value="æ¯æ—¥">
                            </div>
                            <div class="form-group">
                                <label data-i18n="package">${translation.package}</label>
                                <input type="text" id="transport-${transportIndex}-package" placeholder="${translation.package}" value="ãƒ€ãƒ³ãƒœãƒ¼ãƒ«">
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-i18n="volume">${translation.volume}</label>
                            <input type="text" id="transport-${transportIndex}-volume" placeholder="${translation.volume}" value="200å€‹">
                        </div>
                        <input type="hidden" id="transport-${transportIndex}-from" value="w${warehouseIndex}">
                        <input type="hidden" id="transport-${transportIndex}-to" value="d${destinationIndex}">
                        <input type="hidden" id="transport-${transportIndex}-type" value="warehouse-destination">
                    `;
                    container.appendChild(transportItem);
                    transportIndex++;
                });
            });
        }

        function exportDataAsCSV() {
            try {
                let csvData = [];
                
                // Header
                csvData.push(['type', 'id', 'key', 'value']);
                
                // Suppliers
                document.querySelectorAll('#suppliers-container .location-item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const nameEl = document.getElementById(`supplier-name-${index}`);
                    const locationEl = document.getElementById(`supplier-location-${index}`);
                    const countryEl = document.getElementById(`supplier-country-${index}`);
                    const cityEl = document.getElementById(`supplier-city-${index}`);
                    
                    if (nameEl) csvData.push(['supplier', index, 'name', nameEl.value || '']);
                    if (locationEl) csvData.push(['supplier', index, 'location', locationEl.value || '']);
                    if (countryEl) csvData.push(['supplier', index, 'country', countryEl.value || '']);
                    if (cityEl) csvData.push(['supplier', index, 'city', cityEl.value || '']);
                });

                // Warehouses
                document.querySelectorAll('#warehouses-container .location-item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const nameEl = document.getElementById(`warehouse-name-${index}`);
                    const locationEl = document.getElementById(`warehouse-location-${index}`);
                    const statusEl = document.getElementById(`warehouse-status-${index}`);
                    const countryEl = document.getElementById(`warehouse-country-${index}`);
                    const cityEl = document.getElementById(`warehouse-city-${index}`);
                    const typeEl = document.getElementById(`warehouse-type-${index}`);
                    const workEl = document.getElementById(`warehouse-work-${index}`);
                    const tempControlEl = document.getElementById(`temp-control-${index}`);
                    const temperatureEl = document.getElementById(`temperature-${index}`);
                    const humidityEl = document.getElementById(`humidity-${index}`);
                    
                    if (nameEl) csvData.push(['warehouse', index, 'name', nameEl.value || '']);
                    if (locationEl) csvData.push(['warehouse', index, 'location', locationEl.value || '']);
                    if (statusEl) csvData.push(['warehouse', index, 'status', statusEl.value || '']);
                    if (countryEl) csvData.push(['warehouse', index, 'country', countryEl.value || '']);
                    if (cityEl) csvData.push(['warehouse', index, 'city', cityEl.value || '']);
                    if (typeEl) csvData.push(['warehouse', index, 'type', typeEl.value || '']);
                    if (workEl) csvData.push(['warehouse', index, 'work', workEl.value || '']);
                    if (tempControlEl) csvData.push(['warehouse', index, 'tempControl', tempControlEl.value || '']);
                    if (temperatureEl) csvData.push(['warehouse', index, 'temperature', temperatureEl.value || '']);
                    if (humidityEl) csvData.push(['warehouse', index, 'humidity', humidityEl.value || '']);
                });
                
                // Destinations
                document.querySelectorAll('#destinations-container .location-item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const nameEl = document.getElementById(`destination-name-${index}`);
                    const locationEl = document.getElementById(`destination-location-${index}`);
                    const countryEl = document.getElementById(`destination-country-${index}`);
                    const cityEl = document.getElementById(`destination-city-${index}`);
                    
                    if (nameEl) csvData.push(['destination', index, 'name', nameEl.value || '']);
                    if (locationEl) csvData.push(['destination', index, 'location', locationEl.value || '']);
                    if (countryEl) csvData.push(['destination', index, 'country', countryEl.value || '']);
                    if (cityEl) csvData.push(['destination', index, 'city', cityEl.value || '']);
                });

                // Transports
                document.querySelectorAll('#transports-container .transport-item').forEach((item, index) => {
                    const modeEl = document.getElementById(`transport-${index}-mode`);
                    const statusEl = document.getElementById(`transport-${index}-status`);
                    const departureEl = document.getElementById(`transport-${index}-departure`);
                    const arrivalEl = document.getElementById(`transport-${index}-arrival`);
                    const frequencyEl = document.getElementById(`transport-${index}-frequency`);
                    const packageEl = document.getElementById(`transport-${index}-package`);
                    const volumeEl = document.getElementById(`transport-${index}-volume`);
                    const fromEl = document.getElementById(`transport-${index}-from`);
                    const toEl = document.getElementById(`transport-${index}-to`);
                    const typeEl = document.getElementById(`transport-${index}-type`);
                    
                    if (modeEl) csvData.push(['transport', index, 'mode', modeEl.value || '']);
                    if (statusEl) csvData.push(['transport', index, 'status', statusEl.value || '']);
                    if (departureEl) csvData.push(['transport', index, 'departure', departureEl.value || '']);
                    if (arrivalEl) csvData.push(['transport', index, 'arrival', arrivalEl.value || '']);
                    if (frequencyEl) csvData.push(['transport', index, 'frequency', frequencyEl.value || '']);
                    if (packageEl) csvData.push(['transport', index, 'package', packageEl.value || '']);
                    if (volumeEl) csvData.push(['transport', index, 'volume', volumeEl.value || '']);
                    if (fromEl) csvData.push(['transport', index, 'from', fromEl.value || '']);
                    if (toEl) csvData.push(['transport', index, 'to', toEl.value || '']);
                    if (typeEl) csvData.push(['transport', index, 'type', typeEl.value || '']);
                });

                const csvContent = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `logistics_map_data_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                
                // Cleanup
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
            } catch (error) {
                console.error('CSV export error:', error);
                alert(getTranslation('exportError') || 'CSV export failed');
            }
        }

        function downloadSampleTemplate() {
            try {
                const csvData = [
                    ['type', 'id', 'key', 'value'],
                    ['supplier', '0', 'name', 'ä¸Šæµ·é›»å­éƒ¨å“'],
                    ['supplier', '0', 'location', 'overseas'],
                    ['supplier', '0', 'country', 'ä¸­å›½'],
                    ['supplier', '0', 'city', 'ä¸Šæµ·'],
                    ['warehouse', '0', 'name', 'æˆç”°ä¿ç¨å€‰åº«'],
                    ['warehouse', '0', 'location', 'domestic'],
                    ['warehouse', '0', 'status', 'existing-own'],
                    ['warehouse', '0', 'country', 'æ—¥æœ¬'],
                    ['warehouse', '0', 'city', 'æˆç”°'],
                    ['warehouse', '0', 'type', 'bonded'],
                    ['warehouse', '0', 'work', 'é€šé–¢æ‰‹ç¶šãã€æ¤œæŸ»ã€ä¿ç®¡'],
                    ['warehouse', '0', 'tempControl', 'no'],
                    ['warehouse', '0', 'temperature', '15-25'],
                    ['warehouse', '0', 'humidity', '40-60'],
                    ['destination', '0', 'name', 'æ±äº¬è£½é€ æ ªå¼ä¼šç¤¾'],
                    ['destination', '0', 'location', 'domestic'],
                    ['destination', '0', 'country', 'æ—¥æœ¬'],
                    ['destination', '0', 'city', 'æ±äº¬'],
                    ['transport', '0', 'mode', 'air'],
                    ['transport', '0', 'status', 'existing-own'],
                    ['transport', '0', 'departure', 'ä¸Šæµ·æµ¦æ±ç©ºæ¸¯'],
                    ['transport', '0', 'arrival', 'æˆç”°ç©ºæ¸¯'],
                    ['transport', '0', 'frequency', 'é€±3å›'],
                    ['transport', '0', 'package', 'ULD'],
                    ['transport', '0', 'volume', '50ã‚³ãƒ³ãƒ†ãƒŠ'],
                    ['transport', '0', 'from', 's0'],
                    ['transport', '0', 'to', 'w0'],
                    ['transport', '0', 'type', 'supplier-warehouse'],
                    ['transport', '1', 'mode', 'truck'],
                    ['transport', '1', 'status', 'existing-own'],
                    ['transport', '1', 'departure', 'æˆç”°å€‰åº«'],
                    ['transport', '1', 'arrival', 'æ±äº¬å·¥å ´'],
                    ['transport', '1', 'frequency', 'æ¯æ—¥'],
                    ['transport', '1', 'package', 'ãƒ€ãƒ³ãƒœãƒ¼ãƒ«'],
                    ['transport', '1', 'volume', '200å€‹'],
                    ['transport', '1', 'from', 'w0'],
                    ['transport', '1', 'to', 'd0'],
                    ['transport', '1', 'type', 'warehouse-destination']
                ];
                
                const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'logistics_map_template.csv';
                link.click();
                
                // Cleanup
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
            } catch (error) {
                console.error('Template download error:', error);
                alert(getTranslation('downloadError') || 'Template download failed');
            }
        }

        // FIXED: Improved CSV parsing with better error handling
        function importDataFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = {};
                    const text = e.target.result;
                    
                    // Improved CSV parsing with better regex and error handling
                    const lines = text.split('\n').filter(line => line.trim() !== '').slice(1); // Skip header and empty lines

                    lines.forEach((line, lineNumber) => {
                        try {
                            // More robust CSV parsing
                            const regex = /("(?:[^"]+|"")*"|[^,]*)/g;
                            const parts = [];
                            let match;
                            while ((match = regex.exec(line)) !== null) {
                                parts.push(match[1]);
                            }
                            
                            if (parts.length !== 4) {
                                console.warn(`Line ${lineNumber + 2}: Invalid format, expected 4 columns, got ${parts.length}`);
                                return;
                            }
                            
                            const [type, id, key, value] = parts.map(field => {
                                let cleanField = field.trim();
                                if (cleanField.startsWith('"') && cleanField.endsWith('"')) {
                                    cleanField = cleanField.slice(1, -1).replace(/""/g, '"');
                                }
                                return cleanField;
                            });

                            if (!data[type]) data[type] = {};
                            if (!data[type][id]) data[type][id] = {};
                            data[type][id][key] = value;
                        } catch (lineError) {
                            console.warn(`Error parsing line ${lineNumber + 2}:`, lineError);
                        }
                    });
                    
                    applyImportedData(data);
                    
                    alert(getTranslation('importSuccess'));
                } catch (error) {
                    console.error('CSV import error:', error);
                    alert(getTranslation('importError'));
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // FIXED: Improved data application with proper state management
        function applyImportedData(data) {
            try {
                // Clear existing data and reset state
                document.getElementById('suppliers-container').innerHTML = '';
                document.getElementById('warehouses-container').innerHTML = '';
                document.getElementById('destinations-container').innerHTML = '';
                
                globalState.suppliers.clear();
                globalState.warehouses.clear();
                globalState.destinations.clear();
                globalState.nextSupplierId = 0;
                globalState.nextWarehouseId = 0;
                globalState.nextDestinationId = 0;

                // Add suppliers
                if (data.supplier) {
                    const sortedSupplierIds = Object.keys(data.supplier).sort((a, b) => parseInt(a) - parseInt(b));
                    sortedSupplierIds.forEach(id => {
                        const numId = parseInt(id);
                        globalState.nextSupplierId = Math.max(globalState.nextSupplierId, numId + 1);
                        globalState.suppliers.set(numId, {});
                        
                        const container = document.getElementById('suppliers-container');
                        const translation = translations[currentLanguage];
                        const sData = data.supplier[id];
                        
                        const newSupplier = document.createElement('div');
                        newSupplier.className = 'location-item';
                        newSupplier.setAttribute('data-index', numId);
                        
                        newSupplier.innerHTML = `
                            <h4><span data-i18n="supplier">${translation.supplier}</span> ${globalState.suppliers.size}
                                <button class="remove-btn" onclick="removeSupplier(${numId})" data-i18n="remove">${translation.remove}</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="supplierName">${translation.supplierName}</label>
                                <input type="text" id="supplier-name-${numId}" placeholder="${translation.supplierName}" oninput="validateInput('supplier', ${numId})" value="${sData.name || ''}">
                                <div class="error-message" id="supplier-name-${numId}-error">${translation.nameRequired}</div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                                <select id="supplier-location-${numId}">
                                    <option value="domestic" ${sData.location === 'domestic' ? 'selected' : ''} data-i18n="domestic">${translation.domestic}</option>
                                    <option value="overseas" ${sData.location === 'overseas' ? 'selected' : ''} data-i18n="overseas">${translation.overseas}</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">${translation.country}</label>
                                    <input type="text" id="supplier-country-${numId}" placeholder="${translation.country}" value="${sData.country || ''}">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">${translation.city}</label>
                                    <input type="text" id="supplier-city-${numId}" placeholder="${translation.city}" value="${sData.city || ''}">
                                </div>
                            </div>
                        `;
                        container.appendChild(newSupplier);
                    });
                }

                // Add warehouses
                if (data.warehouse) {
                    const sortedWarehouseIds = Object.keys(data.warehouse).sort((a, b) => parseInt(a) - parseInt(b));
                    sortedWarehouseIds.forEach(id => {
                        const numId = parseInt(id);
                        globalState.nextWarehouseId = Math.max(globalState.nextWarehouseId, numId + 1);
                        globalState.warehouses.set(numId, {});
                        
                        const container = document.getElementById('warehouses-container');
                        const translation = translations[currentLanguage];
                        const wData = data.warehouse[id];
                        
                        const newWarehouse = document.createElement('div');
                        newWarehouse.className = 'location-item';
                        newWarehouse.setAttribute('data-index', numId);
                        
                        newWarehouse.innerHTML = `
                            <h4><span data-i18n="warehouse">${translation.warehouse}</span> ${globalState.warehouses.size}
                                <button class="remove-btn" onclick="removeWarehouse(${numId})" data-i18n="remove">${translation.remove}</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="warehouseName">${translation.warehouseName}</label>
                                <input type="text" id="warehouse-name-${numId}" placeholder="${translation.warehouseName}" oninput="validateInput('warehouse', ${numId})" value="${wData.name || ''}">
                                <div class="error-message" id="warehouse-name-${numId}-error">${translation.nameRequired}</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                                    <select id="warehouse-location-${numId}">
                                        <option value="domestic" ${wData.location === 'domestic' ? 'selected' : ''} data-i18n="domestic">${translation.domestic}</option>
                                        <option value="overseas" ${wData.location === 'overseas' ? 'selected' : ''} data-i18n="overseas">${translation.overseas}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="existingNew">${translation.existingNew}</label>
                                    <select id="warehouse-status-${numId}">
                                        <option value="existing-own" ${wData.status === 'existing-own' ? 'selected' : ''} data-i18n="existingOwn">${translation.existingOwn}</option>
                                        <option value="existing-other" ${wData.status === 'existing-other' ? 'selected' : ''} data-i18n="existingOther">${translation.existingOther}</option>
                                        <option value="new" ${wData.status === 'new' ? 'selected' : ''} data-i18n="new">${translation.new}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">${translation.country}</label>
                                    <input type="text" id="warehouse-country-${numId}" placeholder="${translation.country}" value="${wData.country || ''}">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">${translation.city}</label>
                                    <input type="text" id="warehouse-city-${numId}" placeholder="${translation.city}" value="${wData.city || ''}">
                                </div>
                            </div>
                            <div id="warehouse-options-${numId}" class="warehouse-options" style="display: block;">
                                <div class="form-group">
                                    <label data-i18n="warehouseType">${translation.warehouseType}</label>
                                    <select id="warehouse-type-${numId}">
                                        <option value="general" ${wData.type === 'general' ? 'selected' : ''} data-i18n="general">${translation.general}</option>
                                        <option value="bonded" ${wData.type === 'bonded' ? 'selected' : ''} data-i18n="bonded">${translation.bonded}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="workContent">${translation.workContent}</label>
                                <textarea id="warehouse-work-${numId}" placeholder="${translation.workContent}" rows="2">${wData.work || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label data-i18n="tempControl">${translation.tempControl}</label>
                                <select id="temp-control-${numId}" onchange="toggleTempControl(${numId})">
                                    <option value="no" ${wData.tempControl === 'no' ? 'selected' : ''} data-i18n="none">${translation.none}</option>
                                    <option value="yes" ${wData.tempControl === 'yes' ? 'selected' : ''} data-i18n="yes">${translation.yes}</option>
                                </select>
                            </div>
                            <div id="temp-control-options-${numId}" class="temp-control-options" style="display: ${wData.tempControl === 'yes' ? 'block' : 'none'};">
                                <div class="temp-control-row">
                                    <div class="form-group">
                                        <label data-i18n="temperature">${translation.temperature}</label>
                                        <input type="text" id="temperature-${numId}" placeholder="${translation.temperature}" value="${wData.temperature || '10-15'}">
                                    </div>
                                    <div class="form-group">
                                        <label data-i18n="humidity">${translation.humidity}</label>
                                        <input type="text" id="humidity-${numId}" placeholder="${translation.humidity}" value="${wData.humidity || '60-70'}">
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(newWarehouse);
                    });
                }

                // Add destinations
                if (data.destination) {
                    const sortedDestinationIds = Object.keys(data.destination).sort((a, b) => parseInt(a) - parseInt(b));
                    sortedDestinationIds.forEach(id => {
                        const numId = parseInt(id);
                        globalState.nextDestinationId = Math.max(globalState.nextDestinationId, numId + 1);
                        globalState.destinations.set(numId, {});
                        
                        const container = document.getElementById('destinations-container');
                        const translation = translations[currentLanguage];
                        const dData = data.destination[id];
                        
                        const newDestination = document.createElement('div');
                        newDestination.className = 'location-item';
                        newDestination.setAttribute('data-index', numId);
                        
                        newDestination.innerHTML = `
                            <h4><span data-i18n="destination">${translation.destination}</span> ${globalState.destinations.size}
                                <button class="remove-btn" onclick="removeDestination(${numId})" data-i18n="remove">${translation.remove}</button>
                            </h4>
                            <div class="form-group">
                                <label data-i18n="destinationName">${translation.destinationName}</label>
                                <input type="text" id="destination-name-${numId}" placeholder="${translation.destinationName}" oninput="validateInput('destination', ${numId})" value="${dData.name || ''}">
                                <div class="error-message" id="destination-name-${numId}-error">${translation.nameRequired}</div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="domesticOverseas">${translation.domesticOverseas}</label>
                                <select id="destination-location-${numId}">
                                    <option value="domestic" ${dData.location === 'domestic' ? 'selected' : ''} data-i18n="domestic">${translation.domestic}</option>
                                    <option value="overseas" ${dData.location === 'overseas' ? 'selected' : ''} data-i18n="overseas">${translation.overseas}</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="country">${translation.country}</label>
                                    <input type="text" id="destination-country-${numId}" placeholder="${translation.country}" value="${dData.country || ''}">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="city">${translation.city}</label>
                                    <input type="text" id="destination-city-${numId}" placeholder="${translation.city}" value="${dData.city || ''}">
                                </div>
                            </div>
                        `;
                        container.appendChild(newDestination);
                    });
                }

                // Update remove buttons
                updateRemoveButtons();

                // Regenerate transport forms and apply data
                generateTransportForms();
                
                if (data.transport) {
                    Object.keys(data.transport).forEach(id => {
                        const tData = data.transport[id];
                        const modeEl = document.getElementById(`transport-${id}-mode`);
                        const statusEl = document.getElementById(`transport-${id}-status`);
                        const departureEl = document.getElementById(`transport-${id}-departure`);
                        const arrivalEl = document.getElementById(`transport-${id}-arrival`);
                        const frequencyEl = document.getElementById(`transport-${id}-frequency`);
                        const packageEl = document.getElementById(`transport-${id}-package`);
                        const volumeEl = document.getElementById(`transport-${id}-volume`);
                        
                        if (modeEl) modeEl.value = tData.mode || 'truck';
                        if (statusEl) statusEl.value = tData.status || 'existing-own';
                        if (departureEl) departureEl.value = tData.departure || '';
                        if (arrivalEl) arrivalEl.value = tData.arrival || '';
                        if (frequencyEl) frequencyEl.value = tData.frequency || '';
                        if (packageEl) packageEl.value = tData.package || '';
                        if (volumeEl) volumeEl.value = tData.volume || '';
                    });
                }

                generateMap();
            } catch (error) {
                console.error('Data application error:', error);
                alert(getTranslation('importError'));
            }
        }

        function deleteLocationBox(type, index, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const stateKeys = {
                'supplier': 'suppliers',
                'warehouse': 'warehouses',
                'destination': 'destinations'
            };
            
            const removeFunctions = {
                'supplier': removeSupplier,
                'warehouse': removeWarehouse,
                'destination': removeDestination
            };
            
            const stateKey = stateKeys[type];
            if (!stateKey || globalState[stateKey].size <= 1) {
                alert(getTranslation('cannotDeleteLast') || 'Cannot delete the last item');
                return;
            }
            
            // Call the appropriate remove function
            removeFunctions[type](parseInt(index));
        }

        function toggleEditMode() {
            editMode = !editMode;
            const mapElement = document.getElementById('logistics-map');
            const editBtn = document.getElementById('edit-mode-btn');
            
            mapElement.classList.toggle('edit-mode', editMode);
            
            if (editMode) {
                editBtn.textContent = getTranslation('editComplete');
                editBtn.style.background = '#e53e3e';
                enableDragAndDrop();
                
                // Expand map area for better dragging experience
                mapElement.style.minWidth = '1600px';
                mapElement.style.minHeight = '1200px';
            } else {
                editBtn.textContent = getTranslation('editMode');
                editBtn.style.background = '#4a5568';
                disableDragAndDrop();
                
                // Reset map size when exiting edit mode
                mapElement.style.minWidth = '';
                mapElement.style.minHeight = '';
            }
        }

        function addTextBox() {
            textBoxCounter++;
            const mapElement = document.getElementById('logistics-map');
            const textBox = document.createElement('div');
            textBox.className = 'custom-textbox';
            textBox.contentEditable = true;
            textBox.innerHTML = `<span>${getTranslation('textPlaceholder')}</span>`;
            textBox.style.left = '50px';
            textBox.style.top = '50px';
            textBox.setAttribute('data-textbox-id', textBoxCounter);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-textbox';
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                // FIXED: Proper cleanup of drag handlers
                if (dragElements.has(textBox)) {
                    removeDragHandlers(textBox);
                }
                if (textBox.parentNode) {
                    textBox.parentNode.removeChild(textBox);
                }
            };
            
            textBox.appendChild(deleteBtn);
            mapElement.appendChild(textBox);
            
            if (editMode) {
                makeElementDraggable(textBox);
                textBox.style.border = '1px dashed #3182ce';
            }
        }

        function enableDragAndDrop() {
            document.querySelectorAll('#logistics-map .location-box, #logistics-map .flow-arrow, #logistics-map .custom-textbox').forEach(makeElementDraggable);
        }

        function disableDragAndDrop() {
            // FIXED: Proper cleanup of event listeners
            dragElements.forEach((handlers, element) => {
                removeDragHandlers(element);
            });
            dragElements.clear();
            
            // Remove draggable classes
            document.querySelectorAll('.draggable').forEach(element => {
                element.classList.remove('draggable');
            });
            
            // FIXED: Reset location boxes to their original positions if needed
            // Keep absolute positioning for boxes that were moved
            document.querySelectorAll('#logistics-map .location-box').forEach(locationBox => {
                if (locationBox.style.position === 'absolute') {
                    // Keep the absolute position but ensure proper z-index
                    locationBox.style.zIndex = '';
                }
            });
        }

        function removeDragHandlers(element) {
            const handlers = dragElements.get(element);
            if (handlers) {
                element.removeEventListener('mousedown', handlers.mousedown);
                dragElements.delete(element);
            }
        }

        function makeElementDraggable(element) {
            // FIXED: Better drag handler management
            if (dragElements.has(element)) {
                removeDragHandlers(element);
            }

            element.classList.add('draggable');
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isDragging = false;

            const mouseDownHandler = function(e) {
                // Prevent dragging when editing text
                if (element.classList.contains('custom-textbox') && e.target === element) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                pos3 = e.clientX;
                pos4 = e.clientY;
                isDragging = true;
                
                // Get current position before changing layout
                const rect = element.getBoundingClientRect();
                const mapElement = element.closest('.logistics-map');
                const mapRect = mapElement.getBoundingClientRect();
                
                // FIXED: For location boxes, remove from flexbox layout and attach directly to map
                let originalParent = null;
                let originalNextSibling = null;
                
                if (element.classList.contains('location-box')) {
                    originalParent = element.parentNode;
                    originalNextSibling = element.nextSibling;
                    
                    // Store original parent info for restoration
                    element.setAttribute('data-original-parent', originalParent.className);
                    element.setAttribute('data-original-index', Array.from(originalParent.children).indexOf(element));
                    
                    // Move element directly to map container
                    mapElement.appendChild(element);
                }
                
                // Calculate precise position accounting for scroll
                const scrollLeft = mapElement.scrollLeft;
                const scrollTop = mapElement.scrollTop;
                
                element.style.position = 'absolute';
                element.style.left = (rect.left - mapRect.left + scrollLeft) + 'px';
                element.style.top = (rect.top - mapRect.top + scrollTop) + 'px';
                element.style.zIndex = '2000';
                element.classList.add('dragging');
                
                // Add event listeners to document for proper tracking
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            };

            const mouseMoveHandler = function(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                const newTop = element.offsetTop - pos2;
                const newLeft = element.offsetLeft - pos1;
                
                // FIXED: Much more generous boundary checking for better dragging experience
                const mapElement = element.closest('.logistics-map');
                
                // Allow dragging in a much larger area (extend beyond current map size)
                const maxLeft = Math.max(1200, mapElement.scrollWidth + 400);
                const maxTop = Math.max(800, mapElement.scrollHeight + 400);
                const minLeft = -100; // Allow dragging slightly outside left edge
                const minTop = -50;   // Allow dragging slightly outside top edge
                
                element.style.top = Math.max(minTop, Math.min(newTop, maxTop)) + "px";
                element.style.left = Math.max(minLeft, Math.min(newLeft, maxLeft)) + "px";
                
                // Dynamically expand map container if element is dragged near edges
                const currentMapWidth = parseInt(mapElement.style.minWidth) || 1600;
                const currentMapHeight = parseInt(mapElement.style.minHeight) || 1200;
                
                if (newLeft > currentMapWidth - 200) {
                    mapElement.style.minWidth = (currentMapWidth + 300) + 'px';
                }
                if (newTop > currentMapHeight - 200) {
                    mapElement.style.minHeight = (currentMapHeight + 300) + 'px';
                }
            };

            const mouseUpHandler = function() {
                isDragging = false;
                element.classList.remove('dragging');
                element.style.zIndex = '1000';
                
                // FIXED: For location boxes, keep them in absolute position instead of returning to flexbox
                // This allows them to maintain their dragged position
                if (element.classList.contains('location-box')) {
                    // Remove the data attributes as they're no longer needed
                    element.removeAttribute('data-original-parent');
                    element.removeAttribute('data-original-index');
                    
                    // Keep the element in absolute position for free positioning
                    element.style.position = 'absolute';
                }
                
                // FIXED: Proper cleanup of event listeners
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };

            element.addEventListener('mousedown', mouseDownHandler);
            
            // Store handlers for cleanup
            dragElements.set(element, {
                mousedown: mouseDownHandler
            });
        }

        function toggleTempControl(index) {
            const tempControl = document.getElementById(`temp-control-${index}`);
            const tempControlOptions = document.getElementById(`temp-control-options-${index}`);
            if(tempControl && tempControlOptions) {
                tempControlOptions.style.display = tempControl.value === 'yes' ? 'block' : 'none';
            }
        }

        function generateMap() {
            // FIXED: Validation before generating map
            if (!validateAllInputs()) {
                alert(getTranslation('validationError'));
                return;
            }

            const mapContainer = document.getElementById('logistics-map');
            
            const suppliers = Array.from(document.querySelectorAll('#suppliers-container .location-item')).map(item => {
                const index = item.getAttribute('data-index');
                const nameEl = document.getElementById(`supplier-name-${index}`);
                const locationEl = document.getElementById(`supplier-location-${index}`);
                const countryEl = document.getElementById(`supplier-country-${index}`);
                const cityEl = document.getElementById(`supplier-city-${index}`);
                
                return { 
                    id: `s${index}`, 
                    index, 
                    name: nameEl ? nameEl.value : '', 
                    location: locationEl ? locationEl.value : 'domestic', 
                    country: countryEl ? countryEl.value : '', 
                    city: cityEl ? cityEl.value : '' 
                };
            }).filter(supplier => supplier.name); // Filter out empty suppliers

            const warehouses = Array.from(document.querySelectorAll('#warehouses-container .location-item')).map(item => {
                const index = item.getAttribute('data-index');
                const nameEl = document.getElementById(`warehouse-name-${index}`);
                const locationEl = document.getElementById(`warehouse-location-${index}`);
                const statusEl = document.getElementById(`warehouse-status-${index}`);
                const typeEl = document.getElementById(`warehouse-type-${index}`);
                const countryEl = document.getElementById(`warehouse-country-${index}`);
                const cityEl = document.getElementById(`warehouse-city-${index}`);
                const workEl = document.getElementById(`warehouse-work-${index}`);
                const tempControlEl = document.getElementById(`temp-control-${index}`);
                const temperatureEl = document.getElementById(`temperature-${index}`);
                const humidityEl = document.getElementById(`humidity-${index}`);
                
                return { 
                    id: `w${index}`, 
                    index, 
                    name: nameEl ? nameEl.value : '', 
                    location: locationEl ? locationEl.value : 'domestic', 
                    status: statusEl ? statusEl.value : 'existing-own', 
                    type: typeEl ? typeEl.value : 'general', 
                    country: countryEl ? countryEl.value : '', 
                    city: cityEl ? cityEl.value : '', 
                    work: workEl ? workEl.value : '', 
                    tempControl: tempControlEl ? tempControlEl.value : 'no', 
                    temperature: temperatureEl ? temperatureEl.value : '', 
                    humidity: humidityEl ? humidityEl.value : '' 
                };
            }).filter(warehouse => warehouse.name); // Filter out empty warehouses

            const destinations = Array.from(document.querySelectorAll('#destinations-container .location-item')).map(item => {
                const index = item.getAttribute('data-index');
                const nameEl = document.getElementById(`destination-name-${index}`);
                const locationEl = document.getElementById(`destination-location-${index}`);
                const countryEl = document.getElementById(`destination-country-${index}`);
                const cityEl = document.getElementById(`destination-city-${index}`);
                
                return { 
                    id: `d${index}`, 
                    index, 
                    name: nameEl ? nameEl.value : '', 
                    location: locationEl ? locationEl.value : 'domestic', 
                    country: countryEl ? countryEl.value : '', 
                    city: cityEl ? cityEl.value : '' 
                };
            }).filter(destination => destination.name); // Filter out empty destinations

            // Create sets of existing IDs for validation
            const existingSupplierIds = new Set(suppliers.map(s => s.id));
            const existingWarehouseIds = new Set(warehouses.map(w => w.id));
            const existingDestinationIds = new Set(destinations.map(d => d.id));

            const transports = Array.from(document.querySelectorAll('#transports-container .transport-item')).map((item, index) => {
                const fromElement = document.getElementById(`transport-${index}-from`);
                const toElement = document.getElementById(`transport-${index}-to`);
                
                if (!fromElement || !toElement) return null;
                
                const from = fromElement.value;
                const to = toElement.value;
                
                // FIXED: Better validation of transport references
                const fromExists = (from.startsWith('s') && existingSupplierIds.has(from)) ||
                                 (from.startsWith('w') && existingWarehouseIds.has(from));
                const toExists = (to.startsWith('w') && existingWarehouseIds.has(to)) ||
                               (to.startsWith('d') && existingDestinationIds.has(to));
                
                if (!fromExists || !toExists) return null;
                
                const modeEl = document.getElementById(`transport-${index}-mode`);
                const statusEl = document.getElementById(`transport-${index}-status`);
                const departureEl = document.getElementById(`transport-${index}-departure`);
                const arrivalEl = document.getElementById(`transport-${index}-arrival`);
                const frequencyEl = document.getElementById(`transport-${index}-frequency`);
                const packageEl = document.getElementById(`transport-${index}-package`);
                const volumeEl = document.getElementById(`transport-${index}-volume`);
                
                return { 
                    mode: modeEl ? modeEl.value : 'truck', 
                    status: statusEl ? statusEl.value : 'existing-own', 
                    departure: departureEl ? departureEl.value : '', 
                    arrival: arrivalEl ? arrivalEl.value : '', 
                    frequency: frequencyEl ? frequencyEl.value : '', 
                    package: packageEl ? packageEl.value : '', 
                    volume: volumeEl ? volumeEl.value : '', 
                    from: from, 
                    to: to 
                };
            }).filter(transport => transport !== null);
            
            // Preserve existing text boxes and dragged location boxes
            const existingTextBoxes = Array.from(mapContainer.querySelectorAll('.custom-textbox'));
            const draggedLocationBoxes = Array.from(mapContainer.querySelectorAll('.location-box[style*="position: absolute"]')).map(box => ({
                id: box.id,
                style: {
                    position: box.style.position,
                    left: box.style.left,
                    top: box.style.top,
                    zIndex: box.style.zIndex
                }
            }));

            mapContainer.innerHTML = '';

            const translation = translations[currentLanguage];
            const transportIcons = { truck: 'ğŸš›', ship: 'ğŸš¢', air: 'âœˆï¸', rail: 'ğŸš†' };
            const transportNames = { truck: translation.truck, ship: translation.ship, air: translation.air, rail: translation.rail };

            // Function to create a location box
            const createLocationBox = (item, type) => {
                let itemClass = `${item.location} ${item.status || ''}`;
                if (type === 'warehouse' && item.type === 'bonded') itemClass += ' bonded';

                const locationText = item.country || item.city ? `${item.country}${item.country && item.city ? ' ' : ''}${item.city}` : (item.location === 'domestic' ? translation.domestic : translation.overseas);
                
                // Define emojis for each type
                const emojis = {
                    'supplier': 'ğŸ­',
                    'warehouse': 'ğŸ¢',
                    'destination': 'ğŸ¬'
                };
                
                let detailsHTML = '';
                if(type === 'warehouse') {
                    const workInfo = item.work ? `<div class="temp-control-info work-content-border"><div class="temp-control-title">${translation.workContentLabel}</div><div class="work-content-text">${item.work.replace(/\n/g, '<br>')}</div></div>` : '';
                    const tempControlInfo = item.tempControl === 'yes' ? `<div class="temp-control-info"><div class="temp-control-title">${translation.tempHumidityControl}</div><div class="temp-humidity-row"><div class="temp-item"><div class="temp-label">${translation.setTemp}</div><div class="temp-value">${item.temperature}â„ƒ</div></div><div class="humidity-item"><div class="humidity-label">${translation.setHumidity}</div><div class="humidity-value">${item.humidity}%</div></div></div></div>` : '';
                    detailsHTML = workInfo + tempControlInfo;
                }

                return `
                    <div id="${item.id}" class="location-box ${itemClass}" data-type="${type}" data-index="${item.index}">
                        <button class="delete-location-box" onclick="deleteLocationBox('${type}', '${item.index}', event)">Ã—</button>
                        <div class="location-emoji">${emojis[type]}</div>
                        <div class="location-title">${translation[type + 'Title']}</div>
                        <div class="location-name">${item.name}</div>
                        <div class="location-type ${item.location}-tag">${locationText}</div>
                        ${detailsHTML}
                    </div>
                `;
            };

            // Function to create a transport arrow
            const createTransportArrow = (transport, index) => {
                let statusDisplayText = '';
                if (transport.status === 'existing-own') {
                    statusDisplayText = translation.existingOwn;
                } else if (transport.status === 'existing-other') {
                    statusDisplayText = translation.existingOther;
                } else if (transport.status === 'new') {
                    statusDisplayText = translation.new;
                }

                return `
                    <div id="transport-${index}" class="flow-arrow" data-type="transport">
                        <div class="transport-info ${transport.status}">
                            <div class="transport-icon">${transportIcons[transport.mode]}</div>
                            <div class="flow-label">${translation.transportModeLabel}</div>
                            <div class="flow-value">${transportNames[transport.mode]}</div>
                            <div class="transport-status-info">${statusDisplayText}</div>
                            <div class="transport-arrow-container">
                                <div class="transport-arrow">â¡</div>
                            </div>
                            <div class="transport-details">
                                <div class="transport-detail-item"><span class="transport-detail-label">å‡ºç™º:</span><span class="transport-detail-value">${transport.departure}</span></div>
                                <div class="transport-detail-item"><span class="transport-detail-label">åˆ°ç€:</span><span class="transport-detail-value">${transport.arrival}</span></div>
                                <div class="transport-detail-item"><span class="transport-detail-label">é »åº¦:</span><span class="transport-detail-value">${transport.frequency}</span></div>
                                <div class="transport-detail-item"><span class="transport-detail-label">è·å§¿:</span><span class="transport-detail-value">${transport.package}</span></div>
                                <div class="transport-detail-item"><span class="transport-detail-label">ç‰©é‡:</span><span class="transport-detail-value">${transport.volume}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // Create groups
            const supplierGroup = document.createElement('div');
            supplierGroup.className = 'location-group';
            supplierGroup.innerHTML = suppliers.map(s => createLocationBox(s, 'supplier')).join('');

            const transportGroup1 = document.createElement('div');
            transportGroup1.className = 'transport-group';
            transportGroup1.innerHTML = transports.filter(t => t.from.startsWith('s')).map((t, i) => createTransportArrow(t, i)).join('');

            const warehouseGroup = document.createElement('div');
            warehouseGroup.className = 'location-group';
            warehouseGroup.innerHTML = warehouses.map(w => createLocationBox(w, 'warehouse')).join('');
            
            const transportGroup2 = document.createElement('div');
            transportGroup2.className = 'transport-group';
            transportGroup2.innerHTML = transports.filter(t => t.from.startsWith('w')).map((t, i) => createTransportArrow(t, i + transports.filter(t => t.from.startsWith('s')).length)).join('');
            
            const destinationGroup = document.createElement('div');
            destinationGroup.className = 'location-group';
            destinationGroup.innerHTML = destinations.map(d => createLocationBox(d, 'destination')).join('');

            mapContainer.append(supplierGroup, transportGroup1, warehouseGroup, transportGroup2, destinationGroup);

            // Re-append text boxes
            existingTextBoxes.forEach(box => mapContainer.appendChild(box));

            // FIXED: Restore positions of previously dragged location boxes
            draggedLocationBoxes.forEach(boxData => {
                const restoredBox = document.getElementById(boxData.id);
                if (restoredBox) {
                    // Move to map container and restore absolute positioning
                    mapContainer.appendChild(restoredBox);
                    Object.assign(restoredBox.style, boxData.style);
                }
            });

            updateDynamicLabels();
        }

        function updateDynamicLabels() {
            // Update any dynamic labels if needed
        }

        // FIXED: Improved image export with better error handling
        function exportAsImage() {
            const mapElement = document.getElementById('logistics-map');
            const exportBtn = document.querySelector('button[onclick="exportAsImage()"]');

            if (!exportBtn) return;

            const originalButtonText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = getTranslation('generating');

            try {
                // FIXED: Better size calculation
                const fullWidth = Math.max(mapElement.scrollWidth, mapElement.offsetWidth);
                const fullHeight = Math.max(mapElement.scrollHeight, mapElement.offsetHeight);

                const options = {
                    backgroundColor: document.body.classList.contains('dark-mode') ? '#1e293b' : '#f3f4f6',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    width: fullWidth,
                    height: fullHeight,
                    onclone: (clonedDoc) => {
                        // Clean up cloned document for export
                        const clonedMap = clonedDoc.getElementById('logistics-map');
                        if (clonedMap) {
                            clonedMap.classList.remove('edit-mode');
                            clonedMap.querySelectorAll('.location-box, .flow-arrow, .custom-textbox').forEach(el => {
                                el.style.border = '';
                            });
                            clonedMap.style.width = fullWidth + 'px';
                            clonedMap.style.height = fullHeight + 'px';
                        }
                    }
                };

                html2canvas(mapElement, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `logistics-map_${new Date().toISOString().slice(0, 10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        if (link.href.startsWith('blob:')) {
                            URL.revokeObjectURL(link.href);
                        }
                    }, 100);
                }).catch(error => {
                    console.error('Image generation failed:', error);
                    alert('Image generation failed: ' + error.message);
                }).finally(() => {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalButtonText;
                });
            } catch (error) {
                console.error('Image export error:', error);
                alert('Image export failed: ' + error.message);
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalButtonText;
            }
        }

        // Initialize application
        window.onload = function() {
            try {
                initializeDarkMode();
                updateTranslations();
                
                // Initialize with default data
                globalState.suppliers.set(0, {});
                globalState.warehouses.set(0, {});
                globalState.destinations.set(0, {});
                
                generateTransportForms();
                generateMap();
                updateRemoveButtons();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Application initialization failed. Please refresh the page.');
            }
        };
    </script>
</body>
</html>