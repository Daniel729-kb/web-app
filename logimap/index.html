<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöõ Logistics Map Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS Custom Properties for Theming */
        :root {
            --primary-blue: #3182ce;
            --success-green: #38a169;
            --warning-yellow: #d69e2e;
            --danger-red: #e53e3e;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #e2e8f0;
            --panel-background: #f8fafc;
            --button-background: #ffffff;
            --input-background: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] {
            --primary-blue: #3b82f6;
            --success-green: #22c55e;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --panel-background: #2d3748;
            --button-background: #4a5568;
            --input-background: #2d3748;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        /* Header Styles */
        .header {
            background: var(--panel-background);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        .header__title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
        }
        .header__controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .language-switcher {
            display: flex;
            gap: 0.5rem;
        }
        .language-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .language-btn:hover,
        .language-btn.active {
            background: var(--primary-blue);
            color: white;
        }
        .theme-toggle,
        .export-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .theme-toggle:hover,
        .export-btn:hover {
            background: var(--primary-blue);
            color: white;
        }
        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: calc(100vh - 80px);
        }
        .input-panel {
            background: var(--panel-background);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 1rem;
        }
        .map-panel {
            background: var(--background-color);
            overflow: hidden;
            position: relative;
        }
        /* Section Styles */
        .section {
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .section__header {
            background: var(--primary-blue);
            color: white;
            padding: 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section__content {
            padding: 1rem;
        }
        .add-btn {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .add-btn:hover {
            background: var(--success-green);
            filter: brightness(1.1);
        }
        /* Location Box Styles */
        .location-box {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--input-background);
            position: relative;
        }
        .location-box--domestic {
            border-color: var(--primary-blue);
        }
        .location-box--overseas {
            border-color: var(--warning-yellow);
        }
        .location-box__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .location-box__title {
            font-weight: bold;
            color: var(--primary-blue);
        }
        .remove-btn {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-background);
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
        }
        .form-textarea {
            resize: vertical;
            min-height: 60px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Warehouse specific styles */
        .warehouse-options {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(49, 130, 206, 0.1);
            border-radius: 4px;
        }
        .warehouse-options--visible {
            display: block;
        }
        .warehouse-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .warehouse-type-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
        }
        .warehouse-type-btn.active {
            background: var(--primary-blue);
            color: white;
        }
        .operating-entity-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .entity-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .entity-btn.active {
            color: white;
        }
        .entity-btn--own.active {
            background: var(--primary-blue);
        }
        .entity-btn--other.active {
            background: var(--success-green);
        }
        .entity-btn--new.active {
            background: var(--warning-yellow);
        }
        /* Custom Entity Input */
        .custom-entity-input {
            display: none;
            margin-top: 0.5rem;
        }
        .custom-entity-input--visible {
            display: block;
        }
        /* Map Display Styles */
        .map-display {
            padding: 2rem;
            height: 100%;
            overflow: auto;
            position: relative;
        }
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        .map-control-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }
        .map-control-btn:hover {
            background: var(--primary-blue);
            color: white;
        }
        .map-control-btn.active {
            background: var(--primary-blue);
            color: white;
        }
        /* Map Elements */
        .map-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 600px;
            position: relative;
            overflow-x: auto;
            gap: 1rem;
        }
        .location-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            flex: 1;
            max-width: 200px;
            min-width: 180px;
        }
        .location-item {
            background: var(--input-background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow);
            position: relative;
            transition: all 0.2s;
        }
        .location-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .location-item--facility1 {
            border-color: var(--warning-yellow);
        }
        .location-item--facility2 {
            border-color: var(--primary-blue);
        }
        .location-item--facility3 {
            border-color: var(--success-green);
        }
        .location-item--facility4 {
            border-color: #6b46c1;
        }
        .location-item--facility5 {
            border-color: #ed64a6;
        }
        .location-item__header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .location-item__icon {
            font-size: 1.5rem;
        }
        .location-item__title {
            font-weight: bold;
            color: var(--text-color);
        }
        .location-item__details {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }
        .status-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }
        .status-badge--own {
            background: var(--primary-blue);
        }
        .status-badge--other {
            background: var(--success-green);
        }
        .status-badge--new {
            background: var(--warning-yellow);
        }
        .status-badge--bonded {
            background: var(--danger-red);
        }
        .status-badge--overseas {
            background: var(--warning-yellow);
        }
        /* Transport Arrows */
        .transport-arrows-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 0 1rem;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            padding: 1rem 0;
        }
        .transport-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .transport-icon {
            font-size: 2rem;
            background: var(--input-background);
            padding: 0.5rem;
            border-radius: 50%;
            border: 2px solid var(--primary-blue);
            position: relative;
        }
        .transport-details {
            background: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
            text-align: center;
            min-width: 120px;
            box-shadow: var(--shadow);
        }
        .transport-entity-badge {
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            margin-bottom: 0.3rem;
            background: var(--primary-blue);
            color: white;
        }
        .transport-info {
            line-height: 1.3;
            color: var(--text-color);
        }
        .route-count {
            font-size: 0.6rem;
            color: var(--primary-blue);
            font-weight: bold;
            margin-top: 0.2rem;
        }
        .arrow-line {
            position: absolute;
            height: 2px;
            background: var(--primary-blue);
            width: 100px;
            z-index: -1;
        }
        .arrow-line::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 8px solid var(--primary-blue);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        /* Custom Text Boxes */
        .custom-textbox {
            position: absolute;
            background: var(--input-background);
            border: 1px dashed var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            min-width: 100px;
            min-height: 50px;
            resize: both;
            overflow: auto;
            cursor: move;
        }
        .custom-textbox:focus {
            outline: 2px solid var(--primary-blue);
            border-style: solid;
        }
        /* Transport Configuration */
        .transport-config {
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        .transport-route {
            background: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .transport-route__header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .transport-mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .transport-mode-btn {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--button-background);
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.2rem;
        }
        .transport-mode-btn.active {
            background: var(--primary-blue);
            color: white;
        }
        .route-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        /* Debug Messages */
        .debug-message {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: var(--shadow);
            z-index: 1000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        .debug-message--success {
            background: var(--success-green);
            color: white;
        }
        .debug-message--error {
            background: var(--danger-red);
            color: white;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .input-panel {
                height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .header {
                padding: 1rem;
            }
            .header__controls {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .map-flow {
                flex-direction: column;
                min-height: auto;
            }
.map-flow::after {
content: '';
position: absolute;
top: 50%;
left: 0;
width: 100%;
height: 2px;
background: var(--primary-blue);
z-index: -1;
transform: translateY(-50%);
}
.map-flow::after::before {
content: '';
position: absolute;
right: -8px;
top: -4px;
width: 0;
height: 0;
border-left: 8px solid var(--primary-blue);
border-top: 4px solid transparent;
border-bottom: 4px solid transparent;
}
/* Responsive arrow for vertical flow */
@media (max-width: 768px) {
    .map-flow {
        flex-direction: column;
        min-height: auto;
    }
    .map-flow::after {
        width: 2px;
        height: 100%;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        bottom: auto;
        right: auto;
    }
    .map-flow::after::before {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 8px solid var(--primary-blue);
        top: auto;
        bottom: -8px;
        left: -4px;
        right: auto;
    }
}
            .location-column {
                max-width: 100%;
            }
            .transport-arrows-container {
                margin: 1rem 0;
                width: 100%;
            }
         
            .transport-arrow {
                margin: 0.5rem 0;
            }
        }
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Validation Styles */
        .form-input.error,
        .form-select.error {
            border-color: var(--danger-red);
            background-color: rgba(229, 62, 62, 0.1);
        }
        .error-message {
            color: var(--danger-red);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        /* File Upload Styles */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-upload-label {
            display: block;
            padding: 0.5rem;
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            text-align: center;
            background: var(--input-background);
            color: var(--text-color);
            transition: all 0.2s;
        }
        .file-upload:hover .file-upload-label {
            border-color: var(--primary-blue);
            background: rgba(49, 130, 206, 0.1);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header__title" data-translate="app-title">üöõ „É≠„Ç∏„Çπ„ÉÜ„Ç£„ÇØ„Çπ„Éû„ÉÉ„Éó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</h1>
        <div class="header__controls">
            <div class="language-switcher">
                <button class="language-btn active" onclick="switchLanguage('ja', this)" data-lang="ja">Êó•Êú¨Ë™û</button>
                <button class="language-btn" onclick="switchLanguage('en', this)" data-lang="en">English</button>
                <button class="language-btn" onclick="switchLanguage('zh', this)" data-lang="zh">‰∏≠Êñá</button>
            </div>
            <button class="theme-toggle" onclick="toggleDarkMode()" data-translate="toggle-theme">üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</button>
            <button class="export-btn" onclick="exportAsImage()" data-translate="export-image">üì∏ ÁîªÂÉèÂá∫Âäõ</button>
            <button class="export-btn" onclick="exportDataAsCSV()" data-translate="export-csv">üìä CSVÂá∫Âäõ</button>
        </div>
    </header>
    <div class="container">
        <aside class="input-panel">
            <!-- Facility1 Section -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="facility-1">ÊñΩË®≠1</span>
                    <button class="add-btn" onclick="addFacility1()" data-translate="add-facility">+ ËøΩÂä†</button>
                </div>
                <div class="section__content" id="facility1sContainer">
                    <!-- Facility1s will be added here -->
                </div>
            </section>
            <!-- Facility2 Section -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="facility-2">ÊñΩË®≠2</span>
                    <button class="add-btn" onclick="addFacility2()" data-translate="add-facility">+ ËøΩÂä†</button>
                </div>
                <div class="section__content" id="facility2sContainer">
                    <!-- Facility2s will be added here -->
                </div>
            </section>
            <!-- Facility3 Section -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="facility-3">ÊñΩË®≠3</span>
                    <button class="add-btn" onclick="addFacility3()" data-translate="add-facility">+ ËøΩÂä†</button>
                </div>
                <div class="section__content" id="facility3sContainer">
                    <!-- Facility3s will be added here -->
                </div>
            </section>
            <!-- Facility4 Section -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="facility-4">ÊñΩË®≠4</span>
                    <button class="add-btn" onclick="addFacility4()" data-translate="add-facility">+ ËøΩÂä†</button>
                </div>
                <div class="section__content" id="facility4sContainer">
                    <!-- Facility4s will be added here -->
                </div>
            </section>
            <!-- Facility5 Section -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="facility-5">ÊñΩË®≠5</span>
                    <button class="add-btn" onclick="addFacility5()" data-translate="add-facility">+ ËøΩÂä†</button>
                </div>
                <div class="section__content" id="facility5sContainer">
                    <!-- Facility5s will be added here -->
                </div>
            </section>
            <!-- Transport Configuration -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="transport-config">Ëº∏ÈÄÅË®≠ÂÆö</span>
                    <button class="add-btn" onclick="addTransportRoute()" data-translate="add-transport-route">+ Ëº∏ÈÄÅËøΩÂä†</button>
                </div>
                <div class="section__content" id="transportContainer">
                    <!-- Transport routes will be added here -->
                </div>
            </section>
            <!-- Data Management -->
            <section class="section">
                <div class="section__header">
                    <span data-translate="data-management">„Éá„Éº„ÇøÁÆ°ÁêÜ</span>
                </div>
                <div class="section__content">
                    <div class="form-group">
                        <label class="form-label" data-translate="import-csv">CSV „Ç§„É≥„Éù„Éº„Éà</label>
                        <div class="file-upload">
                            <input type="file" id="csvFileInput" accept=".csv" onchange="importDataFromCSV(event)">
                            <label for="csvFileInput" class="file-upload-label" data-translate="select-csv-file">CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
                        </div>
                    </div>
                    <button class="export-btn" onclick="downloadSampleTemplate()" style="width: 100%; margin-top: 1rem;" data-translate="download-template">üìã „Çµ„É≥„Éó„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà</button>
                </div>
            </section>
        </aside>
        <main class="map-panel">
            <div class="map-controls">
            </div>
            <div class="map-display" id="mapDisplay">
                <div class="map-flow" id="mapFlow">
                    <!-- Map content will be generated here -->
                    <div class="location-column" id="facility1sColumn">
                        <!-- Facility1s will be added here -->
                    </div>
                    <div class="location-column" id="facility2sColumn">
                        <!-- Facility2s will be added here -->
                    </div>
                    <div class="location-column" id="facility3sColumn">
                        <!-- Facility3s will be added here -->
                    </div>
                    <div class="location-column" id="facility4sColumn">
                        <!-- Facility4s will be added here -->
                    </div>
                    <div class="location-column" id="facility5sColumn">
                        <!-- Facility5s will be added here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Global State Management
        let globalState = {
            facility1s: new Map(),
            facility2s: new Map(),
            facility3s: new Map(),
            facility4s: new Map(),
            facility5s: new Map(),
            transportRoutes: new Map(),
            nextFacility1Id: 1,
            nextFacility2Id: 1,
            nextFacility3Id: 1,
            nextFacility4Id: 1,
            nextFacility5Id: 1,
            nextTransportId: 1,
            currentLanguage: 'ja'
        };
        // Translation System
        const translations = {
            ja: {
                'app-title': 'üöõ „É≠„Ç∏„Çπ„ÉÜ„Ç£„ÇØ„Çπ„Éû„ÉÉ„Éó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº',
                'toggle-theme': 'üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ',
                'export-image': 'üì∏ ÁîªÂÉèÂá∫Âäõ',
                'export-csv': 'üìä CSVÂá∫Âäõ',
                'facility-1': 'ÊñΩË®≠1',
                'facility-2': 'ÊñΩË®≠2',
                'facility-3': 'ÊñΩË®≠3',
                'facility-4': 'ÊñΩË®≠4',
                'facility-5': 'ÊñΩË®≠5',
                'add-facility': '+ ËøΩÂä†',
                'transport-config': 'Ëº∏ÈÄÅË®≠ÂÆö',
                'add-transport-route': '+ Ëº∏ÈÄÅËøΩÂä†',
                'from-location': 'Âá∫Áô∫Âú∞',
                'to-location': 'Âà∞ÁùÄÂú∞',
                'select-location': 'Â†¥ÊâÄ„ÇíÈÅ∏Êäû',
                'data-management': '„Éá„Éº„ÇøÁÆ°ÁêÜ',
                'import-csv': 'CSV „Ç§„É≥„Éù„Éº„Éà',
                'select-csv-file': 'CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû',
                'download-template': 'üìã „Çµ„É≥„Éó„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà',
                'to-warehouse': 'ÂÄâÂ∫´„Å∏',
                'to-destination': 'Á¥çÂÖ•ÂÖà„Å∏',
                'facility-name': 'ÊñΩË®≠Âêç',
                'location-type': 'ÊâÄÂú®Âú∞',
                'domestic': 'ÂõΩÂÜÖ',
                'overseas': 'Êµ∑Â§ñ',
                'country': 'ÂõΩ',
                'city': 'ÈÉΩÂ∏Ç',
                'remove': 'ÂâäÈô§',
                'is-warehouse': 'ÂÄâÂ∫´',
                'warehouse-type': 'ÂÄâÂ∫´Á®ÆÂà•',
                'general-warehouse': '‰∏ÄËà¨ÂÄâÂ∫´',
                'bonded-warehouse': '‰øùÁ®éÂÄâÂ∫´',
                'operating-entity': 'ÈÅãÂñ∂‰∏ª‰Ωì',
                'own-company': 'NX',
                'other-company': '‰ªñÁ§æ',
                'new': 'Êñ∞Ë¶è',
                'temperature-control': 'Ê∏©ÊπøÂ∫¶ÁÆ°ÁêÜ',
                'temperature': 'Ê∏©Â∫¶',
                'humidity': 'ÊπøÂ∫¶',
                'work-content': '‰ΩúÊ•≠ÂÜÖÂÆπ',
                'transport-mode': 'Ëº∏ÈÄÅ„É¢„Éº„Éâ',
                'departure': 'Âá∫Áô∫Âú∞',
                'arrival': 'Âà∞ÁùÄÂú∞',
                'frequency': 'È†ªÂ∫¶',
                'package-type': 'Ëç∑Âßø',
                'volume': 'Êï∞Èáè',
                'truck': '„Éà„É©„ÉÉ„ÇØ',
                'ship': 'Êµ∑ÈÅã',
                'air': 'Ëà™Á©∫',
                'rail': 'ÈâÑÈÅì',
                'transport-operating-entity': 'Ëº∏ÈÄÅÈÅãÂñ∂‰∏ª‰Ωì',
                'transport-entity-name': 'ÈÅãÂñ∂‰∏ª‰ΩìÂêç',
                'transport-details': 'Ëº∏ÈÄÅË©≥Á¥∞',
                'nx-transport': 'NX Ëº∏ÈÄÅ',
                'other-transport': '‰ªñÁ§æËº∏ÈÄÅ',
                'new-transport': 'Êñ∞Ë¶è',
                'custom-transport': '„Ç´„Çπ„Çø„É†',
                'custom-entity-name': '„Ç´„Çπ„Çø„É†ÈÅãÂñ∂‰∏ª‰ΩìÂêç',
                'icon': '„Ç¢„Ç§„Ç≥„É≥'
            },
            en: {
                'app-title': 'üöõ Logistics Map Generator',
                'toggle-theme': 'üåô Dark Mode',
                'export-image': 'üì∏ Export Image',
                'export-csv': 'üìä Export CSV',
                'facility-1': 'Facility 1',
                'facility-2': 'Facility 2',
                'facility-3': 'Facility 3',
                'facility-4': 'Facility 4',
                'facility-5': 'Facility 5',
                'add-facility': '+ Add',
                'transport-config': 'Transport Config',
                'add-transport-route': '+ Add Route',
                'from-location': 'From Location',
                'to-location': 'To Location',
                'select-location': 'Select Location',
                'data-management': 'Data Management',
                'import-csv': 'CSV Import',
                'select-csv-file': 'Select CSV File',
                'download-template': 'üìã Sample Template',
                'to-warehouse': 'To Warehouse',
                'to-destination': 'To Destination',
                'facility-name': 'Facility Name',
                'location-type': 'Location Type',
                'domestic': 'Domestic',
                'overseas': 'Overseas',
                'country': 'Country',
                'city': 'City',
                'remove': 'Remove',
                'is-warehouse': 'Warehouse',
                'warehouse-type': 'Warehouse Type',
                'general-warehouse': 'General Warehouse',
                'bonded-warehouse': 'Bonded Warehouse',
                'operating-entity': 'Operating Entity',
                'own-company': 'by NX',
                'other-company': 'Other Company',
                'new': 'New',
                'temperature-control': 'Temperature Control',
                'temperature': 'Temperature',
                'humidity': 'Humidity',
                'work-content': 'Work Content',
                'transport-mode': 'Transport Mode',
                'departure': 'Departure',
                'arrival': 'Arrival',
                'frequency': 'Frequency',
                'package-type': 'Package Type',
                'volume': 'Volume',
                'truck': 'Truck',
                'ship': 'Ship',
                'air': 'Air',
                'rail': 'Rail',
                'transport-operating-entity': 'Transport Entity',
                'transport-entity-name': 'Entity Name',
                'transport-details': 'Transport Details',
                'nx-transport': 'NX Transport',
                'other-transport': 'Other Transport',
                'new-transport': 'New',
                'custom-transport': 'Custom',
                'custom-entity-name': 'Custom Entity Name',
                'icon': 'Icon'
            },
            zh: {
                'app-title': 'üöõ Áâ©ÊµÅÂú∞ÂõæÁîüÊàêÂô®',
                'toggle-theme': 'üåô Ê∑±Ëâ≤Ê®°Âºè',
                'export-image': 'üì∏ ÂØºÂá∫ÂõæÁâá',
                'export-csv': 'üìä ÂØºÂá∫CSV',
                'facility-1': 'ËÆæÊñΩ1',
                'facility-2': 'ËÆæÊñΩ2',
                'facility-3': 'ËÆæÊñΩ3',
                'facility-4': 'ËÆæÊñΩ4',
                'facility-5': 'ËÆæÊñΩ5',
                'add-facility': '+ Ê∑ªÂä†',
                'transport-config': 'ËøêËæìÈÖçÁΩÆ',
                'add-transport-route': '+ Ê∑ªÂä†Ë∑ØÁ∫ø',
                'from-location': 'Âá∫ÂèëÂú∞',
                'to-location': 'ÁõÆÁöÑÂú∞',
                'select-location': 'ÈÄâÊã©Âú∞ÁÇπ',
                'data-management': 'Êï∞ÊçÆÁÆ°ÁêÜ',
                'import-csv': 'CSVÂØºÂÖ•',
                'select-csv-file': 'ÈÄâÊã©CSVÊñá‰ª∂',
                'download-template': 'üìã Á§∫‰æãÊ®°Êùø',
                'to-warehouse': 'Âà∞‰ªìÂ∫ì',
                'to-destination': 'Âà∞ÁõÆÁöÑÂú∞',
                'facility-name': 'ËÆæÊñΩÂêçÁß∞',
                'location-type': '‰ΩçÁΩÆÁ±ªÂûã',
                'domestic': 'ÂõΩÂÜÖ',
                'overseas': 'Êµ∑Â§ñ',
                'country': 'ÂõΩÂÆ∂',
                'city': 'ÂüéÂ∏Ç',
                'remove': 'Âà†Èô§',
                'is-warehouse': '‰ªìÂ∫ì',
                'warehouse-type': '‰ªìÂ∫ìÁ±ªÂûã',
                'general-warehouse': 'ÊôÆÈÄö‰ªìÂ∫ì',
                'bonded-warehouse': '‰øùÁ®é‰ªìÂ∫ì',
                'operating-entity': 'ËøêËê•‰∏ª‰Ωì',
                'own-company': 'by NX',
                'other-company': '‰ªñËê•',
                'new': 'Êñ∞Âª∫',
                'temperature-control': 'Ê∏©ÊπøÂ∫¶ÊéßÂà∂',
                'temperature': 'Ê∏©Â∫¶',
                'humidity': 'ÊπøÂ∫¶',
                'work-content': 'Â∑•‰ΩúÂÜÖÂÆπ',
                'transport-mode': 'ËøêËæìÊñπÂºè',
                'departure': 'Âá∫ÂèëÂú∞',
                'arrival': 'Âà∞ËææÂú∞',
                'frequency': 'È¢ëÁéá',
                'package-type': 'ÂåÖË£ÖÁ±ªÂûã',
                'volume': 'Êï∞Èáè',
                'truck': 'Âç°ËΩ¶',
                'ship': 'ËàπËøê',
                'air': 'Ëà™Á©∫',
                'rail': 'ÈìÅË∑Ø',
                'transport-operating-entity': 'ËøêËæì‰∏ª‰Ωì',
                'transport-entity-name': '‰∏ª‰ΩìÂêçÁß∞',
                'transport-details': 'ËøêËæìËØ¶ÊÉÖ',
                'nx-transport': 'NX ËøêËæì',
                'other-transport': 'ÂÖ∂‰ªñËøêËæì',
                'new-transport': 'Êñ∞Âª∫',
                'custom-transport': 'Ëá™ÂÆö‰πâ',
                'custom-entity-name': 'Ëá™ÂÆö‰πâ‰∏ª‰ΩìÂêçÁß∞',
                'icon': 'ÂõæÊ†á'
            }
        };
        // Transport Icons and Configuration
        const transportIcons = {
            truck: 'üöõ',
            ship: 'üö¢',
            air: '‚úàÔ∏è',
            rail: 'üöÜ'
        };
        const facilityIcons = ['üè≠', 'üè¢', 'üè™', 'üèõÔ∏è', 'üè¨', 'üèóÔ∏è', 'üè†', 'üè•', 'üì¶', 'üöö', 'üö¢', '‚úàÔ∏è', 'üöÜ', 'üõ≥Ô∏è', 'üõí', 'üõçÔ∏è', 'ü¶Ω'];
        // Language Switching
        function switchLanguage(lang, buttonElement) {
            globalState.currentLanguage = lang;
         
            // Update active button
            document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('active'));
            buttonElement.classList.add('active');
         
            // Update all translatable elements
            updateTranslations();
         
            showDebugMessage(`Language switched to ${lang}`);
        }
        function updateTranslations() {
            const currentTranslations = translations[globalState.currentLanguage];
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (currentTranslations[key]) {
                    if (element.tagName === 'INPUT' && element.type === 'button') {
                        element.value = currentTranslations[key];
                    } else {
                        element.textContent = currentTranslations[key];
                    }
                }
            });
        }
        // Theme Management
        function toggleDarkMode() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
         
            const themeButton = document.querySelector('.theme-toggle');
            themeButton.textContent = newTheme === 'dark' ? '‚òÄÔ∏è „É©„Ç§„Éà„É¢„Éº„Éâ' : 'üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ';
         
            showDebugMessage(`Theme switched to ${newTheme} mode`);
        }
        // Common Facility Management
        function addFacility(facilityType) {
            const nextIdKey = `nextFacility${facilityType}Id`;
            const facilityId = globalState[nextIdKey]++;
            const defaultIcon = facilityType === 1 ? 'üè≠' : facilityType === 2 ? 'üè¢' : facilityType === 3 ? 'üè™' : facilityType === 4 ? 'üèõÔ∏è' : 'üè¨';
            const facilityData = {
                id: facilityId,
                name: '',
                locationType: 'domestic',
                country: '',
                city: '',
                icon: defaultIcon,
                isWarehouse: false,
                warehouseType: 'general',
                operatingEntity: 'own',
                hasTemperatureControl: false,
                temperature: '',
                humidity: '',
                workContent: ''
            };
         
            globalState[`facility${facilityType}s`].set(facilityId, facilityData);
            renderFacilityForm(facilityType, facilityData);
            generateMap();
        }
        function renderFacilityForm(facilityType, facilityData) {
            const container = document.getElementById(`facility${facilityType}sContainer`);
            const facilityDiv = document.createElement('div');
            facilityDiv.className = `location-box location-box--${facilityData.locationType}`;
            facilityDiv.id = `facility${facilityType}-${facilityData.id}`;
         
            facilityDiv.innerHTML = `
                <div class="location-box__header">
                    <span class="location-box__title" data-translate="facility-${facilityType}">ÊñΩË®≠${facilityType}</span>
                    <button class="remove-btn" onclick="removeFacility(${facilityType}, ${facilityData.id})" data-translate="remove">ÂâäÈô§</button>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="facility-name">ÊñΩË®≠Âêç</label>
                    <input type="text" class="form-input" value="${facilityData.name}"
                           oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'name', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="location-type">ÊâÄÂú®Âú∞</label>
                    <select class="form-select" onchange="updateFacilityData(${facilityType}, ${facilityData.id}, 'locationType', this.value)">
                        <option value="domestic" ${facilityData.locationType === 'domestic' ? 'selected' : ''} data-translate="domestic">ÂõΩÂÜÖ</option>
                        <option value="overseas" ${facilityData.locationType === 'overseas' ? 'selected' : ''} data-translate="overseas">Êµ∑Â§ñ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="country">ÂõΩ</label>
                    <input type="text" class="form-input" value="${facilityData.country}"
                           oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'country', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="city">ÈÉΩÂ∏Ç</label>
                    <input type="text" class="form-input" value="${facilityData.city}"
                           oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'city', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="icon">„Ç¢„Ç§„Ç≥„É≥</label>
                    <select class="form-select" onchange="updateFacilityData(${facilityType}, ${facilityData.id}, 'icon', this.value)">
                        ${facilityIcons.map(icon => `<option value="${icon}" ${facilityData.icon === icon ? 'selected' : ''}>${icon}</option>`).join('')}
                    </select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isWarehouse-${facilityType}-${facilityData.id}" ${facilityData.isWarehouse ? 'checked' : ''}
                           onchange="toggleWarehouseOptions(${facilityType}, ${facilityData.id})">
                    <label for="isWarehouse-${facilityType}-${facilityData.id}" data-translate="is-warehouse">ÂÄâÂ∫´</label>
                </div>
                <div class="warehouse-options ${facilityData.isWarehouse ? 'warehouse-options--visible' : ''}" id="warehouseOptions-${facilityType}-${facilityData.id}">
                    <div class="form-group">
                        <label class="form-label" data-translate="warehouse-type">ÂÄâÂ∫´Á®ÆÂà•</label>
                        <div class="warehouse-type-selector">
                            <button class="warehouse-type-btn ${facilityData.warehouseType === 'general' ? 'active' : ''}"
                                    onclick="updateFacilityData(${facilityType}, ${facilityData.id}, 'warehouseType', 'general')" data-translate="general-warehouse">‰∏ÄËà¨ÂÄâÂ∫´</button>
                            <button class="warehouse-type-btn ${facilityData.warehouseType === 'bonded' ? 'active' : ''}"
                                    onclick="updateFacilityData(${facilityType}, ${facilityData.id}, 'warehouseType', 'bonded')" data-translate="bonded-warehouse">‰øùÁ®éÂÄâÂ∫´</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="operating-entity">ÈÅãÂñ∂‰∏ª‰Ωì</label>
                        <div class="operating-entity-selector">
                            <button class="entity-btn entity-btn--own ${facilityData.operatingEntity === 'own' ? 'active' : ''}"
                                    onclick="updateFacilityData(${facilityType}, ${facilityData.id}, 'operatingEntity', 'own')" data-translate="own-company">by NX</button>
                            <button class="entity-btn entity-btn--other ${facilityData.operatingEntity === 'other' ? 'active' : ''}"
                                    onclick="updateFacilityData(${facilityType}, ${facilityData.id}, 'operatingEntity', 'other')" data-translate="other-company">‰ªñÁ§æ</button>
                            <button class="entity-btn entity-btn--new ${facilityData.operatingEntity === 'new' ? 'active' : ''}"
                                    onclick="updateFacilityData(${facilityType}, ${facilityData.id}, 'operatingEntity', 'new')" data-translate="new">Êñ∞Ë¶è</button>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tempControl-${facilityType}-${facilityData.id}" ${facilityData.hasTemperatureControl ? 'checked' : ''}
                               onchange="toggleTempControl(${facilityType}, ${facilityData.id})">
                        <label for="tempControl-${facilityType}-${facilityData.id}" data-translate="temperature-control">Ê∏©ÊπøÂ∫¶ÁÆ°ÁêÜ</label>
                    </div>
                    <div class="warehouse-options ${facilityData.hasTemperatureControl ? 'warehouse-options--visible' : ''}" id="tempOptions-${facilityType}-${facilityData.id}">
                        <div class="form-group">
                            <label class="form-label" data-translate="temperature">Ê∏©Â∫¶</label>
                            <input type="text" class="form-input" value="${facilityData.temperature}"
                                   oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'temperature', this.value)" placeholder="15-25¬∞C">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="humidity">ÊπøÂ∫¶</label>
                            <input type="text" class="form-input" value="${facilityData.humidity}"
                                   oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'humidity', this.value)" placeholder="40-60%">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="work-content">‰ΩúÊ•≠ÂÜÖÂÆπ</label>
                        <textarea class="form-textarea" oninput="updateFacilityData(${facilityType}, ${facilityData.id}, 'workContent', this.value)">${facilityData.workContent}</textarea>
                    </div>
                </div>
            `;
         
            container.appendChild(facilityDiv);
            updateTranslations();
        }
        function updateFacilityData(facilityType, id, field, value) {
            const facility = globalState[`facility${facilityType}s`].get(id);
            if (facility) {
                facility[field] = value;
             
                // Update border color based on location type
                const facilityDiv = document.getElementById(`facility${facilityType}-${id}`);
                facilityDiv.className = `location-box location-box--${facility.locationType}`;
             
                // Update button states if applicable
                if (field === 'warehouseType') {
                    facilityDiv.querySelectorAll('.warehouse-type-btn').forEach(btn => btn.classList.remove('active'));
                    facilityDiv.querySelector(`[onclick*="'${value}'"]`).classList.add('active');
                } else if (field === 'operatingEntity') {
                    facilityDiv.querySelectorAll('.entity-btn').forEach(btn => btn.classList.remove('active'));
                    facilityDiv.querySelector(`[onclick*="'${value}'"]`).classList.add('active');
                }
             
                generateMap();
                validateInput(`facility${facilityType}`, id);
            }
        }
        function toggleWarehouseOptions(facilityType, id) {
            const facility = globalState[`facility${facilityType}s`].get(id);
            if (facility) {
                facility.isWarehouse = !facility.isWarehouse;
                const warehouseOptions = document.getElementById(`warehouseOptions-${facilityType}-${id}`);
                warehouseOptions.classList.toggle('warehouse-options--visible', facility.isWarehouse);
                generateMap();
            }
        }
        function toggleTempControl(facilityType, id) {
            const facility = globalState[`facility${facilityType}s`].get(id);
            if (facility) {
                facility.hasTemperatureControl = !facility.hasTemperatureControl;
                const tempOptions = document.getElementById(`tempOptions-${facilityType}-${id}`);
                tempOptions.classList.toggle('warehouse-options--visible', facility.hasTemperatureControl);
                generateMap();
            }
        }
        function removeFacility(facilityType, id) {
            globalState[`facility${facilityType}s`].delete(id);
            const facilityDiv = document.getElementById(`facility${facilityType}-${id}`);
            facilityDiv.remove();
            generateMap();
        }
        // Wrapper functions for each facility type
        function addFacility1() { addFacility(1); }
        function addFacility2() { addFacility(2); }
        function addFacility3() { addFacility(3); }
        function addFacility4() { addFacility(4); }
        function addFacility5() { addFacility(5); }
        // Map Generation
        function generateMap() {
            const facility1sColumn = document.getElementById('facility1sColumn');
            const facility2sColumn = document.getElementById('facility2sColumn');
            const facility3sColumn = document.getElementById('facility3sColumn');
            const facility4sColumn = document.getElementById('facility4sColumn');
            const facility5sColumn = document.getElementById('facility5sColumn');
            const mapFlow = document.getElementById('mapFlow');
         
            // Clear existing content
            facility1sColumn.innerHTML = '';
            facility2sColumn.innerHTML = '';
            facility3sColumn.innerHTML = '';
            facility4sColumn.innerHTML = '';
            facility5sColumn.innerHTML = '';
         
            // Remove existing transport arrows and containers
            mapFlow.querySelectorAll('.transport-arrow, .transport-arrows-container').forEach(element => element.remove());
         
            // Add facility1s
            globalState.facility1s.forEach(facility => {
                const facilityItem = createLocationItem('facility1', facility);
                facility1sColumn.appendChild(facilityItem);
            });
         
            // Add facility2s
            globalState.facility2s.forEach(facility => {
                const facilityItem = createLocationItem('facility2', facility);
                facility2sColumn.appendChild(facilityItem);
            });
         
            // Add facility3s
            globalState.facility3s.forEach(facility => {
                const facilityItem = createLocationItem('facility3', facility);
                facility3sColumn.appendChild(facilityItem);
            });
         
            // Add facility4s
            globalState.facility4s.forEach(facility => {
                const facilityItem = createLocationItem('facility4', facility);
                facility4sColumn.appendChild(facilityItem);
            });
         
            // Add facility5s
            globalState.facility5s.forEach(facility => {
                const facilityItem = createLocationItem('facility5', facility);
                facility5sColumn.appendChild(facilityItem);
            });
         
            // Add individual transport arrows for each route
            addIndividualTransportArrows();
         
            updateTranslations();
            generateTransportForms();
        }
        function addIndividualTransportArrows() {
            const mapFlow = document.getElementById('mapFlow');
            const facility2sColumn = document.getElementById('facility2sColumn');
            const facility3sColumn = document.getElementById('facility3sColumn');
            const facility4sColumn = document.getElementById('facility4sColumn');
            const facility5sColumn = document.getElementById('facility5sColumn');
         
            // Group routes by direction for vertical stacking
            const facility1To2Routes = [];
            const facility2To3Routes = [];
            const facility3To4Routes = [];
            const facility4To5Routes = [];
            const otherRoutes = [];
         
            globalState.transportRoutes.forEach(route => {
                if (route.fromType && route.toType && route.fromId && route.toId) {
                    if (route.fromType === 'facility1' && route.toType === 'facility2') {
                        facility1To2Routes.push(route);
                    } else if (route.fromType === 'facility2' && route.toType === 'facility3') {
                        facility2To3Routes.push(route);
                    } else if (route.fromType === 'facility3' && route.toType === 'facility4') {
                        facility3To4Routes.push(route);
                    } else if (route.fromType === 'facility4' && route.toType === 'facility5') {
                        facility4To5Routes.push(route);
                    } else {
                        otherRoutes.push(route);
                    }
                }
            });
         
            // Create vertical container for facility1 to facility2 routes
            if (facility1To2Routes.length > 0) {
                const container = createTransportArrowsContainer();
                facility1To2Routes.forEach(route => {
                    const arrow = createIndividualTransportArrow(route);
                    container.appendChild(arrow);
                });
                mapFlow.insertBefore(container, facility2sColumn);
            }
         
            // Create vertical container for facility2 to facility3 routes
            if (facility2To3Routes.length > 0) {
                const container = createTransportArrowsContainer();
                facility2To3Routes.forEach(route => {
                    const arrow = createIndividualTransportArrow(route);
                    container.appendChild(arrow);
                });
                mapFlow.insertBefore(container, facility3sColumn);
            }
         
            // Create vertical container for facility3 to facility4 routes
            if (facility3To4Routes.length > 0) {
                const container = createTransportArrowsContainer();
                facility3To4Routes.forEach(route => {
                    const arrow = createIndividualTransportArrow(route);
                    container.appendChild(arrow);
                });
                mapFlow.insertBefore(container, facility4sColumn);
            }
         
            // Create vertical container for facility4 to facility5 routes
            if (facility4To5Routes.length > 0) {
                const container = createTransportArrowsContainer();
                facility4To5Routes.forEach(route => {
                    const arrow = createIndividualTransportArrow(route);
                    container.appendChild(arrow);
                });
                mapFlow.insertBefore(container, facility5sColumn);
            }
         
            // Add other routes at the end
            otherRoutes.forEach(route => {
                const container = createTransportArrowsContainer();
                const arrow = createIndividualTransportArrow(route);
                container.appendChild(arrow);
                mapFlow.appendChild(container);
            });
        }
        function createTransportArrowsContainer() {
            const container = document.createElement('div');
            container.className = 'transport-arrows-container';
            return container;
        }
        function createIndividualTransportArrow(route) {
            const arrow = document.createElement('div');
            arrow.className = 'transport-arrow';
         
            const transportIcon = transportIcons[route.mode] || 'üöõ';
         
            // Build transport info for this specific route
            let transportInfo = '';
            let entityBadge = '';
         
            // Handle different entity types
            if (route.operatingEntity) {
                let entityText = route.operatingEntity;
                if (route.operatingEntity === 'nx') {
                    entityText = translations[globalState.currentLanguage]['nx-transport'] || 'NX Ëº∏ÈÄÅ';
                } else if (route.operatingEntity === 'other') {
                    entityText = translations[globalState.currentLanguage]['other-transport'] || '‰ªñÁ§æËº∏ÈÄÅ';
                } else if (route.operatingEntity === 'new') {
                    entityText = translations[globalState.currentLanguage]['new-transport'] || 'Êñ∞Ë¶è';
                } else if (route.operatingEntity === 'custom' && route.customEntityName) {
                    entityText = route.customEntityName;
                }
             
                entityBadge = `<div class="transport-entity-badge">${entityText}</div>`;
            }
         
            const details = [];
            if (route.departure) details.push(`üìç ${route.departure}`);
            if (route.arrival) details.push(`üéØ ${route.arrival}`);
            if (route.frequency) details.push(`üìÖ ${route.frequency}`);
            if (route.packageType) details.push(`üì¶ ${route.packageType}`);
            if (route.volume) details.push(`üìä ${route.volume}`);
         
            if (details.length > 0) {
                transportInfo = details.join('<br>');
            } else {
                // Fallback for empty routes
                transportInfo = translations[globalState.currentLanguage]['transport-details'] || 'Ëº∏ÈÄÅË©≥Á¥∞';
            }
         
            // Get route names for display
            let fromName = 'Âá∫Áô∫Âú∞';
            let toName = 'Âà∞ÁùÄÂú∞';
         
            if (route.fromType && route.fromId) {
                const fromData = globalState[`${route.fromType}s`].get(route.fromId);
                if (fromData) {
                    fromName = fromData.name || `${route.fromType} ${route.fromId}`;
                }
            }
         
            if (route.toType && route.toId) {
                const toData = globalState[`${route.toType}s`].get(route.toId);
                if (toData) {
                    toName = toData.name || `${route.toType} ${route.toId}`;
                }
            }
         
            arrow.innerHTML = `
                <div class="arrow-line"></div>
                <div class="transport-icon">${transportIcon}</div>
                <div class="transport-details">
                    ${entityBadge}
                    <div class="transport-route-title" style="font-weight: bold; margin-bottom: 0.3rem; color: var(--primary-blue);">
                        ${fromName} ‚Üí ${toName}
                    </div>
                    <div class="transport-info">${transportInfo}</div>
                </div>
            `;
         
            return arrow;
        }
        function createLocationItem(type, data) {
            const item = document.createElement('div');
            item.className = `location-item location-item--${type}`;
            item.id = `map-${type}-${data.id}`;
         
            let icon = data.icon;
            let statusBadge = '';
            let details = `${data.country || ''} ${data.city || ''}`.trim();
         
            // Overseas badge on left top
            let overseasBadge = '';
            if (data.locationType === 'overseas') {
                overseasBadge = '<div class="status-badge status-badge--overseas" style="top: -8px;">Êµ∑Â§ñ</div>';
            }
         
            if (data.isWarehouse) {
                // Operating entity badge
                if (data.operatingEntity) {
                    const entityText = translations[globalState.currentLanguage][data.operatingEntity + '-company'] || data.operatingEntity;
                    statusBadge = `<div class="status-badge status-badge--${data.operatingEntity}">${entityText}</div>`;
                }
             
                // Bonded warehouse badge
                if (data.warehouseType === 'bonded') {
                    statusBadge += '<div class="status-badge status-badge--bonded" style="top: 20px;">‰øùÁ®é</div>';
                }
             
                // Warehouse type indicator
                const warehouseTypeText = data.warehouseType === 'bonded' ?
                    (translations[globalState.currentLanguage]['bonded-warehouse'] || '‰øùÁ®éÂÄâÂ∫´') :
                    (translations[globalState.currentLanguage]['general-warehouse'] || '‰∏ÄËà¨ÂÄâÂ∫´');
                details += `<br>üè∑Ô∏è ${warehouseTypeText}`;
             
                // Enhanced details for warehouse
                if (data.hasTemperatureControl && data.temperature) {
                    details += `<br>üå°Ô∏è ${data.temperature}`;
                    if (data.humidity) details += `  <br>üíß ${data.humidity}`;
                }
             
                if (data.workContent && data.workContent.trim()) {
                    details += `<br>üìã ${data.workContent}`;
                }
            }
         
            item.innerHTML = `
                ${overseasBadge}${statusBadge}
                <div class="location-item__header">
                    <span class="location-item__icon">${icon}</span>
                    <span class="location-item__title">${data.name || `${type} ${data.id}`}</span>
                </div>
                <div class="location-item__details">${details}</div>
            `;
         
            return item;
        }
        // Transport Configuration
        function addTransportRoute() {
            const container = document.getElementById('transportContainer');
            const routeId = globalState.nextTransportId++;
         
            // Create new transport route data
            const transportData = {
                id: routeId,
                fromType: '',
                fromId: '',
                toType: '',
                toId: '',
                mode: 'truck',
                operatingEntity: 'nx',
                customEntityName: '',
                departure: '',
                arrival: '',
                frequency: '',
                packageType: '',
                volume: ''
            };
         
            globalState.transportRoutes.set(routeId, transportData);
         
            const routeDiv = createManualTransportRoute(transportData);
            container.appendChild(routeDiv);
            updateTranslations();
        }
        function createManualTransportRoute(transportData) {
            const routeDiv = document.createElement('div');
            routeDiv.className = 'transport-route';
            routeDiv.id = `transport-route-${transportData.id}`;
         
            routeDiv.innerHTML = `
                <div class="transport-route__header">
                    <span>${transportIcons[transportData.mode]}</span>
                    <span id="route-title-${transportData.id}">Êñ∞Ë¶èËº∏ÈÄÅ„É´„Éº„Éà</span>
                    <button class="remove-btn" onclick="removeTransportRoute(${transportData.id})" data-translate="remove">ÂâäÈô§</button>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="from-location">Âá∫Áô∫Âú∞</label>
                    <select class="form-select" onchange="updateTransportLocation(${transportData.id}, 'from', this.value)">
                        <option value="" data-translate="select-location">Â†¥ÊâÄ„ÇíÈÅ∏Êäû</option>
                        ${generateLocationOptions('from')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="to-location">Âà∞ÁùÄÂú∞</label>
                    <select class="form-select" onchange="updateTransportLocation(${transportData.id}, 'to', this.value)">
                        <option value="" data-translate="select-location">Â†¥ÊâÄ„ÇíÈÅ∏Êäû</option>
                        ${generateLocationOptions('to')}
                    </select>
                </div>
                <div class="transport-mode-selector">
                    ${Object.entries(transportIcons).map(([mode, icon]) => `
                        <button class="transport-mode-btn ${mode === transportData.mode ? 'active' : ''}"
                                onclick="selectTransportMode(this, '${mode}', ${transportData.id})">${icon}</button>
                    `).join('')}
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="transport-operating-entity">Ëº∏ÈÄÅÈÅãÂñ∂‰∏ª‰Ωì</label>
                    <select class="form-select" onchange="updateTransportEntityType(${transportData.id}, this.value)">
                        <option value="nx" ${transportData.operatingEntity === 'nx' ? 'selected' : ''} data-translate="nx-transport">NX Ëº∏ÈÄÅ</option>
                        <option value="other" ${transportData.operatingEntity === 'other' ? 'selected' : ''} data-translate="other-transport">‰ªñÁ§æËº∏ÈÄÅ</option>
                        <option value="new" ${transportData.operatingEntity === 'new' ? 'selected' : ''} data-translate="new-transport">Êñ∞Ë¶è</option>
                        <option value="custom" ${transportData.operatingEntity === 'custom' ? 'selected' : ''} data-translate="custom-transport">„Ç´„Çπ„Çø„É†</option>
                    </select>
                </div>
                <div class="custom-entity-input ${transportData.operatingEntity === 'custom' ? 'custom-entity-input--visible' : ''}" id="custom-entity-${transportData.id}">
                    <div class="form-group">
                        <label class="form-label" data-translate="custom-entity-name">„Ç´„Çπ„Çø„É†ÈÅãÂñ∂‰∏ª‰ΩìÂêç</label>
                        <input type="text" class="form-input" placeholder="„Ç´„Çπ„Çø„É†ÈÅãÂñ∂‰∏ª‰ΩìÂêç„ÇíÂÖ•Âäõ" value="${transportData.customEntityName || ''}"
                               oninput="updateTransportData(${transportData.id}, 'customEntityName', this.value)">
                    </div>
                </div>
                <div class="route-details">
                    <div class="form-group">
                        <label class="form-label" data-translate="departure">Âá∫Áô∫Âú∞</label>
                        <input type="text" class="form-input" placeholder="Port/Station" value="${transportData.departure}"
                               oninput="updateTransportData(${transportData.id}, 'departure', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="arrival">Âà∞ÁùÄÂú∞</label>
                        <input type="text" class="form-input" placeholder="Port/Station" value="${transportData.arrival}"
                               oninput="updateTransportData(${transportData.id}, 'arrival', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="frequency">È†ªÂ∫¶</label>
                        <input type="text" class="form-input" placeholder="Daily/Weekly" value="${transportData.frequency}"
                               oninput="updateTransportData(${transportData.id}, 'frequency', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="package-type">Ëç∑Âßø</label>
                        <input type="text" class="form-input" placeholder="Container/Pallet" value="${transportData.packageType}"
                               oninput="updateTransportData(${transportData.id}, 'packageType', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="volume">Êï∞Èáè</label>
                        <input type="text" class="form-input" placeholder="Volume/Weight" value="${transportData.volume}"
                               oninput="updateTransportData(${transportData.id}, 'volume', this.value)">
                    </div>
                </div>
            `;
         
            return routeDiv;
        }
        function generateLocationOptions(direction) {
            let options = '';
         
            // Add facility1s
            globalState.facility1s.forEach(facility => {
                options += `<option value="facility1-${facility.id}">ÊñΩË®≠1: ${facility.name || `ÊñΩË®≠1 ${facility.id}`}</option>`;
            });
         
            // Add facility2s
            globalState.facility2s.forEach(facility => {
                options += `<option value="facility2-${facility.id}">ÊñΩË®≠2: ${facility.name || `ÊñΩË®≠2 ${facility.id}`}</option>`;
            });
         
            // Add facility3s
            globalState.facility3s.forEach(facility => {
                options += `<option value="facility3-${facility.id}">ÊñΩË®≠3: ${facility.name || `ÊñΩË®≠3 ${facility.id}`}</option>`;
            });
         
            // Add facility4s
            globalState.facility4s.forEach(facility => {
                options += `<option value="facility4-${facility.id}">ÊñΩË®≠4: ${facility.name || `ÊñΩË®≠4 ${facility.id}`}</option>`;
            });
         
            // Add facility5s
            globalState.facility5s.forEach(facility => {
                options += `<option value="facility5-${facility.id}">ÊñΩË®≠5: ${facility.name || `ÊñΩË®≠5 ${facility.id}`}</option>`;
            });
         
            return options;
        }
        function updateTransportLocation(routeId, direction, locationValue) {
            const transportData = globalState.transportRoutes.get(routeId);
            if (!transportData || !locationValue) return;
         
            const [locationType, locationId] = locationValue.split('-');
         
            if (direction === 'from') {
                transportData.fromType = locationType;
                transportData.fromId = parseInt(locationId);
            } else {
                transportData.toType = locationType;
                transportData.toId = parseInt(locationId);
            }
         
            // Update route title
            updateRouteTitle(routeId);
            generateMap();
        }
        function updateTransportEntityType(routeId, entityType) {
            const transportData = globalState.transportRoutes.get(routeId);
            if (!transportData) return;
         
            transportData.operatingEntity = entityType;
         
            // Show/hide custom input field
            const customInput = document.getElementById(`custom-entity-${routeId}`);
            if (customInput) {
                customInput.classList.toggle('custom-entity-input--visible', entityType === 'custom');
            }
         
            generateMap();
        }
        function updateRouteTitle(routeId) {
            const transportData = globalState.transportRoutes.get(routeId);
            if (!transportData) return;
         
            let fromName = 'Êú™ÈÅ∏Êäû';
            let toName = 'Êú™ÈÅ∏Êäû';
         
            // Get from location name
            if (transportData.fromType && transportData.fromId) {
                const fromData = globalState[`${transportData.fromType}s`].get(transportData.fromId);
                if (fromData) {
                    fromName = fromData.name || `${transportData.fromType} ${transportData.fromId}`;
                }
            }
         
            // Get to location name
            if (transportData.toType && transportData.toId) {
                const toData = globalState[`${transportData.toType}s`].get(transportData.toId);
                if (toData) {
                    toName = toData.name || `${transportData.toType} ${transportData.toId}`;
                }
            }
         
            const titleElement = document.getElementById(`route-title-${routeId}`);
            if (titleElement) {
                titleElement.textContent = `${fromName} ‚Üí ${toName}`;
            }
        }
        function removeTransportRoute(routeId) {
            globalState.transportRoutes.delete(routeId);
            const routeDiv = document.getElementById(`transport-route-${routeId}`);
            if (routeDiv) {
                routeDiv.remove();
            }
            generateMap();
        }
        function generateTransportForms() {
            const container = document.getElementById('transportContainer');
         
            // Keep manually added routes, only remove auto-generated ones
            const manualRoutes = Array.from(container.querySelectorAll('.transport-route')).filter(route =>
                route.id.startsWith('transport-route-')
            );
         
            // Clear container but preserve manual routes
            container.innerHTML = '';
            manualRoutes.forEach(route => container.appendChild(route));
         
            // Clean up invalid transport routes
            const validRoutes = new Map();
            globalState.transportRoutes.forEach((route, id) => {
                // Keep manual routes (those with selected fromType and toType)
                if (route.fromType && route.toType) {
                    const fromExists = globalState[`${route.fromType}s`].has(route.fromId);
                    const toExists = globalState[`${route.toType}s`].has(route.toId);
                 
                    if (fromExists && toExists) {
                        validRoutes.set(id, route);
                    }
                } else {
                    // Keep incomplete manual routes
                    validRoutes.set(id, route);
                }
            });
            globalState.transportRoutes = validRoutes;
         
            // Update location options in existing manual routes
            container.querySelectorAll('select').forEach(select => {
                const currentValue = select.value;
                const isFromSelect = select.getAttribute('onchange').includes("'from'");
                const isLocationSelect = select.getAttribute('onchange').includes('updateTransportLocation');
             
                if (isLocationSelect) {
                    select.innerHTML = `<option value="" data-translate="select-location">Â†¥ÊâÄ„ÇíÈÅ∏Êäû</option>` +
                                     generateLocationOptions(isFromSelect ? 'from' : 'to');
                    select.value = currentValue;
                }
            });
         
            updateTranslations();
        }
        function selectTransportMode(button, mode, routeId) {
            const container = button.parentElement;
            container.querySelectorAll('.transport-mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
         
            // Update header icon
            const header = container.closest('.transport-route').querySelector('.transport-route__header span:first-child');
            if (header) {
                header.textContent = transportIcons[mode];
            }
         
            // Update transport data
            if (routeId) {
                updateTransportData(routeId, 'mode', mode);
            }
        }
        function updateTransportData(routeId, field, value) {
            const transportData = globalState.transportRoutes.get(routeId);
            if (transportData) {
                transportData[field] = value;
             
                // Refresh map display to show updated transport details
                generateMap();
            }
        }
        // Data Import/Export
        function exportDataAsCSV() {
            const data = [];
         
            // Add facility1s
            globalState.facility1s.forEach(facility => {
                data.push(getFacilityCSVRow('facility1', facility));
            });
         
            // Add facility2s
            globalState.facility2s.forEach(facility => {
                data.push(getFacilityCSVRow('facility2', facility));
            });
         
            // Add facility3s
            globalState.facility3s.forEach(facility => {
                data.push(getFacilityCSVRow('facility3', facility));
            });
         
            // Add facility4s
            globalState.facility4s.forEach(facility => {
                data.push(getFacilityCSVRow('facility4', facility));
            });
         
            // Add facility5s
            globalState.facility5s.forEach(facility => {
                data.push(getFacilityCSVRow('facility5', facility));
            });
         
            // Add transport routes
            globalState.transportRoutes.forEach(route => {
                data.push({
                    type: 'transport',
                    id: route.id,
                    fromType: route.fromType,
                    fromId: route.fromId,
                    toType: route.toType,
                    toId: route.toId,
                    mode: route.mode,
                    operatingEntity: route.operatingEntity,
                    customEntityName: route.customEntityName,
                    departure: route.departure,
                    arrival: route.arrival,
                    frequency: route.frequency,
                    packageType: route.packageType,
                    volume: route.volume
                });
            });
         
            const csv = convertToCSV(data);
            downloadFile(csv, 'logistics-map-data.csv', 'text/csv');
            showDebugMessage('Data exported to CSV successfully');
        }
        function getFacilityCSVRow(type, facility) {
            return {
                type: type,
                id: facility.id,
                name: facility.name,
                locationType: facility.locationType,
                country: facility.country,
                city: facility.city,
                icon: facility.icon,
                isWarehouse: facility.isWarehouse,
                warehouseType: facility.warehouseType,
                operatingEntity: facility.operatingEntity,
                hasTemperatureControl: facility.hasTemperatureControl,
                temperature: facility.temperature,
                humidity: facility.humidity,
                workContent: facility.workContent
            };
        }
        function convertToCSV(data) {
            if (data.length === 0) return '';
         
            // Collect all unique headers from all rows
            const allHeaders = new Set();
            data.forEach(row => {
                Object.keys(row).forEach(key => allHeaders.add(key));
            });
            const headers = Array.from(allHeaders);
         
            const csvHeaders = headers.join(',');
         
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] ?? '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',');
            });
         
            return [csvHeaders, ...csvRows].join('\n');
        }
        function downloadFile(content, filename, contentType = 'text/plain') {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        function downloadSampleTemplate() {
            const sampleData = [
                {
                    type: 'facility1',
                    id: 1,
                    name: 'Supplier A',
                    locationType: 'overseas',
                    country: 'China',
                    city: 'Shanghai',
                    icon: 'üè≠',
                    isWarehouse: false,
                    warehouseType: 'general',
                    operatingEntity: 'own',
                    hasTemperatureControl: false,
                    temperature: '',
                    humidity: '',
                    workContent: ''
                },
                {
                    type: 'facility2',
                    id: 1,
                    name: 'Main Warehouse',
                    locationType: 'domestic',
                    country: 'Japan',
                    city: 'Tokyo',
                    icon: 'üè¢',
                    isWarehouse: true,
                    warehouseType: 'general',
                    operatingEntity: 'own',
                    hasTemperatureControl: true,
                    temperature: '15-25¬∞C',
                    humidity: '40-60%',
                    workContent: 'Storage and distribution'
                },
                {
                    type: 'facility3',
                    id: 1,
                    name: 'Customer A',
                    locationType: 'domestic',
                    country: 'Japan',
                    city: 'Osaka',
                    icon: 'üè™',
                    isWarehouse: false,
                    warehouseType: 'general',
                    operatingEntity: 'own',
                    hasTemperatureControl: false,
                    temperature: '',
                    humidity: '',
                    workContent: ''
                },
                {
                    type: 'facility4',
                    id: 1,
                    name: 'Distribution Center',
                    locationType: 'domestic',
                    country: 'Japan',
                    city: 'Nagoya',
                    icon: 'üèõÔ∏è',
                    isWarehouse: false,
                    warehouseType: 'general',
                    operatingEntity: 'own',
                    hasTemperatureControl: false,
                    temperature: '',
                    humidity: '',
                    workContent: ''
                },
                {
                    type: 'facility5',
                    id: 1,
                    name: 'Final Delivery Point',
                    locationType: 'domestic',
                    country: 'Japan',
                    city: 'Fukuoka',
                    icon: 'üè¨',
                    isWarehouse: false,
                    warehouseType: 'general',
                    operatingEntity: 'own',
                    hasTemperatureControl: false,
                    temperature: '',
                    humidity: '',
                    workContent: ''
                },
                {
                    type: 'transport',
                    id: 1,
                    fromType: 'facility1',
                    fromId: 1,
                    toType: 'facility2',
                    toId: 1,
                    mode: 'air',
                    operatingEntity: 'custom',
                    customEntityName: 'ABC Logistics Co.',
                    departure: 'Shanghai Port',
                    arrival: 'Narita Airport',
                    frequency: 'Daily',
                    packageType: 'ULD Container',
                    volume: '500kg'
                },
                {
                    type: 'transport',
                    id: 2,
                    fromType: 'facility2',
                    fromId: 1,
                    toType: 'facility3',
                    toId: 1,
                    mode: 'truck',
                    operatingEntity: 'nx',
                    customEntityName: '',
                    departure: 'Tokyo Warehouse',
                    arrival: 'Osaka Store',
                    frequency: 'Weekly',
                    packageType: 'Pallet',
                    volume: '2000kg'
                },
                {
                    type: 'transport',
                    id: 3,
                    fromType: 'facility3',
                    fromId: 1,
                    toType: 'facility4',
                    toId: 1,
                    mode: 'truck',
                    operatingEntity: 'other',
                    customEntityName: '',
                    departure: 'Osaka Store',
                    arrival: 'Nagoya DC',
                    frequency: 'Bi-weekly',
                    packageType: 'Box',
                    volume: '1000kg'
                },
                {
                    type: 'transport',
                    id: 4,
                    fromType: 'facility4',
                    fromId: 1,
                    toType: 'facility5',
                    toId: 1,
                    mode: 'truck',
                    operatingEntity: 'new',
                    customEntityName: '',
                    departure: 'Nagoya DC',
                    arrival: 'Fukuoka Point',
                    frequency: 'Monthly',
                    packageType: 'Individual',
                    volume: '500kg'
                }
            ];
         
            const csv = convertToCSV(sampleData);
            downloadFile(csv, 'logistics-map-template.csv', 'text/csv');
            showDebugMessage('Sample template downloaded');
        }
        function importDataFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
         
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const data = parseCSV(csv);
                    applyImportedData(data);
                    showDebugMessage('CSV data imported successfully');
                } catch (error) {
                    showDebugMessage('Error importing CSV: ' + error.message, true);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        function parseCSV(csv) {
            const lines = [];
            const headers = csv.split('\n')[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            const rows = csv.split('\n').slice(1);
            rows.forEach(row => {
                if (row.trim()) {
                    const values = parseCSVRow(row);
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || '';
                    });
                    data.push(obj);
                }
            });
            return data;
        }
        function parseCSVRow(row) {
            const values = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            while (i < row.length) {
                const char = row[i];
                if (char === '"' && !inQuotes) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes) {
                    if (i + 1 < row.length && row[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = false;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
                i++;
            }
            if (current) values.push(current.trim());
            return values;
        }
        function applyImportedData(data) {
            // Clear existing data
            ['1', '2', '3', '4', '5'].forEach(type => globalState[`facility${type}s`].clear());
            globalState.transportRoutes.clear();
         
            // Clear forms
            ['1', '2', '3', '4', '5'].forEach(type => document.getElementById(`facility${type}sContainer`).innerHTML = '');
            document.getElementById('transportContainer').innerHTML = '';
         
            // Reset ID counters
            ['1', '2', '3', '4', '5'].forEach(type => globalState[`nextFacility${type}Id`] = 1);
            globalState.nextTransportId = 1;
         
            // ID mapping for remapping transport IDs
            const facilityIdMaps = {
                facility1: new Map(),
                facility2: new Map(),
                facility3: new Map(),
                facility4: new Map(),
                facility5: new Map()
            };
         
            // Separate facilities and transports
            const facilities = data.filter(row => row.type.startsWith('facility'));
            const transports = data.filter(row => row.type === 'transport');
         
            // Import facilities and remap IDs
            facilities.forEach(row => {
                const facilityType = row.type.replace('facility', '');
                const oldId = parseInt(row.id) || 1;
                const nextIdKey = `nextFacility${facilityType}Id`;
                const newId = globalState[nextIdKey]++;
                facilityIdMaps[`facility${facilityType}`].set(oldId, newId);
                const facilityData = {
                    id: newId,
                    name: row.name || '',
                    locationType: row.locationType || 'domestic',
                    country: row.country || '',
                    city: row.city || '',
                    icon: row.icon || facilityIcons[facilityType - 1] || 'üè≠',
                    isWarehouse: row.isWarehouse === 'true' || row.isWarehouse === true,
                    warehouseType: row.warehouseType || 'general',
                    operatingEntity: row.operatingEntity || 'own',
                    hasTemperatureControl: row.hasTemperatureControl === 'true' || row.hasTemperatureControl === true,
                    temperature: row.temperature || '',
                    humidity: row.humidity || '',
                    workContent: row.workContent || ''
                };
                globalState[`facility${facilityType}s`].set(newId, facilityData);
                renderFacilityForm(facilityType, facilityData);
            });
         
            // Import transports with remapped IDs
            transports.forEach(row => {
                const fromType = row.fromType || '';
                const toType = row.toType || '';
                const oldFromId = parseInt(row.fromId) || 1;
                const oldToId = parseInt(row.toId) || 1;
                const newFromId = facilityIdMaps[fromType]?.get(oldFromId) || 1;
                const newToId = facilityIdMaps[toType]?.get(oldToId) || 1;
                const transportData = {
                    id: globalState.nextTransportId++,
                    fromType: fromType,
                    fromId: newFromId,
                    toType: toType,
                    toId: newToId,
                    mode: row.mode || 'truck',
                    operatingEntity: row.operatingEntity || 'nx',
                    customEntityName: row.customEntityName || '',
                    departure: row.departure || '',
                    arrival: row.arrival || '',
                    frequency: row.frequency || '',
                    packageType: row.packageType || '',
                    volume: row.volume || ''
                };
                globalState.transportRoutes.set(transportData.id, transportData);
         
                // Create and append route form
                const routeDiv = createManualTransportRoute(transportData);
                document.getElementById('transportContainer').appendChild(routeDiv);
         
                // Set form values
                const fromSelect = routeDiv.querySelector('select[onchange*="\'from\'"]');
                const toSelect = routeDiv.querySelector('select[onchange*="\'to\'"]');
                if (fromSelect) fromSelect.value = `${fromType}-${newFromId}`;
                if (toSelect) toSelect.value = `${toType}-${newToId}`;
         
                // Set mode buttons
                routeDiv.querySelectorAll('.transport-mode-btn').forEach(btn => {
                    if (btn.getAttribute('onclick').includes(`'${transportData.mode}'`)) {
                        selectTransportMode(btn, transportData.mode, transportData.id);
                    }
                });
         
                // Set entity select
                const entitySelect = routeDiv.querySelector('select[onchange*="updateTransportEntityType"]');
                if (entitySelect) {
                    entitySelect.value = transportData.operatingEntity;
                    updateTransportEntityType(transportData.id, transportData.operatingEntity);
                }
         
                // Set custom entity if applicable
                if (transportData.operatingEntity === 'custom') {
                    const customInput = routeDiv.querySelector('.custom-entity-input input');
                    if (customInput) customInput.value = transportData.customEntityName;
                }
         
                // Set other inputs
                routeDiv.querySelector('input[placeholder="Port/Station"][oninput*="\'departure\'"]').value = transportData.departure;
                routeDiv.querySelector('input[placeholder="Port/Station"][oninput*="\'arrival\'"]').value = transportData.arrival;
                routeDiv.querySelector('input[placeholder="Daily/Weekly"]').value = transportData.frequency;
                routeDiv.querySelector('input[placeholder="Container/Pallet"]').value = transportData.packageType;
                routeDiv.querySelector('input[placeholder="Volume/Weight"]').value = transportData.volume;
         
                updateRouteTitle(transportData.id);
            });
         
            generateMap();
            updateTranslations();
        }
        // Image Export
        function exportAsImage() {
            const mapPanel = document.querySelector('.map-panel');
            const mapDisplay = document.getElementById('mapDisplay');
            const mapFlow = document.getElementById('mapFlow');
            // Save original styles
            const originalPanelOverflow = mapPanel.style.overflow;
            const originalDisplayOverflow = mapDisplay.style.overflow;
            const originalDisplayWidth = mapDisplay.style.width;
            const originalDisplayHeight = mapDisplay.style.height;
            const originalFlowOverflowX = mapFlow.style.overflowX;
            const originalFlowWidth = mapFlow.style.width;
            const originalFlowHeight = mapFlow.style.height;
            // Make everything visible and set sizes to full content
            mapPanel.style.overflow = 'visible';
            mapDisplay.style.overflow = 'visible';
            mapDisplay.style.width = `${mapFlow.scrollWidth}px`;
            mapDisplay.style.height = `${mapFlow.scrollHeight}px`;
            mapFlow.style.overflowX = 'visible';
            mapFlow.style.width = 'auto';
            mapFlow.style.height = 'auto';
            // Force reflow to apply changes
            mapFlow.offsetHeight;
            const options = {
                useCORS: true,
                allowTaint: true,
                scale: 2,
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--background-color'),
                width: mapFlow.scrollWidth,
                height: mapFlow.scrollHeight,
                windowWidth: mapFlow.scrollWidth,
                windowHeight: mapFlow.scrollHeight
            };
            html2canvas(mapDisplay, options).then(canvas => {
                // Convert canvas to blob and download
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'logistics-map.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                 
                    showDebugMessage('Map exported as image successfully');
                }, 'image/png');
            }).catch(error => {
                showDebugMessage('Error exporting image: ' + error.message, true);
            }).finally(() => {
                // Restore original styles
                mapPanel.style.overflow = originalPanelOverflow;
                mapDisplay.style.overflow = originalDisplayOverflow;
                mapDisplay.style.width = originalDisplayWidth;
                mapDisplay.style.height = originalDisplayHeight;
                mapFlow.style.overflowX = originalFlowOverflowX;
                mapFlow.style.width = originalFlowWidth;
                mapFlow.style.height = originalFlowHeight;
            });
        }
        // Validation System
        function validateInput(type, id) {
            const data = globalState[`${type}s`].get(id);
            const element = document.getElementById(`${type}-${id}`);
         
            if (!data || !element) return;
         
            const isValid = data.name && data.name.trim() !== '';
            const nameInput = element.querySelector('input[type="text"]');
         
            if (nameInput) {
                nameInput.classList.toggle('error', !isValid);
            }
         
            return isValid;
        }
        function validateAllInputs() {
            let allValid = true;
         
            ['1', '2', '3', '4', '5'].forEach(num => {
                globalState[`facility${num}s`].forEach((facility, id) => {
                    if (!validateInput(`facility${num}`, id)) allValid = false;
                });
            });
         
            return allValid;
        }
        // Debug and User Feedback
        function showDebugMessage(message, isError = false) {
            // Remove existing debug messages
            document.querySelectorAll('.debug-message').forEach(msg => msg.remove());
         
            const debugDiv = document.createElement('div');
            debugDiv.className = `debug-message debug-message--${isError ? 'error' : 'success'}`;
            debugDiv.textContent = message;
         
            document.body.appendChild(debugDiv);
         
            // Auto-remove after 3 seconds
            setTimeout(() => {
                debugDiv.remove();
            }, 3000);
         
            console.log(`[${isError ? 'ERROR' : 'INFO'}] ${message}`);
        }
        // Initialize Application
        function initializeApp() {
            // Add default data for demonstration
            addFacility1();
            addFacility2();
            addFacility3();
         
            // Set sample data for clarity
            const facility1 = globalState.facility1s.get(1);
            facility1.name = 'Ë™øÈÅîÂÖàA (Êµ∑Â§ñ)';
            facility1.locationType = 'overseas';
            facility1.country = '‰∏≠ÂõΩ';
            facility1.city = '‰∏äÊµ∑';
            facility1.icon = 'üè≠';
         
            const facility2 = globalState.facility2s.get(1);
            facility2.name = 'ÂÄâÂ∫´B';
            facility2.locationType = 'domestic';
            facility2.country = 'Êó•Êú¨';
            facility2.city = 'Êù±‰∫¨';
            facility2.icon = 'üè¢';
            facility2.isWarehouse = true;
            facility2.warehouseType = 'general';
            facility2.operatingEntity = 'own';
            facility2.hasTemperatureControl = true;
            facility2.temperature = '15-25¬∞C';
            facility2.humidity = '40-60%';
            facility2.workContent = '‰øùÁÆ°„ÉªÈÖçÈÄÅ';
         
            const facility3 = globalState.facility3s.get(1);
            facility3.name = 'Á¥çÂÖ•ÂÖàC';
            facility3.locationType = 'domestic';
            facility3.country = 'Êó•Êú¨';
            facility3.city = 'Â§ßÈò™';
            facility3.icon = 'üè™';
         
            // Add sample transport routes
            addTransportRoute();
            const firstRoute = Array.from(globalState.transportRoutes.values())[0];
            if (firstRoute) {
                firstRoute.fromType = 'facility1';
                firstRoute.fromId = 1;
                firstRoute.toType = 'facility2';
                firstRoute.toId = 1;
                firstRoute.mode = 'air';
                firstRoute.operatingEntity = 'nx';
                firstRoute.departure = '‰∏äÊµ∑Ê∏Ø';
                firstRoute.arrival = 'ÊàêÁî∞Á©∫Ê∏Ø';
                firstRoute.frequency = 'ÊØéÊó•';
                firstRoute.packageType = '„Ç≥„É≥„ÉÜ„Éä';
                firstRoute.volume = '500kg';
             
                updateRouteTitle(firstRoute.id);
             
                const routeDiv = document.getElementById(`transport-route-${firstRoute.id}`);
                if (routeDiv) {
                    const fromSelect = routeDiv.querySelector('select[onchange*="from"]');
                    const toSelect = routeDiv.querySelector('select[onchange*="to"]');
                    if (fromSelect) fromSelect.value = 'facility1-1';
                    if (toSelect) toSelect.value = 'facility2-1';
                }
            }
         
            addTransportRoute();
            const secondRoute = Array.from(globalState.transportRoutes.values())[1];
            if (secondRoute) {
                secondRoute.fromType = 'facility2';
                secondRoute.fromId = 1;
                secondRoute.toType = 'facility3';
                secondRoute.toId = 1;
                secondRoute.mode = 'truck';
                secondRoute.operatingEntity = 'nx';
                secondRoute.departure = 'Êù±‰∫¨ÂÄâÂ∫´';
                secondRoute.arrival = 'Â§ßÈò™Â∫ó';
                secondRoute.frequency = 'ÈÄ±1Âõû';
                secondRoute.packageType = '„Éë„É¨„ÉÉ„Éà';
                secondRoute.volume = '2000kg';
             
                updateRouteTitle(secondRoute.id);
             
                const routeDiv = document.getElementById(`transport-route-${secondRoute.id}`);
                if (routeDiv) {
                    const fromSelect = routeDiv.querySelector('select[onchange*="from"]');
                    const toSelect = routeDiv.querySelector('select[onchange*="to"]');
                    if (fromSelect) fromSelect.value = 'facility2-1';
                    if (toSelect) toSelect.value = 'facility3-1';
                }
            }
         
            // Update forms and map
            ['1', '2', '3'].forEach(type => {
                const container = document.getElementById(`facility${type}sContainer`);
                container.innerHTML = '';
                globalState[`facility${type}s`].forEach(facility => renderFacilityForm(type, facility));
            });
         
            // Update translations
            updateTranslations();
         
            // Generate initial map
            generateMap();
         
            showDebugMessage('Logistics Map Generator initialized successfully');
        }
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Refresh the map when page becomes visible
                generateMap();
            }
        });
        // Handle window resize
        window.addEventListener('resize', function() {
            setTimeout(generateMap, 100);
        });
    </script>
</body>
</html>