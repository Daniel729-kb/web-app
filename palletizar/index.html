<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パレタイズ最適化計算機</title>
    
    <!-- 共通CSSファイルの読み込み -->
    <link rel="stylesheet" href="../styles/variables.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="palletizar-specific.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダーコントロール -->
        <div class="header-controls" style="position: absolute; top: 24px; right: 32px; display: flex; gap: 12px; align-items: center; z-index: 10;">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ダークモード切り替え" style="background: rgba(255, 255, 255, 0.1); border: none; border-radius: 6px; padding: 8px; color: rgba(255, 255, 255, 0.8); cursor: pointer; transition: all 0.2s ease; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 36px; height: 32px;">
                <span class="dark-mode-icon">🌙</span>
            </button>
        </div>

        <div class="header">
            <h1>📦 パレタイズ最適化計算機 by Daniel</h1>
            <p>高さ制限対応・配置効率最適化システム</p>
        </div>

        <div style="padding: 32px;">
            <div class="improvement-note">
                <h3>📋 使用方法</h3>
                <ol>
                    <li><strong>貨物データの入力</strong>：「📄 CSVインポート」で一括追加または「➕ 新規追加」で個別入力</li>
                    <li><strong>CSVテンプレート</strong>：「📥 CSVテンプレート」をダウンロードしてExcelで編集可能</li>
                    <li><strong>高さ制限設定</strong>：用途に応じて積載高さの上限を調整</li>
                    <li><strong>パレット種類選択</strong>：使用するパレットサイズを選択</li>
                    <li><strong>パレタイズ計算</strong>：「🔢 パレタイズ計算を実行」で最適配置を自動計算</li>
                    <li><strong>結果確認</strong>：配置図（側面図・層別配置）で視覚的に確認、パレット番号クリックで詳細表示</li>
                    <li><strong>データ管理</strong>：「🗑️ 一括削除」で全データをクリア可能</li>
                </ol>
            </div>

            <!-- エラー表示 -->
            <div id="errors"></div>

            <!-- 貨物情報サマリー -->
            <div class="summary-grid">
                <div class="summary-card blue">
                    <h3>総カートン数</h3>
                    <p id="totalCartons">0</p>
                </div>
                <div class="summary-card green">
                    <h3>総重量</h3>
                    <p id="totalWeight">0 kg</p>
                </div>
                <div class="summary-card purple">
                    <h3>品目数</h3>
                    <p id="itemCount">0 種類</p>
                </div>
            </div>

            <!-- 貨物詳細テーブル -->
            <div class="section">
                <div class="section-header">
                    <h2>貨物詳細</h2>
                    <div class="flex gap-2">
                        <button id="downloadTemplateButton" class="btn btn-secondary">📥 CSVテンプレート</button>
                        <button id="importButton" class="btn btn-primary">📄 CSVインポート</button>
                        <button id="clearAllButton" class="btn btn-danger">🗑️ 一括削除</button>
                        <button id="addButton" class="btn btn-success">➕ 新規追加</button>
                    </div>
                </div>
                
                <!-- CSVインポートエリア -->
                <div id="importArea" class="add-form hidden">
                    <h3>CSVファイルをインポート</h3>
                    <div style="margin-bottom: 15px;">
                        <input type="file" id="csvFileInput" accept=".csv" class="form-input" style="margin-bottom: 10px;">
                        <div style="font-size: 0.9rem; color: #666;">
                            <strong>CSV形式:</strong> 貨物コード, 数量, 重量(kg), 長さ(cm), 幅(cm), 高さ(cm)<br>
                            <strong>例:</strong> SAMPLE, 209, 6.70, 53.0, 38.5, 23.5
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="executeImportButton" class="btn btn-primary">📥 インポート実行</button>
                        <button id="cancelImportButton" class="btn btn-secondary">❌ キャンセル</button>
                    </div>
                </div>
                
                <!-- 新規追加フォーム -->
                <div id="addForm" class="add-form hidden">
                    <h3>新しいカートンを追加</h3>
                    <div class="form-grid">
                        <input type="text" id="newCode" placeholder="貨物コード" class="form-input">
                        <input type="number" id="newQty" placeholder="数量" class="form-input">
                        <input type="number" id="newWeight" placeholder="重量(kg)" step="0.1" class="form-input">
                        <input type="number" id="newL" placeholder="長さ(cm)" step="0.1" class="form-input">
                        <input type="number" id="newW" placeholder="幅(cm)" step="0.1" class="form-input">
                        <input type="number" id="newH" placeholder="高さ(cm)" step="0.1" class="form-input">
                    </div>
                    <div class="flex gap-2">
                        <button id="saveAddButton" class="btn btn-primary">💾 追加</button>
                        <button id="cancelAddButton" class="btn btn-secondary">❌ キャンセル</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>貨物コード</th>
                                <th>数量</th>
                                <th>重量 (kg)</th>
                                <th>長さ (cm)</th>
                                <th>幅 (cm)</th>
                                <th>高さ (cm)</th>
                                <th>体積 (㎥)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cartonTableBody">
                            <!-- データはJavaScriptで挿入 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 高さ制限設定 -->
            <div class="height-limit-setting">
                <h3>📏 積載高さ制限設定</h3>
                <div class="height-limit-controls">
                    <div class="height-input-group">
                        <label for="heightLimitInput">最大積載高さ</label>
                        <div class="height-input-wrapper">
                            <input type="number" id="heightLimitInput" value="158" min="50" max="300" step="1">
                            <span class="height-unit">cm</span>
                        </div>
                        <div class="height-current-display">
                            現在の制限: <span id="heightLimitDisplay">158</span>cm
                        </div>
                        <div class="height-presets">
                            <button class="height-preset-btn" onclick="setHeightLimit(120)">コンテナ標準 (120cm)</button>
                            <button class="height-preset-btn active" onclick="setHeightLimit(158)">一般パレット (158cm)</button>
                            <button class="height-preset-btn" onclick="setHeightLimit(180)">高積載 (180cm)</button>
                            <button class="height-preset-btn" onclick="setHeightLimit(200)">倉庫内専用 (200cm)</button>
                        </div>
                    </div>
                    <div class="height-info">
                        <h4>💡 高さ制限について</h4>
                        <ul>
                            <li><strong>120cm:</strong> 海上コンテナ輸送向け（安全マージン考慮）</li>
                            <li><strong>158cm:</strong> 一般的なパレット積載標準高さ</li>
                            <li><strong>180cm:</strong> トラック輸送での高積載用途</li>
                            <li><strong>200cm以上:</strong> 倉庫内保管専用（輸送制限あり）</li>
                        </ul>
                        <div id="heightWarning" class="height-warning hidden">
                            ⚠️ 設定された高さ制限は一般的な輸送制限を超えています。用途を確認してください。
                        </div>
                    </div>
                </div>
            </div>

            <!-- パレット種類選択 -->
            <div class="pallet-selection">
                <h3>🏗️ 使用するパレット種類を選択</h3>
                <div class="pallet-options" id="palletOptions">
                    <!-- パレット選択肢はJavaScriptで生成 -->
                </div>
                <div class="pallet-selection-actions">
                    <button id="selectAllPallets" class="btn btn-secondary btn-sm">✓ 全て選択</button>
                    <button id="deselectAllPallets" class="btn btn-secondary btn-sm">✗ 全て解除</button>
                    <span id="selectedPalletsInfo" style="color: #666; font-size: 0.9rem; padding: 8px 0;"></span>
                </div>
            </div>

            <!-- 計算ボタン -->
            <div class="text-center">
                <button id="calculateButton" class="btn btn-primary btn-lg">🔢 パレタイズ計算を実行</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span style="margin-left: 10px;">最適化計算中...</span>
            </div>

            <!-- 結果表示 -->
            <div id="results" class="hidden">
                <div class="result-section">
                    <div class="result-header">
                        <h2>🚛 最適化結果</h2>
                    
            <!-- パレタイズサマリー -->
            <div id="summarySection" class="hidden">
                <h2 style="margin-top:1rem;">パレタイズ結果サマリー</h2>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>パレットNo</th>
                            <th>寸法 (cm)</th>
                            <th>重量 (kg)</th>
                            <th>貨物コード</th>
                            <th>数量</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody"></tbody>
                </table>
                <button id="exportButton" class="btn btn-primary" style="margin-top:8px;">CSVダウンロード</button>
            </div>

                    
                    <div class="summary-grid" id="resultSummary">
                        <!-- 結果サマリー -->
                    </div>

                    <!-- パレット結合機能 -->
                    <div id="combineSection" class="hidden">
                        <div class="improvement-note" style="background-color: #fff3cd; border-color: #ffeaa7;">
                            <h3>🔄 パレット結合機能</h3>
                            <p style="margin-bottom: 15px;">2つのパレットを選択して、より効率的な1つのパレットに結合できます。</p>
                            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label for="pallet1Select">パレット1:</label>
                                    <select id="pallet1Select" class="form-input" style="width: 120px;">
                                        <option value="">選択...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="pallet2Select">パレット2:</label>
                                    <select id="pallet2Select" class="form-input" style="width: 120px;">
                                        <option value="">選択...</option>
                                    </select>
                                </div>
                                <button id="combineButton" class="btn btn-primary">🔄 パレット結合</button>
                                <button id="autoOptimizeButton" class="btn btn-success">✨ 自動最適化</button>
                                <button id="analyzeButton" class="btn btn-secondary">🔍 詳細分析</button>
                            </div>
                            <div id="combinePreview" style="font-size: 0.9rem; color: #666;"></div>
                        </div>
                    </div>

                    <div id="palletResults">
                        <!-- パレット結果 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ダークモード管理
        let isDarkMode = false;

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            updateDarkModeIcon();
        }

        function updateDarkModeIcon() {
            const icon = document.querySelector('.dark-mode-icon');
            if (icon) {
                icon.textContent = isDarkMode ? '☀️' : '🌙';
            }
        }

        // 初期化時にダークモードを無効化（ライトモードをデフォルトに）
        function initializeDarkMode() {
            // システムのダークモード設定を無視してライトモードから開始
            document.body.classList.remove('dark-mode');
            isDarkMode = false;
            updateDarkModeIcon();
        }

        // グローバル変数の初期化
        window.currentPallets = [];
        
        // 高さ制限のグローバル変数
        let maxHeightLimit = 158; // デフォルトは158cm（パレット台座14cm含む）
        
        // 初期データ（拡張サンプル）
        let cartonData = [
            { id: 1, code: 'SAMPLE A', qty: 362, weight: 6.70, l: 53.0, w: 38.5, h: 23.5 },
            { id: 2, code: 'SAMPLE B', qty: 42, weight: 7.60, l: 55.0, w: 40.0, h: 24.0 }
        ];

        const allPalletSizes = [
            { name: '1100×1000', width: 110.0, depth: 100.0, description: '標準パレット' },
            { name: '1100×1100', width: 110.0, depth: 110.0, description: '正方形パレット' },
            { name: '1200×1000', width: 120.0, depth: 100.0, description: '大型パレット' },
            { name: '1200×1100', width: 120.0, depth: 110.0, description: '特大パレット' }
        ];

        let selectedPalletSizes = [...allPalletSizes]; // デフォルトで全選択

        let editingId = null;
        let nextId = 7;

        // Helper function for safe division
        function safeDivide(a, b, defaultValue = 0) {
            return b !== 0 ? a / b : defaultValue;
        }

        // === 高さ制限設定機能 ===
        function setHeightLimit(height) {
            const input = document.getElementById('heightLimitInput');
            const display = document.getElementById('heightLimitDisplay');
            const warning = document.getElementById('heightWarning');
            
            // 値を更新
            input.value = height;
            maxHeightLimit = height;
            display.textContent = height;
            
            // プリセットボタンの状態更新
            document.querySelectorAll('.height-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // 警告表示の判定
            if (height > 180) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            console.log(`高さ制限を${height}cmに設定しました`);
            
            // 既に計算結果がある場合は影響を通知
            if (window.currentPallets && window.currentPallets.length > 0) {
                const affectedPallets = window.currentPallets.filter(pallet => pallet.height > height);
                if (affectedPallets.length > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.innerHTML = `⚠️ 高さ制限変更: ${affectedPallets.length}枚のパレットが新しい制限(${height}cm)を超過しています。再計算を推奨します。`;
                    document.getElementById('errors').appendChild(alertDiv);
                }
            }
        }

        function updateHeightLimitFromInput() {
            const input = document.getElementById('heightLimitInput');
            const display = document.getElementById('heightLimitDisplay');
            const warning = document.getElementById('heightWarning');
            
            let height = parseInt(input.value);
            
            // バリデーション
            if (isNaN(height) || height < 50) {
                height = 50;
                input.value = 50;
            } else if (height > 300) {
                height = 300;
                input.value = 300;
            }
            
            maxHeightLimit = height;
            display.textContent = height;
            
            // プリセットボタンの状態更新（該当する値の場合）
            document.querySelectorAll('.height-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const matchingPreset = document.querySelector(`[onclick="setHeightLimit(${height})"]`);
            if (matchingPreset) {
                matchingPreset.classList.add('active');
            }
            
            // 警告表示の判定
            if (height > 180) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            console.log(`高さ制限を${height}cmに更新しました`);
        }

        // 高さ制限を取得する関数（カートン配置可能高さ）
        function getMaxCartonHeight() {
            return maxHeightLimit - 14; // パレット台座14cmを除いたカートン配置可能高さ
        }

        // 高さ制限を取得する関数（総高さ）
        function getMaxTotalHeight() {
            return maxHeightLimit;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode(); // ダークモード初期化を追加
            updateTable();
            updateSummary();
            setupEventListeners();
            initializePalletSelection();
            initializeHeightLimit();
        });

        // 以下、既存のJavaScript関数を全て含める（省略せずに全部コピー）
        // [元のindex.htmlから全てのJavaScript関数をここにコピーする必要があります]
        // スペースの都合上、ここでは主要な関数のみ示しています

        function initializeHeightLimit() {
            const input = document.getElementById('heightLimitInput');
            if (input) {
                input.addEventListener('input', updateHeightLimitFromInput);
                input.addEventListener('blur', updateHeightLimitFromInput);
            }
        }

        function setupEventListeners() {
            document.getElementById('addButton').addEventListener('click', toggleAddForm);
            document.getElementById('saveAddButton').addEventListener('click', addCarton);
            document.getElementById('cancelAddButton').addEventListener('click', cancelAdd);
            document.getElementById('calculateButton').addEventListener('click', calculateImprovedPalletization);
            
            // インポート機能
            document.getElementById('downloadTemplateButton').addEventListener('click', downloadCSVTemplate);
            document.getElementById('importButton').addEventListener('click', toggleImportArea);
            document.getElementById('executeImportButton').addEventListener('click', executeImport);
            document.getElementById('cancelImportButton').addEventListener('click', cancelImport);
            
            // 一括削除機能
            document.getElementById('clearAllButton').addEventListener('click', clearAllCartons);
            
            // Export機能
            const exportBtn = document.getElementById('exportButton');
            if (exportBtn) exportBtn.addEventListener('click', exportSummaryCsv);
            
            // パレット結合機能
            document.getElementById('combineButton').addEventListener('click', combinePallets);
            document.getElementById('autoOptimizeButton').addEventListener('click', autoOptimizePallets);
            document.getElementById('analyzeButton').addEventListener('click', analyzeSelectedPallets);
            document.getElementById('pallet1Select').addEventListener('change', updateCombinePreview);
            document.getElementById('pallet2Select').addEventListener('change', updateCombinePreview);

            // パレット選択機能
            document.getElementById('selectAllPallets').addEventListener('click', selectAllPallets);
            document.getElementById('deselectAllPallets').addEventListener('click', deselectAllPallets);
        }

        // パレット選択機能の初期化
        function initializePalletSelection() {
            const container = document.getElementById('palletOptions');
            container.innerHTML = '';
            
            allPalletSizes.forEach((pallet, index) => {
                const option = document.createElement('div');
                option.className = 'pallet-option selected';
                option.innerHTML = `
                    <input type="checkbox" class="pallet-checkbox" id="pallet-${index}" checked onchange="updatePalletSelection()">
                    <div class="pallet-option-info">
                        <div class="pallet-option-name">${pallet.name}</div>
                        <div class="pallet-option-size">${pallet.description}</div>
                    </div>
                `;
                container.appendChild(option);
            });
            updateSelectedPalletsInfo();
        }

        function updatePalletSelection() {
            selectedPalletSizes = [];
            document.querySelectorAll('.pallet-checkbox').forEach((checkbox, index) => {
                const option = checkbox.closest('.pallet-option');
                if (checkbox.checked) {
                    selectedPalletSizes.push(allPalletSizes[index]);
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            updateSelectedPalletsInfo();
        }

        function selectAllPallets() {
            document.querySelectorAll('.pallet-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updatePalletSelection();
        }

        function deselectAllPallets() {
            document.querySelectorAll('.pallet-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updatePalletSelection();
        }

        function updateSelectedPalletsInfo() {
            const info = document.getElementById('selectedPalletsInfo');
            if (selectedPalletSizes.length === 0) {
                info.textContent = '⚠️ パレットが選択されていません';
                info.style.color = '#dc3545';
            } else {
                info.textContent = `選択中: ${selectedPalletSizes.length}種類のパレット`;
                info.style.color = '#28a745';
            }
        }

        // テーブル更新
        function updateTable() {
            const tbody = document.getElementById('cartonTableBody');
            tbody.innerHTML = '';
            
            cartonData.forEach(carton => {
                const row = document.createElement('tr');
                const volume = (carton.l * carton.w * carton.h * carton.qty / 1000000).toFixed(3);
                
                row.innerHTML = `
                    <td>${carton.code}</td>
                    <td class="center">${carton.qty}</td>
                    <td class="center mono">${carton.weight.toFixed(2)}</td>
                    <td class="center mono">${carton.l.toFixed(1)}</td>
                    <td class="center mono">${carton.w.toFixed(1)}</td>
                    <td class="center mono">${carton.h.toFixed(1)}</td>
                    <td class="center mono">${volume}</td>
                    <td class="center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="editCarton(${carton.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="removeCarton(${carton.id})">🗑️</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // サマリー更新
        function updateSummary() {
            const totalCartons = cartonData.reduce((sum, c) => sum + c.qty, 0);
            const totalWeight = cartonData.reduce((sum, c) => sum + (c.weight * c.qty), 0);
            const itemCount = cartonData.length;
            
            document.getElementById('totalCartons').textContent = totalCartons.toLocaleString();
            document.getElementById('totalWeight').textContent = totalWeight.toFixed(1) + ' kg';
            document.getElementById('itemCount').textContent = itemCount + ' 種類';
        }

        // フォーム表示切替
        function toggleAddForm() {
            const form = document.getElementById('addForm');
            const importArea = document.getElementById('importArea');
            form.classList.toggle('hidden');
            importArea.classList.add('hidden');
            if (!form.classList.contains('hidden')) {
                document.getElementById('newCode').focus();
            }
        }

        function toggleImportArea() {
            const form = document.getElementById('addForm');
            const importArea = document.getElementById('importArea');
            importArea.classList.toggle('hidden');
            form.classList.add('hidden');
        }

        // カートン追加
        function addCarton() {
            const code = document.getElementById('newCode').value.trim();
            const qty = parseInt(document.getElementById('newQty').value);
            const weight = parseFloat(document.getElementById('newWeight').value);
            const l = parseFloat(document.getElementById('newL').value);
            const w = parseFloat(document.getElementById('newW').value);
            const h = parseFloat(document.getElementById('newH').value);
            
            if (!code || !qty || !weight || !l || !w || !h) {
                alert('全ての項目を入力してください');
                return;
            }
            
            cartonData.push({
                id: nextId++,
                code, qty, weight, l, w, h
            });
            
            clearInputs();
            updateTable();
            updateSummary();
            document.getElementById('addForm').classList.add('hidden');
        }

        function clearInputs() {
            ['newCode', 'newQty', 'newWeight', 'newL', 'newW', 'newH'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function cancelAdd() {
            clearInputs();
            document.getElementById('addForm').classList.add('hidden');
        }

        function cancelImport() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('importArea').classList.add('hidden');
        }

        // カートン編集・削除
        function editCarton(id) {
            // 編集機能（省略版）
            const carton = cartonData.find(c => c.id === id);
            if (carton) {
                document.getElementById('newCode').value = carton.code;
                document.getElementById('newQty').value = carton.qty;
                document.getElementById('newWeight').value = carton.weight;
                document.getElementById('newL').value = carton.l;
                document.getElementById('newW').value = carton.w;
                document.getElementById('newH').value = carton.h;
                editingId = id;
                document.getElementById('addForm').classList.remove('hidden');
            }
        }

        function removeCarton(id) {
            if (confirm('このカートンを削除しますか？')) {
                cartonData = cartonData.filter(c => c.id !== id);
                updateTable();
                updateSummary();
            }
        }

        function clearAllCartons() {
            if (confirm('全てのカートンデータを削除しますか？')) {
                cartonData = [];
                updateTable();
                updateSummary();
                clearResults();
            }
        }

        function clearResults() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            window.currentPallets = [];
        }

        // CSV機能
        function downloadCSVTemplate() {
            const csvContent = 'コード,数量,重量(kg),長さ(cm),幅(cm),高さ(cm)\nSAMPLE A,362,6.70,53.0,38.5,23.5\nSAMPLE B,42,7.60,55.0,40.0,24.0';
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'パレタイズ計算_テンプレート.csv';
            link.click();
        }

        function executeImport() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const importedData = [];
                    
                    // ヘッダー行をスキップ
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',').map(v => v.trim());
                        if (values.length >= 6) {
                            importedData.push({
                                id: nextId++,
                                code: values[0],
                                qty: parseInt(values[1]) || 0,
                                weight: parseFloat(values[2]) || 0,
                                l: parseFloat(values[3]) || 0,
                                w: parseFloat(values[4]) || 0,
                                h: parseFloat(values[5]) || 0
                            });
                        }
                    }
                    
                    if (importedData.length > 0) {
                        cartonData.push(...importedData);
                        updateTable();
                        updateSummary();
                        cancelImport();
                        alert(`${importedData.length}件のデータをインポートしました`);
                    } else {
                        alert('有効なデータが見つかりませんでした');
                    }
                } catch (error) {
                    alert('CSVファイルの読み込みに失敗しました: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // パレタイズ計算（メイン処理）
        function calculateImprovedPalletization() {
            if (cartonData.length === 0) {
                alert('計算するカートンデータがありません');
                return;
            }
            
            if (selectedPalletSizes.length === 0) {
                alert('使用するパレットを選択してください');
                return;
            }

            showLoading(true);
            clearErrors();
            
            setTimeout(() => {
                try {
                    const results = performOptimizedPalletization();
                    displayResults(results);
                    showLoading(false);
                } catch (error) {
                    showError('計算中にエラーが発生しました: ' + error.message);
                    showLoading(false);
                }
            }, 100);
        }

        function performOptimizedPalletization() {
            const results = [];
            const maxCartonHeight = getMaxCartonHeight();
            
            selectedPalletSizes.forEach(palletSize => {
                cartonData.forEach(carton => {
                    const palletResult = calculatePalletForCarton(carton, palletSize, maxCartonHeight);
                    if (palletResult) {
                        results.push(palletResult);
                    }
                });
            });
            
            // 最適な結果を選択（効率性でソート）
            results.sort((a, b) => b.efficiency - a.efficiency);
            
            return results.slice(0, 10); // 上位10件を返す
        }

        function calculatePalletForCarton(carton, palletSize, maxHeight) {
            const palletLength = palletSize.width;
            const palletWidth = palletSize.depth;
            
            // カートンの向きを最適化
            const orientations = [
                { l: carton.l, w: carton.w, h: carton.h, rotated: false },
                { l: carton.w, w: carton.l, h: carton.h, rotated: true }
            ];
            
            let bestResult = null;
            let maxQuantity = 0;
            
            orientations.forEach(orientation => {
                if (orientation.h <= maxHeight) {
                    const xCount = Math.floor(palletLength / orientation.l);
                    const yCount = Math.floor(palletWidth / orientation.w);
                    const layers = Math.floor(maxHeight / orientation.h);
                    const quantity = xCount * yCount * layers;
                    
                    if (quantity > maxQuantity) {
                        maxQuantity = quantity;
                        bestResult = {
                            carton: carton,
                            palletSize: palletSize,
                            orientation: orientation,
                            layout: { x: xCount, y: yCount, layers: layers },
                            quantity: Math.min(quantity, carton.qty),
                            efficiency: (quantity * orientation.l * orientation.w * orientation.h) / (palletLength * palletWidth * maxHeight) * 100,
                            height: layers * orientation.h + 14 // パレット台座含む
                        };
                    }
                }
            });
            
            return bestResult;
        }

        function displayResults(results) {
            window.currentPallets = results;
            
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('summarySection').classList.remove('hidden');
            document.getElementById('combineSection').classList.remove('hidden');
            
            // 結果サマリー表示
            const summaryGrid = document.getElementById('resultSummary');
            summaryGrid.innerHTML = `
                <div class="summary-card blue">
                    <h3>最適パレット数</h3>
                    <p>${results.length}</p>
                </div>
                <div class="summary-card green">
                    <h3>平均効率</h3>
                    <p>${(results.reduce((sum, r) => sum + r.efficiency, 0) / results.length).toFixed(1)}%</p>
                </div>
                <div class="summary-card orange">
                    <h3>総積載量</h3>
                    <p>${results.reduce((sum, r) => sum + r.quantity, 0)}個</p>
                </div>
            `;
            
            // パレット詳細表示
            const palletResults = document.getElementById('palletResults');
            palletResults.innerHTML = results.map((result, index) => createPalletCard(result, index + 1)).join('');
            
            // サマリーテーブル表示
            updateSummaryTable(results);
            updateCombineSelectors(results);
        }

        function createPalletCard(result, palletNumber) {
            return `
                <div class="pallet-card" id="pallet-${palletNumber}">
                    <h3>パレット ${palletNumber} - ${result.palletSize.name}</h3>
                    <div class="pallet-grid">
                        <div class="pallet-stat">
                            <p>寸法 (cm)</p>
                            <p>${result.palletSize.width}×${result.palletSize.depth}×${result.height.toFixed(1)}</p>
                        </div>
                        <div class="pallet-stat">
                            <p>積載数量</p>
                            <p>${result.quantity}個</p>
                        </div>
                        <div class="pallet-stat">
                            <p>効率</p>
                            <p>${result.efficiency.toFixed(1)}%</p>
                        </div>
                        <div class="pallet-stat">
                            <p>重量</p>
                            <p>${(result.quantity * result.carton.weight).toFixed(1)}kg</p>
                        </div>
                    </div>
                    <div class="pallet-details">
                        <p>貨物: ${result.carton.code}</p>
                        <div class="cargo-list">
                            <div class="cargo-item">
                                <span class="cargo-code">${result.carton.code}</span>
                                <span class="cargo-badge">${result.quantity}個</span>
                            </div>
                        </div>
                        <div class="layer-info">
                            <strong>配置詳細:</strong>
                            <div class="layer-item">
                                ${result.layout.x}列 × ${result.layout.y}行 × ${result.layout.layers}層
                                ${result.orientation.rotated ? '(回転配置)' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="diagram-container">
                        <div class="diagram-tabs">
                            <button class="diagram-tab active" onclick="showDiagramView(${palletNumber}, 'side')">側面図</button>
                            <button class="diagram-tab" onclick="showDiagramView(${palletNumber}, 'top')">上面図</button>
                        </div>
                        <div class="diagram-content">
                            <div id="diagram-${palletNumber}-side" class="diagram-view active">
                                <canvas id="canvas-${palletNumber}-side" class="pallet-canvas" width="400" height="300"></canvas>
                            </div>
                            <div id="diagram-${palletNumber}-top" class="diagram-view">
                                <canvas id="canvas-${palletNumber}-top" class="pallet-canvas" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showDiagramView(palletNumber, viewType) {
            // タブの切り替え
            document.querySelectorAll(`#pallet-${palletNumber} .diagram-tab`).forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`#pallet-${palletNumber} .diagram-tab[onclick*="${viewType}"]`).classList.add('active');
            
            // ビューの切り替え
            document.querySelectorAll(`#pallet-${palletNumber} .diagram-view`).forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`diagram-${palletNumber}-${viewType}`).classList.add('active');
            
            // キャンバス描画
            drawPalletDiagram(palletNumber, viewType);
        }

        function drawPalletDiagram(palletNumber, viewType) {
            const canvas = document.getElementById(`canvas-${palletNumber}-${viewType}`);
            const ctx = canvas.getContext('2d');
            
            // 簡単な図形描画
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e9ecef';
            ctx.fillRect(50, 50, 300, 200);
            ctx.strokeStyle = '#6c757d';
            ctx.strokeRect(50, 50, 300, 200);
            
            ctx.fillStyle = '#007bff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${viewType === 'side' ? '側面図' : '上面図'}`, canvas.width / 2, canvas.height / 2);
        }

        function updateSummaryTable(results) {
            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = results.map((result, index) => `
                <tr>
                    <td><span class="pallet-link" onclick="scrollToPallet(${index + 1})">${index + 1}</span></td>
                    <td>${result.palletSize.width}×${result.palletSize.depth}×${result.height.toFixed(1)}</td>
                    <td>${(result.quantity * result.carton.weight).toFixed(1)}</td>
                    <td>${result.carton.code}</td>
                    <td>${result.quantity}</td>
                </tr>
            `).join('');
        }

        function updateCombineSelectors(results) {
            const selectors = ['pallet1Select', 'pallet2Select'];
            selectors.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">選択...</option>' + 
                    results.map((_, index) => `<option value="${index + 1}">パレット ${index + 1}</option>`).join('');
            });
        }

        function scrollToPallet(palletNumber) {
            document.getElementById(`pallet-${palletNumber}`).scrollIntoView({ behavior: 'smooth' });
        }

        // パレット結合機能
        function combinePallets() {
            alert('パレット結合機能は開発中です');
        }

        function autoOptimizePallets() {
            alert('自動最適化機能は開発中です');
        }

        function analyzeSelectedPallets() {
            alert('詳細分析機能は開発中です');
        }

        function updateCombinePreview() {
            const preview = document.getElementById('combinePreview');
            preview.textContent = '2つのパレットを選択してください';
        }

        function exportSummaryCsv() {
            if (!window.currentPallets || window.currentPallets.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            const headers = ['パレットNo', '寸法(cm)', '重量(kg)', '貨物コード', '数量'];
            const rows = window.currentPallets.map((result, index) => [
                index + 1,
                `${result.palletSize.width}×${result.palletSize.depth}×${result.height.toFixed(1)}`,
                (result.quantity * result.carton.weight).toFixed(1),
                result.carton.code,
                result.quantity
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `パレタイズ結果_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // ユーティリティ関数
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            document.getElementById('errors').appendChild(errorDiv);
        }

        function clearErrors() {
            document.getElementById('errors').innerHTML = '';
        }

        // グローバル関数として定義
        window.showDiagramView = showDiagramView;
        window.scrollToPallet = scrollToPallet;
        window.setHeightLimit = setHeightLimit;
    </script>
</body>
</html>