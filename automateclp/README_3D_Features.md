# 🚢 AutomateCLP 3D Stacking Features

## 概要
AutomateCLP（Container Loading Planner）に3D積み重ね機能を追加し、より効率的で現実的なコンテナ積載計画を作成できるようになりました。

## ✨ 新機能一覧

### 1. 40HQコンテナ対応
- **20FT**: 589.8cm × 235.2cm × 238.5cm
- **40FT**: 1203.2cm × 235.0cm × 238.5cm  
- **40HQ**: 1203.2cm × 235.0cm × 269.0cm

### 2. パレット積み重ねオプション
- チェックボックスで3D積み重ねの有効/無効を切り替え
- デフォルトは無効（従来の2D配置）

### 3. パレット番号自動生成
- 追加されたパレットに自動的に連番を付与
- パレット管理の効率化

### 4. 重量・高さフィールド
- **高さ**: 各パレットの高さ(cm)を設定
- **重量**: 各パレットの重量(kg)を設定
- 積み重ね計算に使用

### 5. 積み重ね制約設定
- **上積み可**: 他のパレットの上に積めるかどうか
- **下積み可**: 他のパレットの下に積まれるかどうか
- 両方チェック解除で積み重ね不可

### 6. 3D積み重ねアルゴリズム
- 重量・重心・安定性を考慮した最適配置
- 積み重ね制約の遵守
- 高さ・重量制限の適用

### 7. 重心計算と安定性分析
- 積み重ねの安定性を数値で評価
- コンテナ中心からの重心距離を計算
- 安定性スコア（0-100）を表示

### 8. デバッグ機能
- 積み重ねテスト
- 重心計算テスト
- レイアウト解析

## 🔧 使用方法

### 基本設定
1. **3D積み重ねを有効化**: 「パレット積み重ねを有効にする」にチェック
2. **コンテナタイプ選択**: 20FT/40FT/40HQから選択
3. **パレット情報入力**: 寸法・高さ・重量・積み重ね制約を設定

### パレット追加
1. **プリセットボタン**: 標準サイズのパレットをワンクリックで追加
2. **手動入力**: カスタムサイズのパレットを手動で入力
3. **制約設定**: 積み重ね制約を個別に設定

### 積載計算
1. **自動配置**: 「積載プランを計算」ボタンで最適配置を実行
2. **3D積み重ね**: 重量・重心・安定性を考慮した配置
3. **結果表示**: 積み重ね状態・使用率・安定性を表示

## 📊 アルゴリズム詳細

### 積み重ね条件
- **サイズ制約**: 上に積むパレットは下のパレットより小さい必要
- **重量制限**: 積み重ね重量上限2000kg
- **高さ制限**: コンテナ高さ内での積み重ね
- **制約遵守**: 積み重ね制約の正確な適用

### 最適化基準
- **重心安定性**: コンテナ中心に近い配置を優先
- **重量分布**: 重いパレットを下に配置
- **高さ効率**: 高さ方向の空間活用
- **面積効率**: 従来の2D配置も維持

### 安定性計算
```
安定性スコア = 100 - (重心距離 / 最大距離) × 100
安定性 > 70: 安定
安定性 < 70: 不安定
```

## 🐛 デバッグ機能

### 積み重ねテスト
- パレットの積み重ね設定と制約を確認
- 積み重ね可能なパレット数を表示

### 重心計算テスト
- 配置済みパレットの重心と安定性を計算
- 各パレットの詳細情報を表示

### レイアウト解析
- 現在のレイアウトの詳細情報を分析
- 面積・高さ使用率・重量分布を計算

## 📈 パフォーマンス向上

### 効率化
- **面積使用率**: 従来の2D配置を維持
- **体積使用率**: 3D積み重ねで高さ方向も活用
- **重量最適化**: 重心安定性を考慮した配置

### 安定性向上
- **重心最適化**: コンテナ中心に近い配置
- **重量分布**: 下重上軽の原則
- **制約遵守**: 積み重ね制約の正確な適用

## 🔍 技術仕様

### データ構造
```javascript
{
  id: Date.now(),
  palletNumber: 1,           // 自動生成される連番
  length: 120,               // 長さ(cm)
  width: 100,                // 幅(cm)
  height: 120,               // 高さ(cm)
  weight: 600,               // 重量(kg)
  qty: 5,                    // 数量
  canStackAbove: true,       // 上積み可能
  canStackBelow: true,       // 下積み可能
  color: "#f39c12",          // 表示色
  x: 0, y: 0, z: 0,         // 3D座標
  stackedOn: null,           // 積み重ね先
  stackedBy: []              // 上に積まれているパレット
}
```

### 主要関数
- `perform3DStacking()`: 3D積み重ね処理のメイン関数
- `findBestStackPosition()`: 最適な積み重ね位置を探索
- `calculateStackingScore()`: 積み重ねスコアを計算
- `calculateStackingStability()`: 積み重ね安定性を計算

## 🧪 テスト方法

### 基本テスト
1. **test_features.html** を開いて機能一覧を確認
2. **index.html** で実際のアプリをテスト
3. 各デバッグボタンで機能を検証

### テストケース
- **3D積み重ねテスト**: 110×110×120cm (12個) + 100×125×100cm (8個)
- **制約テスト**: 積み重ね制約の動作確認
- **安定性テスト**: 重心計算と安定性評価

## 🚀 今後の拡張予定

### 短期目標
- [ ] より高度な積み重ねアルゴリズム
- [ ] 複数コンテナ対応
- [ ] 輸送条件の考慮

### 長期目標
- [ ] 機械学習による最適化
- [ ] リアルタイム協調編集
- [ ] クラウド連携

## 📝 変更履歴

### v2.0.0 (2024-12-19)
- 3D積み重ね機能を追加
- 40HQコンテナ対応
- 重量・高さフィールド追加
- 積み重ね制約設定
- 重心計算と安定性分析
- デバッグ機能追加

### v1.0.0 (初期版)
- 基本的な2D配置機能
- 20FT/40FTコンテナ対応
- 手動調整機能

## 🤝 貢献

バグ報告や機能要望は、以下の方法でお知らせください：
1. GitHub Issues
2. 直接連絡
3. プルリクエスト

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

---

**注意**: このアプリは教育・研究目的で作成されています。実際の物流業務で使用する場合は、十分なテストと検証を行ってください。