<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インタラクティブガントチャート</title>
    <style>
        /* CSS extracted from gantt.js and enhanced */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Yu Gothic', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: #f5f7fa;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-title {
            background: transparent;
            border: 2px dashed transparent;
            color: white;
            font-size: 24px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 200px;
            cursor: text;
            transition: all 0.2s ease;
        }
        
        .project-title:hover, .project-title:focus {
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            outline: none;
        }
        
        .toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }
        
        .btn-success { background: #34a853; }
        .btn-success:hover { background: #2d8f47; }
        
        .btn-warning { background: #fbbc04; color: #333; }
        .btn-warning:hover { background: #f9ab00; }
        
        .btn-danger { background: #ea4335; }
        .btn-danger:hover { background: #d33b2c; }
        
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        
        .btn-disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        .btn-disabled:hover {
            background: #6c757d !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .gantt-container {
            height: calc(100vh - 140px);
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #gantt_here {
            width: 100%;
            height: 100%;
        }
        
        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
            color: #666;
            font-size: 14px;
            margin-left: auto;
        }
        
        .status-badge {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            cursor: pointer;
        }
        
        /* Enhanced Gantt styles */
        .gantt_task_line.high_priority {
            background: #ff5722 !important;
            border: 2px solid #d84315 !important;
        }
        
        .gantt_task_line.medium_priority {
            background: #ff9800 !important;
            border: 2px solid #f57c00 !important;
        }
        
        .gantt_task_line.low_priority {
            background: #4caf50 !important;
            border: 2px solid #388e3c !important;
        }
        
        /* Completed tasks (100% progress) - Dark Gray */
        .gantt_task_line.completed {
            background: #424242 !important;
            border: 2px solid #212121 !important;
            opacity: 0.9;
        }
        
        .gantt_row.completed_row {
            background-color: #eeeeee !important;
            color: #424242 !important;
        }
        
        .gantt_row.completed_row .gantt_cell {
            color: #424242 !important;
        }
        
        /* Parent tasks (大項目) - Blue color */
        .gantt_task_line.parent_task {
            background: #2196f3 !important;
            border: 2px solid #1976d2 !important;
            font-weight: bold;
        }
        
        .gantt_row.parent_row {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }
        
        .gantt_row.parent_row .gantt_cell {
            font-weight: bold;
            color: #1976d2;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 20px;
            border-radius: 8px;
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Context menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .context-menu-item:hover {
            background: #f5f5f5;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .link-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Weekend styling for scale cells */
        .gantt_scale_cell.weekend {
            background-color: #f5f5f5 !important;
            color: #999 !important;
        }
        
        /* Weekend styling for task area */
        .gantt_task_cell.weekend {
            background-color: #f8f8f8 !important;
        }
        
        /* Weekend styling for grid rows */
        .gantt_row.weekend {
            background-color: #f8f8f8 !important;
        }
        
        /* Month header styling */
        .gantt_scale_line:first-child {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef) !important;
            border-bottom: 2px solid #dee2e6 !important;
            font-weight: 600 !important;
            color: #495057 !important;
        }
        
        /* Day header styling */
        .gantt_scale_line:last-child {
            background: #ffffff !important;
            border-bottom: 1px solid #e1e5e9 !important;
        }
        
        /* Month header weekend styling */
        .gantt_scale_line:first-child .gantt_scale_cell {
            color: #495057 !important;
        }
        
        /* Priority cell styling */
        .priority-cell, .department-cell {
            transition: all 0.2s ease !important;
            border: 1px solid transparent !important;
        }
        
        .priority-cell:hover, .department-cell:hover {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
            transform: scale(1.05);
        }
        
        .priority-cell:active, .department-cell:active {
            transform: scale(0.95);
        }
        
        /* Custom column resize handle styling */
        .custom-resize-handle {
            transition: background-color 0.2s ease;
        }
        
        .custom-resize-handle:hover {
            background: #007bff !important;
        }
        
        /* Modal improvements for better visibility */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
            max-height: 120px;
        }
        
        .modal-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 0 0 0;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <input type="text" class="project-title" id="projectTitle" value="プロジェクト管理表" 
               placeholder="プロジェクト名を入力">
    </div>
    
    <div class="toolbar">
        <button class="btn" onclick="addTask()">
            ➕ タスク追加
        </button>
        <button class="btn btn-success" onclick="addSubTask()">
            ➕ サブタスク追加
        </button>
        <div class="file-input-wrapper">
            <label class="btn btn-info file-input-label">
                📂 インポート
                <input type="file" id="importFile" accept=".json,.xml" onchange="importData(event)">
            </label>
        </div>
        <button class="btn btn-success" onclick="exportData()">
            💾 エクスポート
        </button>
        <button class="btn" onclick="toggleView()">
            📅 表示切替
        </button>
        <button class="btn" onclick="undoAction()" title="元に戻す (Ctrl+Z)">
            ↩️ 元に戻す
        </button>
        <button class="btn" onclick="redoAction()" title="やり直し (Ctrl+Y)">
            ↪️ やり直し
        </button>
        
        <div class="status-info">
            <span>総タスク数: <span class="status-badge" id="task-count">0</span></span>
            <span>進捗率: <span class="status-badge" id="overall-progress">0%</span></span>
        </div>
    </div>
    
    <div class="gantt-container">
        <div id="gantt_here"></div>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">新しいタスクを追加</h3>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskText">タスク名:</label>
                    <input type="text" id="taskText" name="text" required placeholder="短いタスク名を入力">
                </div>
                <div class="form-group">
                    <label for="taskDescription">タスク内容:</label>
                    <textarea id="taskDescription" name="description" rows="3" placeholder="詳細な内容・説明を入力" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskStartDate">開始日:</label>
                    <input type="date" id="taskStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="taskEndDate">終了日:</label>
                    <input type="date" id="taskEndDate" name="end_date" required>
                </div>
                <div class="form-group">
                    <label for="taskPriority">優先度:</label>
                    <select id="taskPriority" name="priority">
                        <option value="low">🟢 低</option>
                        <option value="medium" selected>🟡 中</option>
                        <option value="high">🔴 高</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskProgress">進捗 (%):</label>
                    <input type="number" id="taskProgress" name="progress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="taskDepartment">担当箇所:</label>
                    <input type="text" id="taskDepartment" name="department" placeholder="担当箇所を入力">
                </div>
                <div class="modal-buttons" style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; background: white; position: sticky; bottom: 0;">
                    <button type="submit" class="btn btn-success">タスク保存</button>
                    <button type="button" class="btn" onclick="closeTaskModal()">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="contextAddSubTask()">サブタスク追加</div>
        <div class="context-menu-item" onclick="contextEditTask()">タスク編集</div>
        <div class="context-menu-item" onclick="contextLinkTask()">タスクリンク作成</div>
        <div class="context-menu-item" onclick="contextDeleteTask()">タスク削除</div>
    </div>

    <!-- Local DHTMLX Gantt JS with CDN fallback -->
    <script>
        // First try to load local gantt.js, fallback to CDN if it fails
        function loadGanttScript() {
            return new Promise((resolve, reject) => {
                const localScript = document.createElement('script');
                localScript.src = 'gantt.js';
                localScript.onload = () => {
                    if (typeof gantt !== 'undefined') {
                        console.log('ローカルのgantt.jsを読み込みました');
                        resolve();
                    } else {
                        console.warn('ローカルgantt.jsが見つかりません、CDNから読み込みます...');
                        loadFromCDN().then(resolve).catch(reject);
                    }
                };
                localScript.onerror = () => {
                    console.warn('ローカルgantt.jsの読み込みに失敗しました、CDNから読み込みます...');
                    loadFromCDN().then(resolve).catch(reject);
                };
                document.head.appendChild(localScript);
            });
        }

        function loadFromCDN() {
            return new Promise((resolve, reject) => {
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.7/codebase/dhtmlxgantt.js';
                cdnScript.onload = () => {
                    if (typeof gantt !== 'undefined') {
                        console.log('CDNからgantt.jsを読み込みました');
                        resolve();
                    } else {
                        reject(new Error('CDNからのgantt読み込みに失敗しました'));
                    }
                };
                cdnScript.onerror = () => reject(new Error('CDNからのgantt読み込みに失敗しました'));
                document.head.appendChild(cdnScript);
            });
        }

        function loadGanttCSS() {
            const localCSS = document.createElement('link');
            localCSS.rel = 'stylesheet';
            localCSS.href = 'dhtmlxgantt.css';
            localCSS.onerror = () => {
                console.warn('ローカルCSSの読み込みに失敗、CDNを使用します...');
                const cdnCSS = document.createElement('link');
                cdnCSS.rel = 'stylesheet';
                cdnCSS.href = 'https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.7/codebase/dhtmlxgantt.css';
                document.head.appendChild(cdnCSS);
            };
            document.head.appendChild(localCSS);
        }

        loadGanttCSS();

        // Global variables
        let selectedTaskId = null;
        let contextTaskId = null;
        let editingTaskId = null;
        let viewMode = 'day';
        let linkSourceTask = null;
        
        // Custom UNDO/REDO implementation
        let undoStack = [];
        let redoStack = [];
        const maxUndoSteps = 20;

        loadGanttScript().then(() => {
            initializeGantt();
        }).catch(error => {
            console.error('ガントライブラリの読み込みに失敗しました:', error);
            document.getElementById('gantt_here').innerHTML = 
                '<div style="padding: 20px; text-align: center; color: red;">' +
                '<h3>ガントチャートの読み込みエラー</h3>' +
                '<p>ガントライブラリの読み込みに失敗しました。gantt.jsが同じディレクトリにあることを確認してください。</p>' +
                '<p>エラー: ' + error.message + '</p>' +
                '</div>';
        });

        function initializeGantt() {
            // Japanese localization
            gantt.i18n.setLocale({
                date: {
                    month_full: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
                    month_short: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
                    day_full: ["日曜日", "月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日"],
                    day_short: ["日", "月", "火", "水", "木", "金", "土"]
                },
                labels: {
                    new_task: "新しいタスク",
                    icon_save: "保存",
                    icon_cancel: "キャンセル",
                    icon_details: "詳細",
                    icon_edit: "編集",
                    icon_delete: "削除",
                    confirm_closing: "",
                    confirm_deleting: "タスクを削除してもよろしいですか？",
                    section_description: "説明",
                    section_time: "期間",
                    section_type: "タイプ"
                }
            });
        
            // Enhanced Gantt Chart Configuration
            gantt.config.date_format = "%Y-%m-%d %H:%i";
            gantt.config.scale_height = 54;
            gantt.config.row_height = 30;
            
            // Configure scales for day view with month header
            gantt.config.scales = [
                {unit: "month", step: 1, format: "%Y年%m月"},
                {unit: "day", step: 1, format: "%d日(%D)"}
            ];
            
            // Custom date scale template with Japanese day names for the day scale
            gantt.templates.date_scale = function(date) {
                const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
                const day = date.getDate();
                const dayOfWeek = dayNames[date.getDay()];
                return day + "日(" + dayOfWeek + ")";
            };
            
            // Weekend detection for scale cells
            gantt.templates.scale_cell_class = function(date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    return "weekend";
                }
                return "";
            };
            
            // Weekend detection for task area
            gantt.templates.timeline_cell_class = function(task, date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    return "weekend";
                }
                return "";
            };
            
            // Enable advanced features
            gantt.config.drag_links = true;
            gantt.config.drag_progress = true;
            gantt.config.drag_resize = true;
            gantt.config.order_branch = true;
            gantt.config.order_branch_free = true;
            
            // Enable column resizing
            gantt.config.grid_resize = true;
            gantt.config.grid_resizer_column_attribute = "data-column-name";
            
            // Enable plugins if available
            if (gantt.plugins) {
                gantt.plugins({
                    click_drag: true,
                    tooltip: true
                    // undo plugin removed - using custom implementation
                });
            }
            
            // Enable column resizing after initialization
            gantt.config.grid_resize = true;
            
            // Grid configuration
            gantt.config.columns = [
                {name: "text", label: "タスク名", width: 220, tree: true, resize: true},
                {name: "start_date", label: "開始日", width: 80, resize: true},
                {name: "duration", label: "期間", width: 50, align: "center", resize: true},
                {name: "progress", label: "進捗率", width: 60, resize: true, template: function(obj) {
					return `<span class="progress-cell" data-task-id="${obj.id}" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa;">${Math.round(obj.progress * 100)}%</span>`;}},
                
                {name: "priority", label: "優先度", width: 80, resize: true, template: function(obj) {
                    const priorities = {high: "🔴 高", medium: "🟡 中", low: "🟢 低"};
                    const priorityText = priorities[obj.priority] || "🔵 通常";
                    return `<span class="priority-cell" data-task-id="${obj.id}" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa;">${priorityText}</span>`;
                }},
                {name: "department", label: "担当箇所", width: 100, resize: true, template: function(obj) {
                    const departmentText = obj.department || "未設定";
                    return `<span class="department-cell" data-task-id="${obj.id}" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa;">${departmentText}</span>`;
                }},
                {name: "add", label: "", width: 44}
            ];
            
            // Custom templates
            gantt.templates.task_class = function(start, end, task) {
                let classes = [];
                
                // Priority-based classes
                if (task.priority) classes.push(task.priority + "_priority");
                
                // Completed tasks (100% progress)
                if (task.progress >= 1) classes.push("completed");
                
                // Parent tasks (大項目) - different color
                if (gantt.hasChild(task.id)) {
                    classes.push("parent_task");
                }
                
                return classes.join(" ");
            };
            
            gantt.templates.grid_row_class = function(start, end, task) {
                let classes = [];
                
                // Completed tasks styling for grid rows
                if (task.progress >= 1) classes.push("completed_row");
                
                // Parent tasks styling for grid rows
                if (gantt.hasChild(task.id)) {
                    classes.push("parent_row");
                }
                
                return classes.join(" ");
            };
            
            gantt.templates.task_text = function(start, end, task) {
                return task.text; // タスク名のみ表示
            };
            
            gantt.templates.tooltip_text = function(start, end, task) {
                const priority = task.priority ? {high: "高", medium: "中", low: "低"}[task.priority] : "通常";
                const department = task.department || "未設定";
                const description = task.description || "内容なし";
                return `<b>タスク名:</b> ${task.text}<br/>
                        <b>タスク内容:</b> ${description}<br/>
                        <b>開始日:</b> ${gantt.templates.tooltip_date_format(start)}<br/>
                        <b>終了日:</b> ${gantt.templates.tooltip_date_format(end)}<br/>
                        <b>進捗:</b> ${Math.round(task.progress * 100)}%<br/>
                        <b>優先度:</b> ${priority}<br/>
                        <b>担当箇所:</b> ${department}<br/>
                        <b>期間:</b> ${task.duration} 日`;
            };
            
            // Initialize the Gantt chart
            gantt.init("gantt_here");
            
            // Japanese warehouse operation sample data
            gantt.parse({
                data: [
                    {id: 1, text: "倉庫運営システム導入", description: "新しい倉庫管理システムの導入プロジェクト全体", start_date: null, duration: null, parent: 0, progress: 0, open: true, priority: "high", department: "本社"},
                    
                    // Phase 1: Planning
                    {id: 2, text: "計画フェーズ", description: "プロジェクトの計画立案と要件定義", start_date: null, duration: null, parent: 1, progress: 0.3, open: true, priority: "high", department: "企画部"},
                    {id: 3, text: "要件定義", description: "システムの機能要件と非機能要件の定義", start_date: "2025-08-01 00:00", duration: 5, parent: 2, progress: 0.8, priority: "high", department: "企画部"},
                    {id: 4, text: "現状分析", description: "現在の倉庫運営プロセスの調査と分析", start_date: "2025-08-06 00:00", duration: 3, parent: 2, progress: 0.5, priority: "medium", department: "業務部"},
                    {id: 5, text: "システム設計", description: "要件に基づいたシステムアーキテクチャの設計", start_date: "2025-08-09 00:00", duration: 7, parent: 2, progress: 0.2, priority: "high", department: "IT部"},
                    
                    // Phase 2: Infrastructure
                    {id: 6, text: "インフラ整備", description: "システム稼働のためのインフラ環境構築", start_date: null, duration: null, parent: 1, progress: 0.1, open: true, priority: "medium", department: "IT部"},
                    {id: 7, text: "ネットワーク構築", description: "倉庫内ネットワークの設計と構築", start_date: "2025-08-16 00:00", duration: 5, parent: 6, progress: 0.3, priority: "medium", department: "IT部"},
                    {id: 8, text: "サーバー設置", description: "システム用サーバーの設置と環境設定", start_date: "2025-08-21 00:00", duration: 3, parent: 6, progress: 0, priority: "medium", department: "設備部"},
                    {id: 9, text: "セキュリティ設定", description: "アクセス制御とセキュリティポリシーの設定", start_date: "2025-08-24 00:00", duration: 2, parent: 6, progress: 0, priority: "high", department: "IT部"},
                    
                    // Phase 3: Software Development
                    {id: 10, text: "ソフトウェア開発", description: "倉庫管理システムの開発フェーズ", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "開発部"},
                    {id: 11, text: "在庫管理システム", description: "商品の入出庫と在庫状況を管理するシステム", start_date: "2025-08-26 00:00", duration: 10, parent: 10, progress: 0, priority: "high", department: "開発部"},
                    {id: 12, text: "配送管理システム", description: "配送計画と配送状況を管理するシステム", start_date: "2025-09-05 00:00", duration: 8, parent: 10, progress: 0, priority: "medium", department: "物流部"},
                    {id: 13, text: "レポート機能", description: "各種運営データのレポート出力機能", start_date: "2025-09-13 00:00", duration: 5, parent: 10, progress: 0, priority: "low", department: "経営企画"},
                    
                    // Phase 4: Testing
                    {id: 14, text: "テスト・検証", description: "システムの品質保証とテスト実施", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "品質保証"},
                    {id: 15, text: "単体テスト", description: "個別機能の動作確認テスト", start_date: "2025-09-18 00:00", duration: 5, parent: 14, progress: 0, priority: "medium", department: "品質保証"},
                    {id: 16, text: "統合テスト", description: "システム全体の連携動作テスト", start_date: "2025-09-23 00:00", duration: 7, parent: 14, progress: 0, priority: "high", department: "品質保証"},
                    {id: 17, text: "運用テスト", description: "実際の運用環境での動作確認テスト", start_date: "2025-09-30 00:00", duration: 5, parent: 14, progress: 0, priority: "high", department: "運用部"},
                    
                    // Phase 5: Deployment
                    {id: 18, text: "本稼働", description: "システムの本格運用開始", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "運用部"},
                    {id: 19, text: "データ移行", description: "既存データの新システムへの移行", start_date: "2025-10-05 00:00", duration: 3, parent: 18, progress: 0, priority: "high", department: "IT部"},
                    {id: 20, text: "スタッフ研修", description: "新システムの操作方法に関するスタッフ研修", start_date: "2025-10-08 00:00", duration: 5, parent: 18, progress: 0, priority: "medium", department: "人事部"},
                    {id: 21, text: "本稼働開始", description: "新システムでの正式運用開始", start_date: "2025-10-13 00:00", duration: 1, parent: 18, progress: 0, priority: "high", department: "全社"}
                ],
                links: [
                    {id: 1, source: 3, target: 4, type: "0"},
                    {id: 2, source: 4, target: 5, type: "0"},
                    {id: 3, source: 5, target: 7, type: "0"},
                    {id: 4, source: 7, target: 8, type: "0"},
                    {id: 5, source: 8, target: 9, type: "0"},
                    {id: 6, source: 9, target: 11, type: "0"},
                    {id: 7, source: 11, target: 12, type: "0"},
                    {id: 8, source: 12, target: 13, type: "0"},
                    {id: 9, source: 13, target: 15, type: "0"},
                    {id: 10, source: 15, target: 16, type: "0"},
                    {id: 11, source: 16, target: 17, type: "0"},
                    {id: 12, source: 17, target: 19, type: "0"},
                    {id: 13, source: 19, target: 20, type: "0"},
                    {id: 14, source: 20, target: 21, type: "0"}
                ]
            });
            
            // Enhanced linked task movement
            gantt.attachEvent("onAfterTaskDrag", function(id, mode, e) {
                if (mode === "resize" || mode === "move") {
                    updateLinkedTasks(id);
                }
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onAfterTaskAdd", function(id, task) {
                saveUndoState("add", {id: id, task: gantt.serialize()});
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onAfterTaskUpdate", function(id, task) {
                updateLinkedTasks(id);
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onAfterTaskDelete", function(id, task) {
                saveUndoState("delete", {id: id, task: task, data: gantt.serialize()});
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onBeforeTaskDelete", function(id, task) {
                // Save state before deletion for undo
                saveUndoState("delete", {
                    id: id, 
                    task: Object.assign({}, task),
                    beforeState: gantt.serialize()
                });
                return true;
            });
            
            // Context menu functionality
            gantt.attachEvent("onTaskRightClick", function(id, e) {
                e.preventDefault();
                contextTaskId = id;
                showContextMenu(e.clientX, e.clientY);
                return false;
            });
            
            gantt.attachEvent("onTaskClick", function(id, e) {
                selectedTaskId = id;
                return true;
            });
            
            // Custom task editing on double click
            gantt.attachEvent("onTaskDblClick", function(id, e) {
                const task = gantt.getTask(id);
                showTaskModal("タスクを編集", task);
                return false; // Prevent default lightbox
            });
            
            // Disable default lightbox
            gantt.config.details_on_dblclick = false;
            gantt.config.details_on_create = false;
            
            // Priority column click functionality
            gantt.attachEvent("onGridHeaderClick", function(name, e) {
                return true;
            });
            
            // Add click event for priority and department cells
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('priority-cell')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    cyclePriority(taskId);
                } else if (e.target.classList.contains('department-cell')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    editDepartment(taskId);
                }
            });
            
            // Initialize column resizing functionality
            setTimeout(function() {
                initColumnResize();
            }, 1500);
            
// Re-initialize column resize after render
gantt.attachEvent("onGanttRender", function() {
    setTimeout(function() {
        initColumnResize();
    }, 0);
});

// Double-click handler for progress cells (onGanttRenderの外に移動)
gantt.$container.addEventListener('dblclick', function(e) {
    if (e.target.classList.contains('progress-cell')) {
        e.preventDefault();
        const taskId = e.target.dataset.taskId;
        const task = gantt.getTask(taskId);
        
        const currentProgress = Math.round(task.progress * 100);
        const newProgress = prompt(`進捗率を入力してください (0-100):`, currentProgress);
        
        if (newProgress !== null && !isNaN(newProgress)) {
            const progressValue = Math.max(0, Math.min(100, parseInt(newProgress)));
            task.progress = progressValue / 100;
            gantt.updateTask(taskId);
            autoSave();
        }
    }
});
            
            // Initialize stats
            updateStats();
            autoLoad();
            
            // Save initial state for undo
            saveInitialState();
            
            // Initialize button states
            setTimeout(updateUndoRedoButtons, 100);
            
            console.log('ガントチャートが正常に初期化されました！');
        }

        // Custom column resize implementation - Enhanced
        function initColumnResize() {
            // Remove existing handles first
            const existingHandles = document.querySelectorAll('.custom-resize-handle');
            existingHandles.forEach(handle => handle.remove());
            
            const gridHeaders = document.querySelectorAll('.gantt_grid_head_cell');
            
            gridHeaders.forEach(function(header, index) {
                // Skip the last column (add button)
                if (index >= gantt.config.columns.length - 1) return;
                
                // Skip if already has handle
                if (header.querySelector('.custom-resize-handle')) return;
                
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'custom-resize-handle';
                resizeHandle.style.cssText = `
                    position: absolute;
                    right: -3px;
                    top: 0;
                    bottom: 0;
                    width: 6px;
                    cursor: col-resize;
                    background: transparent;
                    z-index: 1000;
                    border-right: 2px solid transparent;
                `;
                
                resizeHandle.addEventListener('mouseenter', function() {
                    this.style.borderRight = '2px solid #007bff';
                });
                
                resizeHandle.addEventListener('mouseleave', function() {
                    this.style.borderRight = '2px solid transparent';
                });
                
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;
                
                resizeHandle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = header.offsetWidth;
                    
                    document.body.style.cursor = 'col-resize';
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                function onMouseMove(e) {
                    if (!isResizing) return;
                    
                    const currentX = e.clientX;
                    const diffX = currentX - startX;
                    const newWidth = Math.max(50, startWidth + diffX); // Minimum width of 50px
                    
                    // Update the column width in gantt config
                    gantt.config.columns[index].width = newWidth;
                    
                    // Re-render the gantt to apply changes
                    gantt.render();
                    
                    e.preventDefault();
                }
                
                function onMouseUp(e) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    
                    // Re-initialize handles after render
                    setTimeout(function() {
                        initColumnResize();
                    }, 100);
                }
                
                header.style.position = 'relative';
                header.appendChild(resizeHandle);
            });
        }

        // Priority cycling function
        function cyclePriority(taskId) {
            if (!gantt.isTaskExists(taskId)) return;
            
            // Save state before change
            saveUndoState("priority_change", gantt.serialize());
            
            const task = gantt.getTask(taskId);
            const priorities = ['low', 'medium', 'high'];
            const currentIndex = priorities.indexOf(task.priority || 'medium');
            const nextIndex = (currentIndex + 1) % priorities.length;
            
            task.priority = priorities[nextIndex];
            gantt.updateTask(taskId);
            updateStats();
        }

        // Department editing function
        function editDepartment(taskId) {
            if (!gantt.isTaskExists(taskId)) return;
            
            const task = gantt.getTask(taskId);
            const currentDepartment = task.department || '未設定';
            
            let newDepartment = prompt(`担当箇所を入力してください:`, currentDepartment);
            
            if (newDepartment !== null && newDepartment.trim() !== '' && newDepartment.trim() !== currentDepartment) {
                // Save state before change
                saveUndoState("department_change", gantt.serialize());
                
                task.department = newDepartment.trim();
                gantt.updateTask(taskId);
                updateStats();
            }
        }

        // Enhanced linked task movement functionality
        function updateLinkedTasks(movedTaskId) {
            if (!gantt.isTaskExists(movedTaskId)) return;
            
            const movedTask = gantt.getTask(movedTaskId);
            const links = gantt.getLinks();
            
            // Update all dependent tasks
            links.forEach(link => {
                if (link.source == movedTaskId && link.type == "0") { // finish-to-start
                    updateDependentTask(link.target, movedTask.end_date);
                } else if (link.source == movedTaskId && link.type == "1") { // start-to-start
                    updateDependentTask(link.target, movedTask.start_date, true);
                }
            });
        }
        
        function updateDependentTask(taskId, predecessorDate, startToStart = false) {
            if (!gantt.isTaskExists(taskId)) return;
            
            const task = gantt.getTask(taskId);
            let newStartDate;
            
            if (startToStart) {
                newStartDate = new Date(predecessorDate);
            } else {
                newStartDate = gantt.date.add(predecessorDate, 1, "day");
            }
            
            // Only update if the new date is different
            if (task.start_date.getTime() !== newStartDate.getTime()) {
                task.start_date = newStartDate;
                task.end_date = gantt.calculateEndDate(newStartDate, task.duration);
                gantt.updateTask(taskId);
                
                // Recursively update tasks that depend on this one
                updateLinkedTasks(taskId);
            }
        }

        // Hide context menu on click elsewhere
        document.addEventListener('click', function() {
            hideContextMenu();
        });
        
        // Auto-save every 30 seconds
        setInterval(autoSave, 30000);
        
        // Project title editing
        document.getElementById('projectTitle').addEventListener('blur', function() {
            document.title = this.value;
        });
        
        document.getElementById('projectTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur();
            }
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('taskModal');
            if (e.target === modal) {
                closeTaskModal();
            }
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'n':
                        e.preventDefault();
                        addTask();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redoAction(); // Ctrl+Shift+Z for redo
                        } else {
                            undoAction(); // Ctrl+Z for undo
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redoAction(); // Ctrl+Y for redo
                        break;
                }
            }
        });

        // Global functions accessible from HTML
        
        function showTaskModal(title = "新しいタスクを追加", task = null) {
            document.getElementById('modalTitle').textContent = title;
            
            if (task) {
                document.getElementById('taskText').value = task.text;
                document.getElementById('taskDescription').value = task.description || '';
                
                // Format dates for input fields
                if (task.start_date) {
                    const startDate = new Date(task.start_date);
                    document.getElementById('taskStartDate').value = startDate.toISOString().split('T')[0];
                }
                if (task.end_date) {
                    const endDate = new Date(task.end_date);
                    document.getElementById('taskEndDate').value = endDate.toISOString().split('T')[0];
                }
                
                document.getElementById('taskPriority').value = task.priority || 'medium';
                document.getElementById('taskProgress').value = Math.round((task.progress || 0) * 100);
                document.getElementById('taskDepartment').value = task.department || '';
                editingTaskId = task.id;
            } else {
                document.getElementById('taskForm').reset();
                
                // Set default dates (today and tomorrow)
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                document.getElementById('taskStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('taskEndDate').value = tomorrow.toISOString().split('T')[0];
                
                editingTaskId = null;
            }
            
            document.getElementById('taskModal').style.display = 'block';
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }
        
        function addTask() {
            showTaskModal();
        }
        
        function addSubTask() {
            if (selectedTaskId) {
                showTaskModal("サブタスクを追加");
            } else {
                alert("まず親タスクをクリックして選択してください。");
            }
        }
        
        function contextAddSubTask() {
            selectedTaskId = contextTaskId;
            addSubTask();
            hideContextMenu();
        }
        
        function contextEditTask() {
            if (contextTaskId && typeof gantt !== 'undefined') {
                const task = gantt.getTask(contextTaskId);
                showTaskModal("タスクを編集", task);
            }
            hideContextMenu();
        }
        
        function contextLinkTask() {
            if (!linkSourceTask) {
                linkSourceTask = contextTaskId;
                alert(`タスク "${gantt.getTask(contextTaskId).text}" を選択しました。次にリンク先のタスクを右クリックしてください。`);
            } else {
                createLinkBetweenTasks(linkSourceTask, contextTaskId);
                linkSourceTask = null;
            }
            hideContextMenu();
        }
        
        function createTaskLink() {
            if (selectedTaskId) {
                if (!linkSourceTask) {
                    linkSourceTask = selectedTaskId;
                    alert(`タスク "${gantt.getTask(selectedTaskId).text}" を選択しました。次にリンク先のタスクをクリックしてください。`);
                } else {
                    createLinkBetweenTasks(linkSourceTask, selectedTaskId);
                    linkSourceTask = null;
                }
            } else {
                alert("まずリンク元のタスクを選択してください。");
            }
        }
        
        function createLinkBetweenTasks(sourceId, targetId) {
            if (sourceId === targetId) {
                alert("同じタスクをリンクすることはできません。");
                return;
            }
            
            // Check if link already exists
            const existingLinks = gantt.getLinks();
            const linkExists = existingLinks.some(link => 
                link.source == sourceId && link.target == targetId
            );
            
            if (linkExists) {
                alert("このリンクは既に存在します。");
                return;
            }
            
            const sourceTask = gantt.getTask(sourceId);
            const targetTask = gantt.getTask(targetId);
            
            // Create the link
            gantt.addLink({
                id: gantt.uid(),
                source: sourceId,
                target: targetId,
                type: "0" // finish-to-start
            });
            
            // Update the target task to start after source ends
            updateDependentTask(targetId, sourceTask.end_date);
            
            alert(`"${sourceTask.text}" から "${targetTask.text}" へのリンクを作成しました。`);
        }
        
        function contextDeleteTask() {
            if (contextTaskId && confirm("このタスクを削除してもよろしいですか？") && typeof gantt !== 'undefined') {
                // Save state before deletion
                saveUndoState("delete_task", gantt.serialize());
                gantt.deleteTask(contextTaskId);
                updateStats();
            }
            hideContextMenu();
        }
        
        function normalizeGanttData(dataset) {
            try {
                if (!dataset || !Array.isArray(dataset.data)) return dataset;
                const ids = new Set(dataset.data.map(t => (typeof t.id === 'string' ? t.id.trim() : t.id)));
                dataset.data.forEach(t => {
                    // Coerce parent to same type as id when possible
                    const tid = t.id;
                    let parent = t.parent;
                    // Treat empty strings/null/undefined as root
                    if (parent === '' || parent === null || parent === undefined) parent = 0;
                    // If parent equals self or parent doesn't exist, reset to root
                    if (parent === tid || !ids.has(parent)) parent = 0;
                    t.parent = parent;
                });
            } catch (e) {
                console.warn('Normalization failed, proceeding without changes', e);
            }
            return dataset;
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file || typeof gantt === 'undefined') return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let data;
                    let projectName = null;
                    
                    if (file.name.endsWith('.json')) {
                        const jsonData = JSON.parse(content);
                        
                        // 新しい形式（プロジェクト名付き）かチェック
                        if (jsonData.projectName && jsonData.projectData) {
                            // 新しい形式
                            projectName = jsonData.projectName;
                            data = jsonData.projectData;
                        } else {
                            // 旧形式（ガントデータのみ）
                            data = jsonData;
                            // ファイル名からプロジェクト名を推測
                            projectName = file.name.replace('_data.json', '').replace('.json', '');
                        }
                    } else if (file.name.endsWith('.xml')) {
                        data = gantt.xml.parse(content);
                        projectName = file.name.replace('.xml', '');
                    } else {
                        throw new Error('サポートされていないファイル形式です');
                    }
                    
                    // プロジェクト名を復元
                    if (projectName) {
                        document.getElementById('projectTitle').value = projectName;
                        document.title = projectName;
                        localStorage.setItem('gantt_project_name', projectName);
                    }
                    
                    // ガントデータを読み込み（不正な親参照を修正）
                    const safeData = normalizeGanttData(data);
                    gantt.clearAll();
                    gantt.parse(safeData);
                    updateStats();
                    
                    alert(`プロジェクト「${projectName || '無名'}」が正常にインポートされました！`);
                } catch (error) {
                    alert('ファイルのインポートエラー: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // ファイル選択をリセット（同じファイルを再選択可能にする）
            event.target.value = '';
        }
        
        function exportData() {
            if (typeof gantt === 'undefined') return;
            const projectName = document.getElementById('projectTitle').value || 'gantt_project';

            // Helper: serialize all tasks and links explicitly to ensure inclusion
            const toStr = gantt.date.date_to_str("%Y-%m-%d %H:%i");
            const manualSerialize = () => {
                const tasks = [];
                gantt.eachTask(function(t){
                    const copy = Object.assign({}, t);
                    if (copy.start_date instanceof Date) copy.start_date = toStr(copy.start_date);
                    if (copy.end_date instanceof Date) copy.end_date = toStr(copy.end_date);
                    tasks.push(copy);
                });
                const links = [];
                (gantt.getLinks() || []).forEach(l => links.push(Object.assign({}, l)));
                return { data: tasks, links: links };
            };

            // Default serialize
            let ganttData = gantt.serialize();

            // Validate counts; fall back to manual if mismatch
            let totalTasks = 0;
            gantt.eachTask(() => { totalTasks++; });
            if (!ganttData || !ganttData.data || ganttData.data.length !== totalTasks) {
                try {
                    ganttData = manualSerialize();
                } catch (e) {
                    console.warn('Manual serialization failed, using default serialize', e);
                }
            }

            const exportData = {
                projectName: projectName,
                projectData: ganttData,
                exportDate: new Date().toISOString(),
                version: "1.0"
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = projectName.replace(/[^\w\s-]/g, '') + '_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function toggleView() {
            if (typeof gantt === 'undefined') return;
            const modes = ['day', 'week', 'month'];
            const currentIndex = modes.indexOf(viewMode);
            viewMode = modes[(currentIndex + 1) % modes.length];
            
            switch(viewMode) {
                case 'week':
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: "%Y年%m月"},
                        {unit: "week", step: 1, format: "%W週"}
                    ];
                    // Reset template for week view
                    gantt.templates.date_scale = null;
                    break;
                case 'month':
                    gantt.config.scales = [
                        {unit: "year", step: 1, format: "%Y年"},
                        {unit: "month", step: 1, format: "%m月"}
                    ];
                    // Reset template for month view
                    gantt.templates.date_scale = null;
                    break;
                default: // day view
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: "%Y年%m月"},
                        {unit: "day", step: 1, format: "%d日(%D)"}
                    ];
                    // Custom template for day view with Japanese day names
                    gantt.templates.date_scale = function(date) {
                        const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
                        const day = date.getDate();
                        const dayOfWeek = dayNames[date.getDay()];
                        return day + "日(" + dayOfWeek + ")";
                    };
            }
            gantt.render();
        }
        
        function updateStats() {
            if (typeof gantt === 'undefined') return;
            let totalTasks = 0;
            let totalProgress = 0;
            
            gantt.eachTask(function(task) {
                if (!gantt.hasChild(task.id)) {
                    totalTasks++;
                    totalProgress += task.progress || 0;
                }
            });
            
            document.getElementById('task-count').textContent = totalTasks;
            document.getElementById('overall-progress').textContent = 
                totalTasks > 0 ? Math.round((totalProgress / totalTasks) * 100) + '%' : '0%';
        }
        
        function autoSave() {
            if (typeof gantt === 'undefined') return;
            try {
                const projectName = document.getElementById('projectTitle').value;
                const ganttData = gantt.serialize();
                
                // プロジェクト名を含めたデータ構造でローカル保存
                const saveData = {
                    projectName: projectName,
                    projectData: ganttData,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('gantt_chart_data', JSON.stringify(saveData));
                localStorage.setItem('gantt_project_name', projectName);
            } catch (e) {
                console.warn('自動保存に失敗しました:', e);
            }
        }
        
        function autoLoad() {
            if (typeof gantt === 'undefined') return;
            const saved = localStorage.getItem('gantt_chart_data');
            const savedName = localStorage.getItem('gantt_project_name');
            
            // プロジェクト名を復元
            if (savedName) {
                document.getElementById('projectTitle').value = savedName;
                document.title = savedName;
            }
            
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    let ganttData;
                    let projectName;
                    
                    // 新しい形式（プロジェクト名付き）かチェック
                    if (savedData.projectName && savedData.projectData) {
                        // 新しい形式
                        projectName = savedData.projectName;
                        ganttData = savedData.projectData;
                        
                        // プロジェクト名を復元
                        document.getElementById('projectTitle').value = projectName;
                        document.title = projectName;
                    } else {
                        // 旧形式（ガントデータのみ）
                        ganttData = savedData;
                    }
                    
                    gantt.clearAll();
                    gantt.parse(ganttData);
                    updateStats();
                } catch (e) {
                    console.warn('保存データの読み込みに失敗しました:', e);
                }
            }
        }
        
        // Custom UNDO/REDO functions
        function saveUndoState(action, data) {
            const currentState = {
                action: action,
                projectName: document.getElementById('projectTitle').value,
                data: gantt.serialize(),
                timestamp: Date.now()
            };
            
            undoStack.push(currentState);
            
            // Limit undo stack size
            if (undoStack.length > maxUndoSteps) {
                undoStack.shift();
            }
            
            // Clear redo stack when new action is performed
            redoStack = [];
            
            // Update button states
            updateUndoRedoButtons();
        }
        
        function undoAction() {
            if (undoStack.length === 0) {
                alert('元に戻す操作がありません。');
                return;
            }
            
            // Save current state to redo stack
            const currentState = {
                action: "redo",
                projectName: document.getElementById('projectTitle').value,
                data: gantt.serialize(),
                timestamp: Date.now()
            };
            redoStack.push(currentState);
            
            // Get previous state
            const previousState = undoStack.pop();
            
            // Restore previous state
            if (previousState.projectName) {
                document.getElementById('projectTitle').value = previousState.projectName;
                document.title = previousState.projectName;
            }
            
            gantt.clearAll();
            gantt.parse(previousState.data);
            updateStats();
            updateUndoRedoButtons();
            
            console.log('UNDO実行: ' + previousState.action);
        }
        
        function redoAction() {
            if (redoStack.length === 0) {
                alert('やり直す操作がありません。');
                return;
            }
            
            // Save current state to undo stack
            const currentState = {
                action: "undo_redo",
                projectName: document.getElementById('projectTitle').value,
                data: gantt.serialize(),
                timestamp: Date.now()
            };
            undoStack.push(currentState);
            
            // Get redo state
            const redoState = redoStack.pop();
            
            // Restore redo state
            if (redoState.projectName) {
                document.getElementById('projectTitle').value = redoState.projectName;
                document.title = redoState.projectName;
            }
            
            gantt.clearAll();
            gantt.parse(redoState.data);
            updateStats();
            updateUndoRedoButtons();
            
            console.log('REDO実行');
        }
        
        function updateUndoRedoButtons() {
            // Update UNDO button
            const undoBtn = document.querySelector('button[onclick="undoAction()"]');
            const redoBtn = document.querySelector('button[onclick="redoAction()"]');
            
            if (undoBtn) {
                if (undoStack.length === 0) {
                    undoBtn.classList.add('btn-disabled');
                    undoBtn.disabled = true;
                } else {
                    undoBtn.classList.remove('btn-disabled');
                    undoBtn.disabled = false;
                }
            }
            
            if (redoBtn) {
                if (redoStack.length === 0) {
                    redoBtn.classList.add('btn-disabled');
                    redoBtn.disabled = true;
                } else {
                    redoBtn.classList.remove('btn-disabled');
                    redoBtn.disabled = false;
                }
            }
            
            console.log('UNDO stack:', undoStack.length, 'REDO stack:', redoStack.length);
        }
        
        // Save initial state for undo
        function saveInitialState() {
            memoryManager.setTimeout(function() {
                if (typeof gantt !== 'undefined') {
                    saveUndoState("initial", {
                        projectName: document.getElementById('projectTitle').value,
                        data: gantt.serialize()
                    });
                    updateUndoRedoButtons();
                }
            }, 2000);
        }
        
        // メモリ管理とパフォーマンス最適化
        const memoryManager = {
            // タイマーの追跡
            timers: new Set(),
            
            // 安全なタイマー設定
            setTimeout: (callback, delay) => {
                const timerId = setTimeout(callback, delay);
                memoryManager.timers.add(timerId);
                return timerId;
            },
            
            // タイマーのクリア
            clearTimeout: (timerId) => {
                clearTimeout(timerId);
                memoryManager.timers.delete(timerId);
            },
            
            // 全タイマーのクリア
            clearAllTimers: () => {
                memoryManager.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                memoryManager.timers.clear();
            },
            
            // メモリクリーンアップ
            cleanup: () => {
                memoryManager.clearAllTimers();
                
                // 大きなデータセットのクリア
                if (undoStack && undoStack.length > 100) {
                    console.log('Large undo stack detected, clearing old data...');
                    undoStack = undoStack.slice(-50);
                }
                
                if (redoStack && redoStack.length > 100) {
                    console.log('Large redo stack detected, clearing old data...');
                    redoStack = redoStack.slice(-50);
                }
                
                // 未使用のDOM要素のクリア
                const unusedElements = document.querySelectorAll('.temp-element, .calculation-result');
                if (unusedElements.length > 50) {
                    console.log('Clearing unused DOM elements...');
                    unusedElements.forEach(el => el.remove());
                }
            }
        };

        // Form submission setup
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (typeof gantt === 'undefined') return;
                
                // Save state before modification
                saveUndoState("task_modify", gantt.serialize());
                
                const formData = new FormData(e.target);
                const startDate = new Date(formData.get('start_date'));
                const endDate = new Date(formData.get('end_date'));
                
                // Validate dates
                if (endDate <= startDate) {
                    alert('終了日は開始日より後の日付を選択してください。');
                    return;
                }
                
                // Calculate duration in days
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                const taskData = {
                    text: formData.get('text'),
                    description: formData.get('description'),
                    start_date: startDate,
                    end_date: endDate,
                    duration: duration,
                    priority: formData.get('priority'),
                    progress: parseInt(formData.get('progress')) / 100,
                    department: formData.get('department'),
                    parent: selectedTaskId || 0
                };
                
                if (editingTaskId) {
                    const task = gantt.getTask(editingTaskId);
                    Object.assign(task, taskData);
                    gantt.updateTask(editingTaskId);
                } else {
                    if (selectedTaskId) {
                        taskData.parent = selectedTaskId;
                    }
                    gantt.addTask(taskData);
                }
                
                closeTaskModal();
                updateStats();
            });
            
            // 定期的なメモリクリーンアップ（7分ごと）
            setInterval(() => {
                memoryManager.cleanup();
            }, 7 * 60 * 1000);
        });
        
        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            console.log('Cleaning up Gantt chart before page unload...');
            memoryManager.cleanup();
        });
    </script>
</body>
</html>