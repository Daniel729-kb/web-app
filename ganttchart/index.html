<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</title>
    <style>
        /* CSS extracted from gantt.js and enhanced */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Yu Gothic', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: #f5f7fa;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-title {
            background: transparent;
            border: 2px dashed transparent;
            color: white;
            font-size: 24px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 200px;
            cursor: text;
            transition: all 0.2s ease;
        }
        
        .project-title:hover, .project-title:focus {
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            outline: none;
        }
        
        .toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }
        
        .btn-success { background: #34a853; }
        .btn-success:hover { background: #2d8f47; }
        
        .btn-warning { background: #fbbc04; color: #333; }
        .btn-warning:hover { background: #f9ab00; }
        
        .btn-danger { background: #ea4335; }
        .btn-danger:hover { background: #d33b2c; }
        
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        
        .gantt-container {
            height: calc(100vh - 140px);
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #gantt_here {
            width: 100%;
            height: 100%;
        }
        
        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
            color: #666;
            font-size: 14px;
            margin-left: auto;
        }
        
        .status-badge {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            cursor: pointer;
        }
        
        /* Enhanced Gantt styles */
        .gantt_task_line.high_priority {
            background: #ff5722 !important;
            border: 2px solid #d84315 !important;
        }
        
        .gantt_task_line.medium_priority {
            background: #ff9800 !important;
            border: 2px solid #f57c00 !important;
        }
        
        .gantt_task_line.low_priority {
            background: #4caf50 !important;
            border: 2px solid #388e3c !important;
        }
        
        .gantt_task_line.completed {
            background: #9e9e9e !important;
            border: 2px solid #616161 !important;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Context menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .context-menu-item:hover {
            background: #f5f5f5;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .link-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Weekend styling for scale cells */
        .gantt_scale_cell.weekend {
            background-color: #f5f5f5 !important;
            color: #999 !important;
        }
        
        /* Weekend styling for task area */
        .gantt_task_cell.weekend {
            background-color: #f8f8f8 !important;
        }
        
        /* Weekend styling for grid rows */
        .gantt_row.weekend {
            background-color: #f8f8f8 !important;
        }
        
        /* Month header styling */
        .gantt_scale_line:first-child {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef) !important;
            border-bottom: 2px solid #dee2e6 !important;
            font-weight: 600 !important;
            color: #495057 !important;
        }
        
        /* Day header styling */
        .gantt_scale_line:last-child {
            background: #ffffff !important;
            border-bottom: 1px solid #e1e5e9 !important;
        }
        
        /* Month header weekend styling */
        .gantt_scale_line:first-child .gantt_scale_cell {
            color: #495057 !important;
        }
        
        /* Priority cell styling */
        .priority-cell, .department-cell {
            transition: all 0.2s ease !important;
            border: 1px solid transparent !important;
        }
        
        .priority-cell:hover, .department-cell:hover {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
            transform: scale(1.05);
        }
        
        .priority-cell:active, .department-cell:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="app-header">
        <input type="text" class="project-title" id="projectTitle" value="üìä ÂÄâÂ∫´ÈÅãÂñ∂„Éó„É≠„Ç∏„Çß„ÇØ„Éà" 
               placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ">
    </div>
    
    <div class="toolbar">
        <button class="btn" onclick="addTask()">
            ‚ûï „Çø„Çπ„ÇØËøΩÂä†
        </button>
        <button class="btn btn-success" onclick="addSubTask()">
            ‚ûï „Çµ„Éñ„Çø„Çπ„ÇØËøΩÂä†
        </button>
        <div class="file-input-wrapper">
            <label class="btn btn-info file-input-label">
                üìÇ „Ç§„É≥„Éù„Éº„Éà
                <input type="file" id="importFile" accept=".json,.xml" onchange="importData(event)">
            </label>
        </div>
        <button class="btn btn-success" onclick="exportData()">
            üíæ „Ç®„ÇØ„Çπ„Éù„Éº„Éà
        </button>
        <button class="btn" onclick="toggleView()">
            üìÖ Ë°®Á§∫ÂàáÊõø
        </button>
        
        <div class="status-info">
            <span>Á∑è„Çø„Çπ„ÇØÊï∞: <span class="status-badge" id="task-count">0</span></span>
            <span>ÈÄ≤ÊçóÁéá: <span class="status-badge" id="overall-progress">0%</span></span>
        </div>
    </div>
    
    <div class="gantt-container">
        <div id="gantt_here"></div>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†</h3>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskText">„Çø„Çπ„ÇØÂêç:</label>
                    <input type="text" id="taskText" name="text" required>
                </div>
                <div class="form-group">
                    <label for="taskDuration">ÊúüÈñì (Êó•Êï∞):</label>
                    <input type="number" id="taskDuration" name="duration" min="1" value="3">
                </div>
                <div class="form-group">
                    <label for="taskPriority">ÂÑ™ÂÖàÂ∫¶:</label>
                    <select id="taskPriority" name="priority">
                        <option value="low">üü¢ ‰Ωé</option>
                        <option value="medium" selected>üü° ‰∏≠</option>
                        <option value="high">üî¥ È´ò</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskProgress">ÈÄ≤Êçó (%):</label>
                    <input type="number" id="taskProgress" name="progress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="taskDepartment">ÊãÖÂΩìÁÆáÊâÄ:</label>
                    <input type="text" id="taskDepartment" name="department" placeholder="ÊãÖÂΩìÁÆáÊâÄ„ÇíÂÖ•Âäõ">
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">„Çø„Çπ„ÇØ‰øùÂ≠ò</button>
                    <button type="button" class="btn" onclick="closeTaskModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="contextAddSubTask()">„Çµ„Éñ„Çø„Çπ„ÇØËøΩÂä†</div>
        <div class="context-menu-item" onclick="contextEditTask()">„Çø„Çπ„ÇØÁ∑®ÈõÜ</div>
        <div class="context-menu-item" onclick="contextLinkTask()">„Çø„Çπ„ÇØ„É™„É≥„ÇØ‰ΩúÊàê</div>
        <div class="context-menu-item" onclick="contextDeleteTask()">„Çø„Çπ„ÇØÂâäÈô§</div>
    </div>

    <!-- Local DHTMLX Gantt JS with CDN fallback -->
    <script>
        // First try to load local gantt.js, fallback to CDN if it fails
        function loadGanttScript() {
            return new Promise((resolve, reject) => {
                const localScript = document.createElement('script');
                localScript.src = 'gantt.js';
                localScript.onload = () => {
                    if (typeof gantt !== 'undefined') {
                        console.log('„É≠„Éº„Ç´„É´„ÅÆgantt.js„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                        resolve();
                    } else {
                        console.warn('„É≠„Éº„Ç´„É´gantt.js„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÅCDN„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åô...');
                        loadFromCDN().then(resolve).catch(reject);
                    }
                };
                localScript.onerror = () => {
                    console.warn('„É≠„Éº„Ç´„É´gantt.js„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÅCDN„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åô...');
                    loadFromCDN().then(resolve).catch(reject);
                };
                document.head.appendChild(localScript);
            });
        }

        function loadFromCDN() {
            return new Promise((resolve, reject) => {
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.7/codebase/dhtmlxgantt.js';
                cdnScript.onload = () => {
                    if (typeof gantt !== 'undefined') {
                        console.log('CDN„Åã„Çâgantt.js„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                        resolve();
                    } else {
                        reject(new Error('CDN„Åã„Çâ„ÅÆganttË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
                    }
                };
                cdnScript.onerror = () => reject(new Error('CDN„Åã„Çâ„ÅÆganttË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
                document.head.appendChild(cdnScript);
            });
        }

        function loadGanttCSS() {
            const localCSS = document.createElement('link');
            localCSS.rel = 'stylesheet';
            localCSS.href = 'dhtmlxgantt.css';
            localCSS.onerror = () => {
                console.warn('„É≠„Éº„Ç´„É´CSS„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„ÄÅCDN„Çí‰ΩøÁî®„Åó„Åæ„Åô...');
                const cdnCSS = document.createElement('link');
                cdnCSS.rel = 'stylesheet';
                cdnCSS.href = 'https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.7/codebase/dhtmlxgantt.css';
                document.head.appendChild(cdnCSS);
            };
            document.head.appendChild(localCSS);
        }

        loadGanttCSS();

        // Global variables
        let selectedTaskId = null;
        let contextTaskId = null;
        let editingTaskId = null;
        let viewMode = 'day';
        let linkSourceTask = null;

        loadGanttScript().then(() => {
            initializeGantt();
        }).catch(error => {
            console.error('„Ç¨„É≥„Éà„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
            document.getElementById('gantt_here').innerHTML = 
                '<div style="padding: 20px; text-align: center; color: red;">' +
                '<h3>„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº</h3>' +
                '<p>„Ç¨„É≥„Éà„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇgantt.js„ÅåÂêå„Åò„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>' +
                '<p>„Ç®„É©„Éº: ' + error.message + '</p>' +
                '</div>';
        });

        function initializeGantt() {
            // Japanese localization
            gantt.i18n.setLocale({
                date: {
                    month_full: ["1Êúà", "2Êúà", "3Êúà", "4Êúà", "5Êúà", "6Êúà", "7Êúà", "8Êúà", "9Êúà", "10Êúà", "11Êúà", "12Êúà"],
                    month_short: ["1Êúà", "2Êúà", "3Êúà", "4Êúà", "5Êúà", "6Êúà", "7Êúà", "8Êúà", "9Êúà", "10Êúà", "11Êúà", "12Êúà"],
                    day_full: ["Êó•ÊõúÊó•", "ÊúàÊõúÊó•", "ÁÅ´ÊõúÊó•", "Ê∞¥ÊõúÊó•", "Êú®ÊõúÊó•", "ÈáëÊõúÊó•", "ÂúüÊõúÊó•"],
                    day_short: ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"]
                },
                labels: {
                    new_task: "Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ",
                    icon_save: "‰øùÂ≠ò",
                    icon_cancel: "„Ç≠„É£„É≥„Çª„É´",
                    icon_details: "Ë©≥Á¥∞",
                    icon_edit: "Á∑®ÈõÜ",
                    icon_delete: "ÂâäÈô§",
                    confirm_closing: "",
                    confirm_deleting: "„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
                    section_description: "Ë™¨Êòé",
                    section_time: "ÊúüÈñì",
                    section_type: "„Çø„Ç§„Éó"
                }
            });
        
            // Enhanced Gantt Chart Configuration
            gantt.config.date_format = "%Y-%m-%d %H:%i";
            gantt.config.scale_height = 54;
            gantt.config.row_height = 30;
            
            // Configure scales for day view with month header
            gantt.config.scales = [
                {unit: "month", step: 1, format: "%YÂπ¥%mÊúà"},
                {unit: "day", step: 1, format: "%dÊó•(%D)"}
            ];
            
            // Custom date scale template with Japanese day names for the day scale
            gantt.templates.date_scale = function(date) {
                const dayNames = ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"];
                const day = date.getDate();
                const dayOfWeek = dayNames[date.getDay()];
                return day + "Êó•(" + dayOfWeek + ")";
            };
            
            // Weekend detection for scale cells
            gantt.templates.scale_cell_class = function(date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    return "weekend";
                }
                return "";
            };
            
            // Weekend detection for task area
            gantt.templates.timeline_cell_class = function(task, date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    return "weekend";
                }
                return "";
            };
            
            // Enable advanced features
            gantt.config.drag_links = true;
            gantt.config.drag_progress = true;
            gantt.config.drag_resize = true;
            gantt.config.order_branch = true;
            gantt.config.order_branch_free = true;
            
            // Enable plugins if available
            if (gantt.plugins) {
                gantt.plugins({
                    click_drag: true,
                    tooltip: true,
                    undo: true
                });
            }
            
            // Grid configuration
            gantt.config.columns = [
                {name: "text", label: "„Çø„Çπ„ÇØÂêç", width: 180, tree: true},
                {name: "start_date", label: "ÈñãÂßãÊó•", width: 80},
                {name: "duration", label: "ÊúüÈñì", width: 50, align: "center"},
                {name: "progress", label: "ÈÄ≤Êçó", width: 70, template: function(obj) {
                    return Math.round(obj.progress * 100) + "%";
                }},
                {name: "priority", label: "ÂÑ™ÂÖàÂ∫¶", width: 80, template: function(obj) {
                    const priorities = {high: "üî¥ È´ò", medium: "üü° ‰∏≠", low: "üü¢ ‰Ωé"};
                    const priorityText = priorities[obj.priority] || "üîµ ÈÄöÂ∏∏";
                    return `<span class="priority-cell" data-task-id="${obj.id}" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa;">${priorityText}</span>`;
                }},
                {name: "department", label: "ÊãÖÂΩìÁÆáÊâÄ", width: 100, template: function(obj) {
                    const departmentText = obj.department || "Êú™Ë®≠ÂÆö";
                    return `<span class="department-cell" data-task-id="${obj.id}" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa;">${departmentText}</span>`;
                }},
                {name: "add", label: "", width: 44}
            ];
            
            // Custom templates
            gantt.templates.task_class = function(start, end, task) {
                let classes = [];
                if (task.priority) classes.push(task.priority + "_priority");
                if (task.progress >= 1) classes.push("completed");
                return classes.join(" ");
            };
            
            gantt.templates.task_text = function(start, end, task) {
                return task.text + " (" + Math.round(task.progress * 100) + "%)";
            };
            
            gantt.templates.tooltip_text = function(start, end, task) {
                const priority = task.priority ? {high: "È´ò", medium: "‰∏≠", low: "‰Ωé"}[task.priority] : "ÈÄöÂ∏∏";
                const department = task.department || "Êú™Ë®≠ÂÆö";
                return `<b>„Çø„Çπ„ÇØ:</b> ${task.text}<br/>
                        <b>ÈñãÂßãÊó•:</b> ${gantt.templates.tooltip_date_format(start)}<br/>
                        <b>ÁµÇ‰∫ÜÊó•:</b> ${gantt.templates.tooltip_date_format(end)}<br/>
                        <b>ÈÄ≤Êçó:</b> ${Math.round(task.progress * 100)}%<br/>
                        <b>ÂÑ™ÂÖàÂ∫¶:</b> ${priority}<br/>
                        <b>ÊãÖÂΩìÁÆáÊâÄ:</b> ${department}<br/>
                        <b>ÊúüÈñì:</b> ${task.duration} Êó•`;
            };
            
            // Initialize the Gantt chart
            gantt.init("gantt_here");
            
            // Japanese warehouse operation sample data
            gantt.parse({
                data: [
                    {id: 1, text: "ÂÄâÂ∫´ÈÅãÂñ∂„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ•", start_date: null, duration: null, parent: 0, progress: 0, open: true, priority: "high", department: "Êú¨Á§æ"},
                    
                    // Phase 1: Planning
                    {id: 2, text: "Ë®àÁîª„Éï„Çß„Éº„Ç∫", start_date: null, duration: null, parent: 1, progress: 0.3, open: true, priority: "high", department: "‰ºÅÁîªÈÉ®"},
                    {id: 3, text: "Ë¶Å‰ª∂ÂÆöÁæ©", start_date: "2025-08-01 00:00", duration: 5, parent: 2, progress: 0.8, priority: "high", department: "‰ºÅÁîªÈÉ®"},
                    {id: 4, text: "ÁèæÁä∂ÂàÜÊûê", start_date: "2025-08-06 00:00", duration: 3, parent: 2, progress: 0.5, priority: "medium", department: "Ê•≠ÂãôÈÉ®"},
                    {id: 5, text: "„Ç∑„Çπ„ÉÜ„É†Ë®≠Ë®à", start_date: "2025-08-09 00:00", duration: 7, parent: 2, progress: 0.2, priority: "high", department: "ITÈÉ®"},
                    
                    // Phase 2: Infrastructure
                    {id: 6, text: "„Ç§„É≥„Éï„É©Êï¥ÂÇô", start_date: null, duration: null, parent: 1, progress: 0.1, open: true, priority: "medium", department: "ITÈÉ®"},
                    {id: 7, text: "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊßãÁØâ", start_date: "2025-08-16 00:00", duration: 5, parent: 6, progress: 0.3, priority: "medium", department: "ITÈÉ®"},
                    {id: 8, text: "„Çµ„Éº„Éê„ÉºË®≠ÁΩÆ", start_date: "2025-08-21 00:00", duration: 3, parent: 6, progress: 0, priority: "medium", department: "Ë®≠ÂÇôÈÉ®"},
                    {id: 9, text: "„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö", start_date: "2025-08-24 00:00", duration: 2, parent: 6, progress: 0, priority: "high", department: "ITÈÉ®"},
                    
                    // Phase 3: Software Development
                    {id: 10, text: "„ÇΩ„Éï„Éà„Ç¶„Çß„Ç¢ÈñãÁô∫", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "ÈñãÁô∫ÈÉ®"},
                    {id: 11, text: "Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†", start_date: "2025-08-26 00:00", duration: 10, parent: 10, progress: 0, priority: "high", department: "ÈñãÁô∫ÈÉ®"},
                    {id: 12, text: "ÈÖçÈÄÅÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†", start_date: "2025-09-05 00:00", duration: 8, parent: 10, progress: 0, priority: "medium", department: "Áâ©ÊµÅÈÉ®"},
                    {id: 13, text: "„É¨„Éù„Éº„ÉàÊ©üËÉΩ", start_date: "2025-09-13 00:00", duration: 5, parent: 10, progress: 0, priority: "low", department: "ÁµåÂñ∂‰ºÅÁîª"},
                    
                    // Phase 4: Testing
                    {id: 14, text: "„ÉÜ„Çπ„Éà„ÉªÊ§úË®º", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "ÂìÅË≥™‰øùË®º"},
                    {id: 15, text: "Âçò‰Ωì„ÉÜ„Çπ„Éà", start_date: "2025-09-18 00:00", duration: 5, parent: 14, progress: 0, priority: "medium", department: "ÂìÅË≥™‰øùË®º"},
                    {id: 16, text: "Áµ±Âêà„ÉÜ„Çπ„Éà", start_date: "2025-09-23 00:00", duration: 7, parent: 14, progress: 0, priority: "high", department: "ÂìÅË≥™‰øùË®º"},
                    {id: 17, text: "ÈÅãÁî®„ÉÜ„Çπ„Éà", start_date: "2025-09-30 00:00", duration: 5, parent: 14, progress: 0, priority: "high", department: "ÈÅãÁî®ÈÉ®"},
                    
                    // Phase 5: Deployment
                    {id: 18, text: "Êú¨Á®ºÂÉç", start_date: null, duration: null, parent: 1, progress: 0, open: true, priority: "high", department: "ÈÅãÁî®ÈÉ®"},
                    {id: 19, text: "„Éá„Éº„ÇøÁßªË°å", start_date: "2025-10-05 00:00", duration: 3, parent: 18, progress: 0, priority: "high", department: "ITÈÉ®"},
                    {id: 20, text: "„Çπ„Çø„ÉÉ„ÉïÁ†î‰øÆ", start_date: "2025-10-08 00:00", duration: 5, parent: 18, progress: 0, priority: "medium", department: "‰∫∫‰∫ãÈÉ®"},
                    {id: 21, text: "Êú¨Á®ºÂÉçÈñãÂßã", start_date: "2025-10-13 00:00", duration: 1, parent: 18, progress: 0, priority: "high", department: "ÂÖ®Á§æ"}
                ],
                links: [
                    {id: 1, source: 3, target: 4, type: "0"},
                    {id: 2, source: 4, target: 5, type: "0"},
                    {id: 3, source: 5, target: 7, type: "0"},
                    {id: 4, source: 7, target: 8, type: "0"},
                    {id: 5, source: 8, target: 9, type: "0"},
                    {id: 6, source: 9, target: 11, type: "0"},
                    {id: 7, source: 11, target: 12, type: "0"},
                    {id: 8, source: 12, target: 13, type: "0"},
                    {id: 9, source: 13, target: 15, type: "0"},
                    {id: 10, source: 15, target: 16, type: "0"},
                    {id: 11, source: 16, target: 17, type: "0"},
                    {id: 12, source: 17, target: 19, type: "0"},
                    {id: 13, source: 19, target: 20, type: "0"},
                    {id: 14, source: 20, target: 21, type: "0"}
                ]
            });
            
            // Enhanced linked task movement
            gantt.attachEvent("onAfterTaskDrag", function(id, mode, e) {
                if (mode === "resize" || mode === "move") {
                    updateLinkedTasks(id);
                }
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onAfterTaskUpdate", function(id, task) {
                updateLinkedTasks(id);
                updateStats();
                return true;
            });
            
            gantt.attachEvent("onAfterTaskAdd", updateStats);
            gantt.attachEvent("onAfterTaskDelete", updateStats);
            
            // Context menu functionality
            gantt.attachEvent("onTaskRightClick", function(id, e) {
                e.preventDefault();
                contextTaskId = id;
                showContextMenu(e.clientX, e.clientY);
                return false;
            });
            
            gantt.attachEvent("onTaskClick", function(id, e) {
                selectedTaskId = id;
                return true;
            });
            
            // Priority column click functionality
            gantt.attachEvent("onGridHeaderClick", function(name, e) {
                return true;
            });
            
            // Add click event for priority and department cells
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('priority-cell')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    cyclePriority(taskId);
                } else if (e.target.classList.contains('department-cell')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    editDepartment(taskId);
                }
            });
            
            // Initialize stats
            updateStats();
            autoLoad();
            
            console.log('„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
        }

        // Priority cycling function
        function cyclePriority(taskId) {
            if (!gantt.isTaskExists(taskId)) return;
            
            const task = gantt.getTask(taskId);
            const priorities = ['low', 'medium', 'high'];
            const currentIndex = priorities.indexOf(task.priority || 'medium');
            const nextIndex = (currentIndex + 1) % priorities.length;
            
            task.priority = priorities[nextIndex];
            gantt.updateTask(taskId);
            updateStats();
        }

        // Department editing function
        function editDepartment(taskId) {
            if (!gantt.isTaskExists(taskId)) return;
            
            const task = gantt.getTask(taskId);
            const currentDepartment = task.department || 'Êú™Ë®≠ÂÆö';
            
            let newDepartment = prompt(`ÊãÖÂΩìÁÆáÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`, currentDepartment);
            
            if (newDepartment !== null && newDepartment.trim() !== '') {
                task.department = newDepartment.trim();
                gantt.updateTask(taskId);
                updateStats();
            }
        }

        // Enhanced linked task movement functionality
        function updateLinkedTasks(movedTaskId) {
            if (!gantt.isTaskExists(movedTaskId)) return;
            
            const movedTask = gantt.getTask(movedTaskId);
            const links = gantt.getLinks();
            
            // Update all dependent tasks
            links.forEach(link => {
                if (link.source == movedTaskId && link.type == "0") { // finish-to-start
                    updateDependentTask(link.target, movedTask.end_date);
                } else if (link.source == movedTaskId && link.type == "1") { // start-to-start
                    updateDependentTask(link.target, movedTask.start_date, true);
                }
            });
        }
        
        function updateDependentTask(taskId, predecessorDate, startToStart = false) {
            if (!gantt.isTaskExists(taskId)) return;
            
            const task = gantt.getTask(taskId);
            let newStartDate;
            
            if (startToStart) {
                newStartDate = new Date(predecessorDate);
            } else {
                newStartDate = gantt.date.add(predecessorDate, 1, "day");
            }
            
            // Only update if the new date is different
            if (task.start_date.getTime() !== newStartDate.getTime()) {
                task.start_date = newStartDate;
                task.end_date = gantt.calculateEndDate(newStartDate, task.duration);
                gantt.updateTask(taskId);
                
                // Recursively update tasks that depend on this one
                updateLinkedTasks(taskId);
            }
        }

        // Hide context menu on click elsewhere
        document.addEventListener('click', function() {
            hideContextMenu();
        });
        
        // Auto-save every 30 seconds
        setInterval(autoSave, 30000);
        
        // Project title editing
        document.getElementById('projectTitle').addEventListener('blur', function() {
            document.title = this.value;
        });
        
        document.getElementById('projectTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur();
            }
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('taskModal');
            if (e.target === modal) {
                closeTaskModal();
            }
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'n':
                        e.preventDefault();
                        addTask();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (typeof gantt !== 'undefined' && gantt.undo) {
                            gantt.undo.undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        if (typeof gantt !== 'undefined' && gantt.undo) {
                            gantt.undo.redo();
                        }
                        break;
                }
            }
        });

        // Global functions accessible from HTML
        
        function showTaskModal(title = "Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†", task = null) {
            document.getElementById('modalTitle').textContent = title;
            
            if (task) {
                document.getElementById('taskText').value = task.text;
                document.getElementById('taskDuration').value = task.duration || 3;
                document.getElementById('taskPriority').value = task.priority || 'medium';
                document.getElementById('taskProgress').value = Math.round((task.progress || 0) * 100);
                document.getElementById('taskDepartment').value = task.department || '';
                editingTaskId = task.id;
            } else {
                document.getElementById('taskForm').reset();
                editingTaskId = null;
            }
            
            document.getElementById('taskModal').style.display = 'block';
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }
        
        function addTask() {
            showTaskModal();
        }
        
        function addSubTask() {
            if (selectedTaskId) {
                showTaskModal("„Çµ„Éñ„Çø„Çπ„ÇØ„ÇíËøΩÂä†");
            } else {
                alert("„Åæ„ÅöË¶™„Çø„Çπ„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }
        
        function contextAddSubTask() {
            selectedTaskId = contextTaskId;
            addSubTask();
            hideContextMenu();
        }
        
        function contextEditTask() {
            if (contextTaskId && typeof gantt !== 'undefined') {
                const task = gantt.getTask(contextTaskId);
                showTaskModal("„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ", task);
            }
            hideContextMenu();
        }
        
        function contextLinkTask() {
            if (!linkSourceTask) {
                linkSourceTask = contextTaskId;
                alert(`„Çø„Çπ„ÇØ "${gantt.getTask(contextTaskId).text}" „ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇÊ¨°„Å´„É™„É≥„ÇØÂÖà„ÅÆ„Çø„Çπ„ÇØ„ÇíÂè≥„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            } else {
                createLinkBetweenTasks(linkSourceTask, contextTaskId);
                linkSourceTask = null;
            }
            hideContextMenu();
        }
        
        function createTaskLink() {
            if (selectedTaskId) {
                if (!linkSourceTask) {
                    linkSourceTask = selectedTaskId;
                    alert(`„Çø„Çπ„ÇØ "${gantt.getTask(selectedTaskId).text}" „ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇÊ¨°„Å´„É™„É≥„ÇØÂÖà„ÅÆ„Çø„Çπ„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                } else {
                    createLinkBetweenTasks(linkSourceTask, selectedTaskId);
                    linkSourceTask = null;
                }
            } else {
                alert("„Åæ„Åö„É™„É≥„ÇØÂÖÉ„ÅÆ„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }
        
        function createLinkBetweenTasks(sourceId, targetId) {
            if (sourceId === targetId) {
                alert("Âêå„Åò„Çø„Çπ„ÇØ„Çí„É™„É≥„ÇØ„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            
            // Check if link already exists
            const existingLinks = gantt.getLinks();
            const linkExists = existingLinks.some(link => 
                link.source == sourceId && link.target == targetId
            );
            
            if (linkExists) {
                alert("„Åì„ÅÆ„É™„É≥„ÇØ„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ");
                return;
            }
            
            const sourceTask = gantt.getTask(sourceId);
            const targetTask = gantt.getTask(targetId);
            
            // Create the link
            gantt.addLink({
                id: gantt.uid(),
                source: sourceId,
                target: targetId,
                type: "0" // finish-to-start
            });
            
            // Update the target task to start after source ends
            updateDependentTask(targetId, sourceTask.end_date);
            
            alert(`"${sourceTask.text}" „Åã„Çâ "${targetTask.text}" „Å∏„ÅÆ„É™„É≥„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ`);
        }
        
        function contextDeleteTask() {
            if (contextTaskId && confirm("„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü") && typeof gantt !== 'undefined') {
                gantt.deleteTask(contextTaskId);
                updateStats();
            }
            hideContextMenu();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file || typeof gantt === 'undefined') return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let data;
                    
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(content);
                    } else if (file.name.endsWith('.xml')) {
                        data = gantt.xml.parse(content);
                    } else {
                        throw new Error('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                    }
                    
                    gantt.clearAll();
                    gantt.parse(data);
                    updateStats();
                    alert('„Éá„Éº„Çø„ÅåÊ≠£Â∏∏„Å´„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                } catch (error) {
                    alert('„Éï„Ç°„Ç§„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function exportData() {
            if (typeof gantt === 'undefined') return;
            const projectName = document.getElementById('projectTitle').value || 'gantt_project';
            const data = gantt.serialize();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = projectName.replace(/[^\w\s-]/g, '') + '_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function toggleView() {
            if (typeof gantt === 'undefined') return;
            const modes = ['day', 'week', 'month'];
            const currentIndex = modes.indexOf(viewMode);
            viewMode = modes[(currentIndex + 1) % modes.length];
            
            switch(viewMode) {
                case 'week':
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: "%YÂπ¥%mÊúà"},
                        {unit: "week", step: 1, format: "%WÈÄ±"}
                    ];
                    // Reset template for week view
                    gantt.templates.date_scale = null;
                    break;
                case 'month':
                    gantt.config.scales = [
                        {unit: "year", step: 1, format: "%YÂπ¥"},
                        {unit: "month", step: 1, format: "%mÊúà"}
                    ];
                    // Reset template for month view
                    gantt.templates.date_scale = null;
                    break;
                default: // day view
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: "%YÂπ¥%mÊúà"},
                        {unit: "day", step: 1, format: "%dÊó•(%D)"}
                    ];
                    // Custom template for day view with Japanese day names
                    gantt.templates.date_scale = function(date) {
                        const dayNames = ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"];
                        const day = date.getDate();
                        const dayOfWeek = dayNames[date.getDay()];
                        return day + "Êó•(" + dayOfWeek + ")";
                    };
            }
            gantt.render();
        }
        
        function updateStats() {
            if (typeof gantt === 'undefined') return;
            let totalTasks = 0;
            let totalProgress = 0;
            
            gantt.eachTask(function(task) {
                if (!gantt.hasChild(task.id)) {
                    totalTasks++;
                    totalProgress += task.progress || 0;
                }
            });
            
            document.getElementById('task-count').textContent = totalTasks;
            document.getElementById('overall-progress').textContent = 
                totalTasks > 0 ? Math.round((totalProgress / totalTasks) * 100) + '%' : '0%';
        }
        
        function autoSave() {
            if (typeof gantt === 'undefined') return;
            try {
                const data = gantt.serialize();
                const projectName = document.getElementById('projectTitle').value;
                localStorage.setItem('gantt_chart_data', JSON.stringify(data));
                localStorage.setItem('gantt_project_name', projectName);
            } catch (e) {
                console.warn('Ëá™Âãï‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }
        
        function autoLoad() {
            if (typeof gantt === 'undefined') return;
            const saved = localStorage.getItem('gantt_chart_data');
            const savedName = localStorage.getItem('gantt_project_name');
            
            if (savedName) {
                document.getElementById('projectTitle').value = savedName;
                document.title = savedName;
            }
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gantt.clearAll();
                    gantt.parse(data);
                    updateStats();
                } catch (e) {
                    console.warn('‰øùÂ≠ò„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }
        }
        
        // Form submission setup
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (typeof gantt === 'undefined') return;
                
                const formData = new FormData(e.target);
                const taskData = {
                    text: formData.get('text'),
                    duration: parseInt(formData.get('duration')),
                    priority: formData.get('priority'),
                    progress: parseInt(formData.get('progress')) / 100,
                    department: formData.get('department'),
                    parent: selectedTaskId || 0
                };
                
                if (editingTaskId) {
                    const task = gantt.getTask(editingTaskId);
                    Object.assign(task, taskData);
                    gantt.updateTask(editingTaskId);
                } else {
                    taskData.start_date = new Date();
                    if (selectedTaskId) {
                        taskData.parent = selectedTaskId;
                    }
                    gantt.addTask(taskData);
                }
                
                closeTaskModal();
                updateStats();
            });
        });
    </script>
</body>
</html>